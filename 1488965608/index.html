<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#922"><meta name="generator" content="Hexo 6.3.0">
<link rel="preconnect" href="https://fonts.cat.net" crossorigin>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="../images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png">
  <link rel="mask-icon" href="../images/favicon-32x32.png" color="#922">

<link rel="stylesheet" href="../css/main.css">

<link rel="stylesheet" href="https://fonts.cat.net/css?family=Monda:300,300italic,400,400italic,700,700italic%7CArvo:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/pace-js@1.2.4/themes/red/pace-theme-minimal.css">
  <script src="https://unpkg.com/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.x2b.net","root":"/","images":"../images","scheme":"Gemini","darkmode":false,"version":"8.15.1","exturl":false,"sidebar":{"position":"left","width":300,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#922","save":"manual"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":{"gitalk":{"order":-1}},"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"../search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":true,"preload":true}}</script><script src="../js/config.js"></script>

    <meta name="description" content="快速入门 通过 Minikube 快速体验 Kubernetes 系统。">
<meta property="og:type" content="article">
<meta property="og:title" content="K8s 系统部署">
<meta property="og:url" content="https://blog.x2b.net/1488965608/index.html">
<meta property="og:site_name" content="X to Bytes">
<meta property="og:description" content="快速入门 通过 Minikube 快速体验 Kubernetes 系统。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.x2b.net/images/%E9%9B%86%E7%BE%A4%E6%9E%84%E6%9E%B6%E5%9B%BE.png">
<meta property="article:published_time" content="2022-03-20T01:01:17.000Z">
<meta property="article:modified_time" content="2023-05-18T15:50:08.213Z">
<meta property="article:author" content="assassing">
<meta property="article:tag" content="docker k8s linux python">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.x2b.net/images/%E9%9B%86%E7%BE%A4%E6%9E%84%E6%9E%B6%E5%9B%BE.png">


<link rel="canonical" href="https://blog.x2b.net/1488965608/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.x2b.net/1488965608/","path":"1488965608/","title":"K8s 系统部署"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>K8s 系统部署 | X to Bytes</title>
  

  <script src="../js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?71ae334aaa654e1cd3ba0c9eb55f88a3"></script>







  <noscript>
    <link rel="stylesheet" href="../css/noscript.css">
  </noscript>
<link rel="alternate" href="atom.xml" title="X to Bytes" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">X to Bytes</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="../about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-categories"><a href="../categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">14</span></a></li><li class="menu-item menu-item-archives"><a href="../archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">89</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="nav-number">1.</span> <span class="nav-text"> 快速入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-%E5%9F%BA%E7%A1%80"><span class="nav-number">1.1.</span> <span class="nav-text"> Docker 基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-docker"><span class="nav-number">1.1.1.</span> <span class="nav-text"> 安装 Docker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-docker"><span class="nav-number">1.1.2.</span> <span class="nav-text"> 配置 Docker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8-docker"><span class="nav-number">1.1.3.</span> <span class="nav-text"> 启动 Docker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-nodejs-%E5%BA%94%E7%94%A8"><span class="nav-number">1.1.4.</span> <span class="nav-text"> 创建 Node.js 应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-dockerfile"><span class="nav-number">1.1.5.</span> <span class="nav-text"> 创建 Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F"><span class="nav-number">1.1.6.</span> <span class="nav-text"> 构建容器镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F"><span class="nav-number">1.1.7.</span> <span class="nav-text"> 运行容器镜像</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA-minikube"><span class="nav-number">1.2.</span> <span class="nav-text"> 搭建 Minikube</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">1.2.1.</span> <span class="nav-text"> 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8"><span class="nav-number">1.2.2.</span> <span class="nav-text"> 启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B"><span class="nav-number">1.2.3.</span> <span class="nav-text"> 查看</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-pod"><span class="nav-number">1.2.4.</span> <span class="nav-text"> 建立 pod</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9A%B4%E9%9C%B2%E7%AB%AF%E5%8F%A3"><span class="nav-number">1.2.5.</span> <span class="nav-text"> 暴露端口</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE"><span class="nav-number">2.</span> <span class="nav-text"> 系统配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="nav-number">2.1.</span> <span class="nav-text"> 网络配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B4%A6%E6%88%B7%E9%85%8D%E7%BD%AE"><span class="nav-number">2.2.</span> <span class="nav-text"> 账户配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93"><span class="nav-number">2.3.</span> <span class="nav-text"> 镜像仓库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E5%8D%87%E7%BA%A7"><span class="nav-number">2.4.</span> <span class="nav-text"> 内核升级</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%86%85%E6%A0%B8"><span class="nav-number">2.4.1.</span> <span class="nav-text"> 查看内核</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E5%86%85%E6%A0%B8"><span class="nav-number">2.4.2.</span> <span class="nav-text"> 安装内核</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E5%BC%95%E5%AF%BC"><span class="nav-number">2.4.3.</span> <span class="nav-text"> 修改引导</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%8D%E7%BA%A7%E5%86%85%E6%A0%B8"><span class="nav-number">2.4.4.</span> <span class="nav-text"> 降级内核</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E5%86%85%E6%A0%B8"><span class="nav-number">2.4.5.</span> <span class="nav-text"> 删除内核</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E8%B0%83%E6%95%B4"><span class="nav-number">2.5.</span> <span class="nav-text"> 内核调整</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A6%81%E7%94%A8%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98"><span class="nav-number">2.5.1.</span> <span class="nav-text"> 禁用虚拟内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="nav-number">2.5.2.</span> <span class="nav-text"> 开启端口转发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%BB%E9%99%A4%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E9%99%90%E5%88%B6"><span class="nav-number">2.5.3.</span> <span class="nav-text"> 去除文件系统限制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99"><span class="nav-number">2.6.</span> <span class="nav-text"> 关闭防火墙</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AA%E6%80%A7%E5%8C%96%E8%AE%BE%E7%BD%AE"><span class="nav-number">2.7.</span> <span class="nav-text"> 个性化设置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E7%B3%BB%E7%BB%9F%E8%AF%AD%E8%A8%80"><span class="nav-number">2.7.1.</span> <span class="nav-text"> 修改系统语言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%BB%E6%9C%BA%E5%90%8D"><span class="nav-number">2.7.2.</span> <span class="nav-text"> 修改主机名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5"><span class="nav-number">2.7.3.</span> <span class="nav-text"> 时间同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E5%B7%A5%E5%85%B7"><span class="nav-number">2.7.4.</span> <span class="nav-text"> 安装工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%90%E5%88%B6%E6%97%A5%E5%BF%97%E5%A4%A7%E5%B0%8F"><span class="nav-number">2.7.5.</span> <span class="nav-text"> 限制日志大小</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E5%8F%98%E9%87%8F"><span class="nav-number">2.7.6.</span> <span class="nav-text"> 设置变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86"><span class="nav-number">2.8.</span> <span class="nav-text"> 磁盘管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">2.8.1.</span> <span class="nav-text"> 初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-pv"><span class="nav-number">2.8.2.</span> <span class="nav-text"> 创建 PV</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-vg"><span class="nav-number">2.8.3.</span> <span class="nav-text"> 创建 VG</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-lv"><span class="nav-number">2.8.4.</span> <span class="nav-text"> 创建 LV</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96"><span class="nav-number">2.8.5.</span> <span class="nav-text"> 格式化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E7%A3%81%E7%9B%98"><span class="nav-number">2.8.6.</span> <span class="nav-text"> 删除磁盘</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E5%90%AF"><span class="nav-number">2.9.</span> <span class="nav-text"> 重启</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-number">3.</span> <span class="nav-text"> 高可用集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#kubeadm"><span class="nav-number">3.1.</span> <span class="nav-text"> Kubeadm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kubeadm-init"><span class="nav-number">3.1.1.</span> <span class="nav-text"> kubeadm init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubeadm-join"><span class="nav-number">3.1.2.</span> <span class="nav-text"> kubeadm join</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E7%BB%84%E4%BB%B6"><span class="nav-number">3.2.</span> <span class="nav-text"> 安装组件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="nav-number">3.3.</span> <span class="nav-text"> 主节点配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-haproxy"><span class="nav-number">3.3.1.</span> <span class="nav-text"> 部署 HAproxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-keepalived"><span class="nav-number">3.3.2.</span> <span class="nav-text"> 部署 keepalived</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="nav-number">3.3.3.</span> <span class="nav-text"> 测试故障转移</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E9%9B%86%E7%BE%A4"><span class="nav-number">3.4.</span> <span class="nav-text"> 建立集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="nav-number">3.4.1.</span> <span class="nav-text"> 初始化主节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-kubectl"><span class="nav-number">3.4.2.</span> <span class="nav-text"> 配置 Kubectl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E7%BD%91%E7%BB%9C"><span class="nav-number">3.4.3.</span> <span class="nav-text"> 部署网络</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%8C%E6%88%90%E9%83%A8%E7%BD%B2"><span class="nav-number">3.4.4.</span> <span class="nav-text"> 完成部署</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="nav-number">3.5.</span> <span class="nav-text"> 加入集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%8F%82%E6%95%B0"><span class="nav-number">3.5.1.</span> <span class="nav-text"> 获取参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E5%85%A5%E4%BB%8E%E8%8A%82%E7%82%B9"><span class="nav-number">3.5.2.</span> <span class="nav-text"> 加入从节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E5%85%A5%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="nav-number">3.5.3.</span> <span class="nav-text"> 加入主节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AD%89%E5%BE%85%E5%AE%8C%E6%88%90"><span class="nav-number">3.5.4.</span> <span class="nav-text"> 等待完成</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9"><span class="nav-number">3.6.</span> <span class="nav-text"> 移除节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="nav-number">3.7.</span> <span class="nav-text"> 节点配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE-2"><span class="nav-number">3.7.1.</span> <span class="nav-text"> 主节点配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="nav-number">3.7.2.</span> <span class="nav-text"> 从节点配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="nav-number">3.8.</span> <span class="nav-text"> 集群配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="nav-number">3.8.1.</span> <span class="nav-text"> 建立命名空间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%91%E5%AE%9A%E6%9D%83%E9%99%90"><span class="nav-number">3.8.2.</span> <span class="nav-text"> 绑定权限</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91%E9%83%A8%E7%BD%B2"><span class="nav-number">3.9.</span> <span class="nav-text"> 阿里云部署</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%8D%87%E7%BA%A7"><span class="nav-number">4.</span> <span class="nav-text"> 集群升级</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86"><span class="nav-number">5.</span> <span class="nav-text"> 故障处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B2%A1%E6%9C%89-pod-network-cidr"><span class="nav-number">5.1.</span> <span class="nav-text"> 没有 pod-network-cidr</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B2%A1%E6%9C%89-controlplaneendpoint"><span class="nav-number">5.2.</span> <span class="nav-text"> 没有 controlPlaneEndpoint</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#token-%E8%BF%87%E6%9C%9F"><span class="nav-number">5.3.</span> <span class="nav-text"> Token 过期</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%81%E4%B9%A6%E8%BF%87%E6%9C%9F"><span class="nav-number">5.4.</span> <span class="nav-text"> 证书过期</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%81%E4%B9%A6%E4%B8%8D%E7%AC%A6"><span class="nav-number">5.5.</span> <span class="nav-text"> 证书不符</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cni0-%E5%9C%B0%E5%9D%80%E9%94%99%E8%AF%AF"><span class="nav-number">5.6.</span> <span class="nav-text"> cni0 地址错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcd-%E9%94%99%E8%AF%AF"><span class="nav-number">5.7.</span> <span class="nav-text"> etcd 错误</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D"><span class="nav-number">6.</span> <span class="nav-text"> 备份恢复</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B-etcd-%E9%85%8D%E7%BD%AE"><span class="nav-number">6.1.</span> <span class="nav-text"> 查看 etcd 配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-etcd-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">6.2.</span> <span class="nav-text"> 安装 etcd 客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B-etcd-%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">6.3.</span> <span class="nav-text"> 查看 etcd 数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D"><span class="nav-number">6.4.</span> <span class="nav-text"> 使用命令备份恢复</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%87%E4%BB%B6%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D"><span class="nav-number">6.5.</span> <span class="nav-text"> 使用文件备份恢复</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="assassing"
      src="../images/avatar.jpg">
  <p class="site-author-name" itemprop="name">assassing</p>
  <div class="site-description" itemprop="description">技术分享</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="../archives/">
          <span class="site-state-item-count">89</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="../categories/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hxz393" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxz393" rel="noopener me external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://youtube.com/hxz393" title="YouTube → https:&#x2F;&#x2F;youtube.com&#x2F;hxz393" rel="noopener me external nofollow noreferrer" target="_blank"><i class="fab fa-youtube fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://www.discogs.com/user/assassing" title="https:&#x2F;&#x2F;www.discogs.com&#x2F;user&#x2F;assassing" rel="noopener external nofollow noreferrer" target="_blank">Discogs</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://www.last.fm/user/assassing" title="https:&#x2F;&#x2F;www.last.fm&#x2F;user&#x2F;assassing" rel="noopener external nofollow noreferrer" target="_blank">Last.fm</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://anidb.net/up795303" title="https:&#x2F;&#x2F;anidb.net&#x2F;up795303" rel="noopener external nofollow noreferrer" target="_blank">AniDB</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.x2b.net/1488965608/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../images/avatar.jpg">
      <meta itemprop="name" content="assassing">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="X to Bytes">
      <meta itemprop="description" content="技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="K8s 系统部署 | X to Bytes">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          K8s 系统部署
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-03-20 09:01:17" itemprop="dateCreated datePublished" datetime="2022-03-20T09:01:17+08:00">2022-03-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-18 23:50:08" itemprop="dateModified" datetime="2023-05-18T23:50:08+08:00">2023-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Kubernets/" itemprop="url" rel="index"><span itemprop="name">Kubernets</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Kubernets/0-%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">0.基本知识</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>13k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>43 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="快速入门"><a class="markdownIt-Anchor" href="#快速入门"></a> 快速入门</h1>
<p>通过 Minikube 快速体验 Kubernetes 系统。</p>
<h2 id="docker-基础"><a class="markdownIt-Anchor" href="#docker-基础"></a> Docker 基础</h2>
<p>首先需要在主机上安装好 Docker，然后创建一个简单的 Node.js 镜像并运行。</p>
<h3 id="安装-docker"><a class="markdownIt-Anchor" href="#安装-docker"></a> 安装 Docker</h3>
<p>安装 Docker-CE 20.10.10 版本参考步骤如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y yum-utils</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># yum makecache fast</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y docker-ce-20.10.10 docker-ce-cli-20.10.10 containerd.io docker-compose</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="配置-docker"><a class="markdownIt-Anchor" href="#配置-docker"></a> 配置 Docker</h3>
<p>通过新增配置文件 <code>/etc/docker/daemon.json</code> 来设置 Docker 参数：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /etc/docker/ ; tee /etc/docker/daemon.json &lt;&lt;-'EOF'</span>
<span class="token punctuation">&#123;</span>
  <span class="token string">"exec-opts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">"native.cgroupdriver=systemd"</span>
      <span class="token punctuation">]</span>,
  <span class="token string">"log-driver"</span><span class="token builtin class-name">:</span> <span class="token string">"json-file"</span>,
  <span class="token string">"log-opts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"max-size"</span><span class="token builtin class-name">:</span> <span class="token string">"10m"</span>,
    <span class="token string">"max-file"</span><span class="token builtin class-name">:</span> <span class="token string">"3"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">"http://192.168.1.253:10007"</span>,
      <span class="token string">"https://m9f30s9x.mirror.aliyuncs.com"</span>
      <span class="token punctuation">]</span>,
  <span class="token string">"insecure-registries"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">"192.168.1.253:10007"</span>,
      <span class="token string">"192.168.1.253:10008"</span>
      <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>
EOF<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置参数的解释如下：</p>
<ul>
<li><code>exec-opts</code>：设置 cgroup 驱动方式，与 Kubernetes 中 kubelet 使用的方式匹配。</li>
<li><code>log-driver</code>、<code>log-opts</code>：设置 Docker 容器的日志格式和限制，日志文件最大为 10M，最多保留 3 个文件，以避免容器日志过大占用硬盘空间。</li>
<li><code>registry-mirrors</code>：镜像仓库地址，使用阿里云仓库和 Nexus 私服仓库进行加速。</li>
<li><code>insecure-registries</code>：设置私有仓库地址，忽略对强制 HTTPS 认证的要求。</li>
</ul>
<h3 id="启动-docker"><a class="markdownIt-Anchor" href="#启动-docker"></a> 启动 Docker</h3>
<p>配置完毕后，启动并设置 Docker 自启动：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now docker</span>
Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># docker -v</span>
Docker version <span class="token number">20.10</span>.10, build b485636
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># docker-compose -v</span>
<span class="token function">docker-compose</span> version <span class="token number">1.18</span>.0, build 8dd22a9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="创建-nodejs-应用"><a class="markdownIt-Anchor" href="#创建-nodejs-应用"></a> 创建 Node.js 应用</h3>
<p>创建一个简单的 Node.js Web 应用，并打包成容器镜像。应用会接受 HTTP 请求并响应应用运行的主机名。</p>
<p>新建一个 app.js 文件，内容如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> app.js
const http <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const os <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console.log<span class="token punctuation">(</span><span class="token string">"Runing..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

var handle <span class="token operator">=</span> function<span class="token punctuation">(</span>request, response<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        console.log<span class="token punctuation">(</span><span class="token string">"Request IP: "</span> + request.connection.remoteAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response.writeHead<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response.end<span class="token punctuation">(</span><span class="token string">"Hostname: "</span> + os.hostname<span class="token punctuation">(</span><span class="token punctuation">)</span> + <span class="token string">"<span class="token entity" title="\n">\n</span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

var www <span class="token operator">=</span> http.createServer<span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
www.listen<span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>应用在 8080 端口启动一个 HTTP 服务器，服务器会以状态码 200 和输出消息来响应每个请求。请求处理程序会将客户端 IP 打印到标准输出。</p>
<h3 id="创建-dockerfile"><a class="markdownIt-Anchor" href="#创建-dockerfile"></a> 创建 Dockerfile</h3>
<p>Dockerfile 文件需要和 <code>app.js</code> 文件放在同一目录，内容如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> Dockerfile
FROM node:7
ADD app.js /app.js
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"node"</span>, <span class="token string">"app.js"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里使用 Node 7 版本的基础镜像，然后将 <code>app.js</code> 文件添加到镜像根目录，最后执行 <code>node app.js</code> 命令。</p>
<h3 id="构建容器镜像"><a class="markdownIt-Anchor" href="#构建容器镜像"></a> 构建容器镜像</h3>
<p>构建不是由 Docker 客户端进行的，而是将整个目录的文件上传到 Docker 守护进程并在那里进行。因此，在守护进程运行在另外一个服务器时，不要在构建目录中包含不需要的文件。</p>
<p>使用 docker build 构建名为 kubia 的镜像：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">docker</span> build <span class="token parameter variable">-t</span> kubia <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Dockerfile 中每一条指令都会创建一个新层。上面的例子中，有一层用来添加 <code>app.js</code>，另外一层运行 <code>node app.js</code> 命令，最后一层会被标记为 kubia:latest。构建完成后镜像会存储在本地。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">docker</span> images kubia
REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
kubia        latest    3749c66c19c7   <span class="token number">2</span> minutes ago   660MB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="运行容器镜像"><a class="markdownIt-Anchor" href="#运行容器镜像"></a> 运行容器镜像</h3>
<p>指定容器名为 kubia-container，暴露端口 8080，在后台运行：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">docker</span> run <span class="token parameter variable">--name</span> kubia-container <span class="token parameter variable">-p</span> <span class="token number">8080</span>:8080 <span class="token parameter variable">-d</span> kubia
c971ba30949f2b1dbca90a96274a3a06a577d33f981e9bc82f327fbdb7010277<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启动后在浏览器通过 192.168.2.206:8080 访问服务：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server5 ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> <span class="token number">192.168</span>.2.206:8080
Hostname: c971ba30949f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>此时容器主机名就是 Docker 容器短 ID。可以查询容器日志：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">docker</span> logs kubia-container
Runing<span class="token punctuation">..</span>.
Request IP: ::ffff:192.168.2.101
Request IP: ::ffff:192.168.2.205<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="搭建-minikube"><a class="markdownIt-Anchor" href="#搭建-minikube"></a> 搭建 Minikube</h2>
<p>Minikube 是一个构建单节点集群的工具，具体使用可以参考 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/kubernetes/minikube">GitHub</a>。</p>
<h3 id="安装"><a class="markdownIt-Anchor" href="#安装"></a> 安装</h3>
<p>下面通过下载 RPM 包的方式安装 Minikube：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> <span class="token parameter variable">-LO</span> https://storage.googleapis.com/minikube/releases/latest/minikube-latest.x86_64.rpm
<span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">rpm</span> <span class="token parameter variable">-Uvh</span> minikube-latest.x86_64.rpm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>还需要安装 Kubectl 客户端来与 Minikube 进行交互：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> <span class="token parameter variable">-LO</span> https://storage.googleapis.com/kubernetes-release/release/<span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> <span class="token parameter variable">-s</span> https://storage.googleapis.com/kubernetes-release/release/stable.txt<span class="token variable">)</span></span>/bin/linux/amd64/kubectl
<span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">chmod</span> +x ./kubectl <span class="token operator">&amp;&amp;</span> <span class="token function">mv</span> ./kubectl /usr/local/bin/kubectl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="启动"><a class="markdownIt-Anchor" href="#启动"></a> 启动</h3>
<p>如果不带参数启动，会报错说不能使用 root 权限运行。这里使用一个加入了 docker 组的 user1 来运行。</p>
<p>另外经常会碰到镜像拉取失败的情况，可以加入 <code>--registry-mirror</code> 参数指定仓库：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">usermod</span> <span class="token parameter variable">-G</span> <span class="token function">docker</span> user1
<span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">su</span> <span class="token parameter variable">-l</span> user1
<span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ minikube start --image-mirror-country<span class="token operator">=</span>cn --image-repository<span class="token operator">=</span>registry.cn-hangzhou.aliyuncs.com/google_containers
* minikube v1.23.2 on Centos <span class="token number">7.9</span>.2009
* Automatically selected the <span class="token function">docker</span> driver
* Using image repository registry.cn-hangzhou.aliyuncs.com/google_containers
* Starting control plane <span class="token function">node</span> minikube <span class="token keyword">in</span> cluster minikube
* Pulling base image <span class="token punctuation">..</span>.
* Creating <span class="token function">docker</span> container <span class="token punctuation">(</span>CPUs<span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">Memory</span><span class="token operator">=</span>2200MB<span class="token punctuation">)</span> <span class="token punctuation">..</span>.
* Verifying Kubernetes components<span class="token punctuation">..</span>.
* Enabled addons: storage-provisioner, default-storageclass
* kubectl not found. If you need it, try: <span class="token string">'minikube kubectl -- get pods -A'</span>
* Done<span class="token operator">!</span> kubectl is now configured to use <span class="token string">"minikube"</span> cluster and <span class="token string">"default"</span> namespace by default<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>遇到其他报错可以删除文件重新启动：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ minikube delete
* Deleting <span class="token string">"minikube"</span> <span class="token keyword">in</span> <span class="token function">docker</span> <span class="token punctuation">..</span>.
* Removed all traces of the <span class="token string">"minikube"</span> cluster.
<span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ <span class="token function">rm</span> <span class="token parameter variable">-rf</span> .minikube<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="查看"><a class="markdownIt-Anchor" href="#查看"></a> 查看</h3>
<p>安装好以后可以使用 <code>kubectl</code> 命令查看集群工作状态：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ kubectl cluster-info 
Kubernetes control plane is running at https://192.168.49.2:8443
CoreDNS is running at https://192.168.49.2:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
<span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ kubectl get nodes
NAME       STATUS   ROLES                  AGE     VERSION
minikube   Ready    control-plane,master   8m40s   v1.22.2
<span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ kubectl describe <span class="token function">node</span> minikube 
Name:               minikube
Roles:              control-plane,master
Labels:             beta.kubernetes.io/arch<span class="token operator">=</span>amd64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="建立-pod"><a class="markdownIt-Anchor" href="#建立-pod"></a> 建立 pod</h3>
<p>使用 <code>kubectl run</code> 命令可以创建所有必要组件而无需使用 JSON 或 YAML 文件。其中使用 <code>--image</code> 指定镜像，使用 <code>--port</code> 说明容器监听端口：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ kubectl run kubia <span class="token parameter variable">--image</span><span class="token operator">=</span>assassing/kubia <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">8080</span>
pod/kubia created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>不能用 <code>kubectl</code> 直接列出容器，因为 Pod 才是操作对象。一个 Pod 包含一个或多个容器，每个容器都运行一个应用进程，它们总是运行在同一个工作节点及命名空间中。查看 Pod 运行状态：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ kubectl get pod
NAME    READY   STATUS    RESTARTS   AGE
kubia   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          58s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="暴露端口"><a class="markdownIt-Anchor" href="#暴露端口"></a> 暴露端口</h3>
<p>每个 Pod 都有自己的 IP，Pod 分布在不同的工作节点上。它们不能被外部访问，需要通过服务对象来公开：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ kubectl expose pod kubia <span class="token parameter variable">--type</span><span class="token operator">=</span>NodePort 
service/kubia exposed
<span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ minikube <span class="token function">service</span> kubia <span class="token parameter variable">--url</span>
http://192.168.49.2:32556
<span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ kubectl expose pod kubia <span class="token parameter variable">--type</span><span class="token operator">=</span>LoadBalancer <span class="token parameter variable">--name</span> kubia-http
service/kubia-http exposed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看刚刚新建的服务：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ kubectl get services
NAME         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
kubernetes   ClusterIP      <span class="token number">10.96</span>.0.1       <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>/TCP          42m
kubia        NodePort       <span class="token number">10.107</span>.120.56   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">8080</span>:32556/TCP   3m22s
kubia-http   LoadBalancer   <span class="token number">10.108</span>.108.14   <span class="token operator">&lt;</span>pending<span class="token operator">></span>     <span class="token number">8080</span>:31003/TCP   56s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>显示 pending 是因为 Minikube 不支持 LoadBalancer 类型的服务，可以用另外一个命令查看：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ minikube <span class="token function">service</span> kubia-http
<span class="token operator">|</span>-----------<span class="token operator">|</span>------------<span class="token operator">|</span>-------------<span class="token operator">|</span>---------------------------<span class="token operator">|</span>
<span class="token operator">|</span> NAMESPACE <span class="token operator">|</span>    NAME    <span class="token operator">|</span> TARGET PORT <span class="token operator">|</span>            URL            <span class="token operator">|</span>
<span class="token operator">|</span>-----------<span class="token operator">|</span>------------<span class="token operator">|</span>-------------<span class="token operator">|</span>---------------------------<span class="token operator">|</span>
<span class="token operator">|</span> default   <span class="token operator">|</span> kubia-http <span class="token operator">|</span>        <span class="token number">8080</span> <span class="token operator">|</span> http://192.168.49.2:31003 <span class="token operator">|</span>
<span class="token operator">|</span>-----------<span class="token operator">|</span>------------<span class="token operator">|</span>-------------<span class="token operator">|</span>---------------------------<span class="token operator">|</span>
* Opening <span class="token function">service</span> default/kubia-http <span class="token keyword">in</span> default browser<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="系统配置"><a class="markdownIt-Anchor" href="#系统配置"></a> 系统配置</h1>
<p>以 CentOS 7 系统作为例子。</p>
<h2 id="网络配置"><a class="markdownIt-Anchor" href="#网络配置"></a> 网络配置</h2>
<p>要修改 IP 地址，通过 <code>nmcli</code> 命令，或者修改 <code>/etc/sysconfig/network-scripts/</code> 下面的网卡配置文件都可：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># nmcli connection modify ens32 connection.autoconnect yes ipv4.method manual ipv4.addresses 192.168.1.101/24 ipv4.gateway 192.168.1.1 ipv4.dns 8.8.8.8</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># nmcli connection up ens32</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>上面修改网卡 <code>ens32</code> 的 IP 地址为 <code>192.168.1.101</code>，网关地址 <code>192.168.1.1</code>，DNS 地址 <code>8.8.8.8</code>。并立即生效。</p>
<h2 id="账户配置"><a class="markdownIt-Anchor" href="#账户配置"></a> 账户配置</h2>
<p>刚刚开通的阿里云服务器，无法通过 <code>ssh</code> 直接连接。可以通过阿里云管理平台，点击远程连接，选择发送命令来配置主机。</p>
<p>例如修改 <code>ssh</code> 默认端口由 22 改为 2222，并允许使用账号密码登录。重启 sshd 服务来生效：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s/#Port 22/Port 2222/g"</span> /etc/ssh/sshd_config
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s/PasswordAuthentication no/PasswordAuthentication yes/g"</span> /etc/ssh/sshd_config
systemctl restart sshd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过发送脚本的方式修改 root 账号密码：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token builtin class-name">echo</span> <span class="token string">"qv4YB7#x9WhPj?i4E1DRgu1dlOWR"</span> <span class="token operator">|</span> <span class="token function">passwd</span> root <span class="token parameter variable">--stdin</span> <span class="token operator">></span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>添加用户 alice 并设置密码。密码是 <code>/etc/shadow</code> 中哈希值：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token function">useradd</span> <span class="token parameter variable">-p</span> <span class="token punctuation">\</span><span class="token variable">$6</span><span class="token punctuation">\</span><span class="token variable">$YVLnCcQL</span><span class="token punctuation">\</span><span class="token variable">$NlbdFMzHHzw9Byk2EFjl4BNCm0riq22HnJKTVcccZv</span>/FQ/Y2HgvSeavPCUbdgzTmA3T3ksn7SYkq96An12oBW0 alice<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>最后要记得调整安全组策略。在云服务器 ECS 的安全组中，为自定义的 sshd 端口 2222 设置白名单，这样才能使用 <code>ssh</code> 远程连接。</p>
<h2 id="镜像仓库"><a class="markdownIt-Anchor" href="#镜像仓库"></a> 镜像仓库</h2>
<p>修改 <code>yum</code> 仓库地址为阿里云镜像仓库，提升软件安装和更新速度：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># yum install -y wget</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># mv /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.backup</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># mv /etc/yum.repos.d/epel-testing.repo /etc/yum.repos.d/epel-testing.repo.backup</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/yum.repos.d/ &amp;&amp; wget http://mirrors.aliyun.com/repo/Centos-7.repo &amp;&amp; wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo &amp;&amp; cd -</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># yum clean all</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># yum makecache</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>虽然阿里云镜像仓库下载速度被限制成 500 kB/s，但胜在稳定。</p>
<h2 id="内核升级"><a class="markdownIt-Anchor" href="#内核升级"></a> 内核升级</h2>
<p>CentOS 7 安装镜像自带的 3.10 内核已太旧，很多应用需要的内核功能支持不了。装好后第一时间升级内核。</p>
<h3 id="查看内核"><a class="markdownIt-Anchor" href="#查看内核"></a> 查看内核</h3>
<p>查看当前运行的内核版本:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># uname -sr</span>
Linux <span class="token number">3.10</span>.0-1160.el7.x86_64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="安装内核"><a class="markdownIt-Anchor" href="#安装内核"></a> 安装内核</h3>
<p>导入 ELRepo 软件仓库的公共秘钥，安装 yum 源：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># yum install -y https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>列出当前最新内核版本：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># yum --disablerepo="*" --enablerepo="elrepo-kernel" list available</span>
Available Packages
kernel-lt.x86_64    <span class="token number">5.4</span>.242-1.el7.elrepo   elrepo-kernel
kernel-ml-devel.x86 <span class="token number">5.4</span>.242-1.el7.elrepo   elrepo-kernel
kernel-ml.x86_64    <span class="token number">6.3</span>.2-1.el7.elrepo     elrepo-kernel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中 <code>kernel-lt</code> 表示 long-term（长期支持版本）,<code>kernel-ml</code> 表示 latest mainline（最新主线版本）。选择安装 <code>kernel-lt.x86_64</code> 版本。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># yum install -y kernel-lt-5.4.242-1.el7.elrepo --enablerepo=elrepo-kernel</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="修改引导"><a class="markdownIt-Anchor" href="#修改引导"></a> 修改引导</h3>
<p>查看已安装系统内核。正常情况下会保留旧内核，升级失败时可以回滚：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># awk -F\' '$1=="menuentry " &#123;print i++ " : " $2&#125;' /etc/grub2.cfg</span>
<span class="token number">0</span> <span class="token builtin class-name">:</span> CentOS Linux <span class="token punctuation">(</span><span class="token number">5.4</span>.242-1.el7.elrepo.x86_64<span class="token punctuation">)</span> <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>
<span class="token number">1</span> <span class="token builtin class-name">:</span> CentOS Linux <span class="token punctuation">(</span><span class="token number">3.10</span>.0-1160.el7.x86_64<span class="token punctuation">)</span> <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token builtin class-name">:</span> CentOS Linux <span class="token punctuation">(</span><span class="token number">0</span>-rescue-e175a587657a4fae8ab45bb178e24c22<span class="token punctuation">)</span> <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果引导方式是 UEFI，则需要查看 <code>/etc/grub2-efi.cfg</code> 文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># awk -F\' '$1=="menuentry " &#123;print i++ " : " $2&#125;' /etc/grub2-efi.cfg</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>设置内核启动顺序，需要重新生成引导文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># grub2-set-default 0</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># grub2-mkconfig -o /boot/grub2/grub.cfg</span>
Generating grub configuration <span class="token function">file</span> <span class="token punctuation">..</span>.
Found linux image: /boot/vmlinuz-5.4.242-1.el7.elrepo.x86_64
Found initrd image: /boot/initramfs-5.4.242-1.el7.elrepo.x86_64.img
Found linux image: /boot/vmlinuz-3.10.0-1160.el7.x86_64
Found initrd image: /boot/initramfs-3.10.0-1160.el7.x86_64.img
Found linux image: /boot/vmlinuz-0-rescue-e175a587657a4fae8ab45bb178e24c22
Found initrd image: /boot/initramfs-0-rescue-e175a587657a4fae8ab45bb178e24c22.img
<span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>UEFI 启动配置文件位置的位置不同：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># grub2-set-default 0</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="降级内核"><a class="markdownIt-Anchor" href="#降级内核"></a> 降级内核</h3>
<p>内核降级和升级步骤一样，用 <code>yum</code> 安装指定内核版本后，修改引导配置文件并重启。</p>
<h3 id="删除内核"><a class="markdownIt-Anchor" href="#删除内核"></a> 删除内核</h3>
<p>重启后如果新内核运作正常，可以删除旧内核：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># yum remove -y kernel-lt-3.10.0-1160.el7.elrepo.x86_64</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="内核调整"><a class="markdownIt-Anchor" href="#内核调整"></a> 内核调整</h2>
<p>需要修改内核参数,否则安装运行 K8s 会失败.</p>
<h3 id="禁用虚拟内存"><a class="markdownIt-Anchor" href="#禁用虚拟内存"></a> 禁用虚拟内存</h3>
<p>虽然安装系统时已经去除了 swap 分区，但保险起见，还是对开机挂载配置文件 <code>/etc/fstab</code> 进行重写。然后重新挂载根目录：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># swapoff -a</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># yes | cp /etc/fstab /etc/fstab_bak</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/fstab_bak |grep -v swap > /etc/fstab</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># mount -n -o remount,rw /</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "vm.swappiness = 0" >> /etc/sysctl.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="开启端口转发"><a class="markdownIt-Anchor" href="#开启端口转发"></a> 开启端口转发</h3>
<p>首先要确认网卡 MAC 地址没有冲突，然后确保 <code>br_netfilter</code> 和 <code>overlay</code> 模块被加载：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "br_netfilter" >> /etc/modules-load.d/k8s.conf</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "overlay" >> /etc/modules-load.d/k8s.conf</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># modprobe br_netfilter</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># modprobe overlay</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># lsmod | grep 'br_netfilter\|overlay'</span>
br_netfilter           <span class="token number">28672</span>  <span class="token number">0</span> 
overlay               <span class="token number">114688</span>  <span class="token number">35</span> 
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># modprobe ip_vs</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># modprobe ip_vs_rr</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># modprobe ip_vs_wrr</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># modprobe ip_vs_sh</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "net.ipv4.ip_nonlocal_bind = 1" >> /etc/sysctl.conf</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "net.ipv4.ip_local_port_range = 1024 65535" >> /etc/sysctl.conf</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "net.bridge.bridge-nf-call-ip6tables = 1" >> /etc/sysctl.conf</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "net.bridge.bridge-nf-call-iptables = 1" >> /etc/sysctl.conf</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "10000 65535" > /proc/sys/net/ipv4/ip_local_port_range</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="去除文件系统限制"><a class="markdownIt-Anchor" href="#去除文件系统限制"></a> 去除文件系统限制</h3>
<p>根据硬件情况，对文件系统限制调大。最后使用 <code>sysctl --system</code> 命令来使配置生效：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ulimit -SHn 65536</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "* soft nofile 655350" >> /etc/security/limits.conf</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "* hard nofile 655350" >> /etc/security/limits.conf</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "vm.max_map_count = 524288" >> /etc/sysctl.conf</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "fs.file-max = 655350" >> /etc/sysctl.conf</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "fs.inotify.max_user_instances=8192" >> /etc/sysctl.conf</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># sysctl --system</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="关闭防火墙"><a class="markdownIt-Anchor" href="#关闭防火墙"></a> 关闭防火墙</h2>
<p>关闭防火墙和 SELinux，否则容器访问主机文件系统会不正常：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># service iptables stop</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># chkconfig iptables off</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop firewalld</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># systemctl disable firewalld</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># setenforce 0</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># sed -i 's/^SELINUX=enforcing$/SELINUX=disabled/' /etc/selinux/config</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># getenforce #</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="个性化设置"><a class="markdownIt-Anchor" href="#个性化设置"></a> 个性化设置</h2>
<p>一些按照喜好来设置的系统调整。</p>
<h3 id="修改系统语言"><a class="markdownIt-Anchor" href="#修改系统语言"></a> 修改系统语言</h3>
<p>修改系统语言为英语：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo 'LANG="en_US.UTF-8"' > /etc/locale.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="修改主机名"><a class="markdownIt-Anchor" href="#修改主机名"></a> 修改主机名</h3>
<p>修改节点上的主机名，例如 k8s-master-1、k8s-m1-pro、k8s-250 等，尽量取有意义的名字：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># hostnamectl set-hostname k8s-101</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>将主机名添加到本地域名解析 <code>/etc/hosts</code> 文件中：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "127.0.0.1   $(hostname)" >> /etc/hosts</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="时间同步"><a class="markdownIt-Anchor" href="#时间同步"></a> 时间同步</h3>
<p>设置网络时间同步。若服务器时间不对，可能会遇到一些莫名其妙的验证方面问题：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># timedatectl set-timezone "Asia/Shanghai"</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># yum -y install ntp ntpdate</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># ntpdate cn.pool.ntp.org</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># hwclock --systohc</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># hwclock -w</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># date</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="安装工具"><a class="markdownIt-Anchor" href="#安装工具"></a> 安装工具</h3>
<p>安装一些常用系统维护工具：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># yum install -y git wget net-tools bind-utils vim bash-completion nfs-utils jq nc telnet lvm2 unzip iftop lsof</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="限制日志大小"><a class="markdownIt-Anchor" href="#限制日志大小"></a> 限制日志大小</h3>
<p>限制系统 journal 日志保留时常为 1 周，免得磁盘被大量日志挤占空间：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># journalctl --vacuum-time=1w</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="设置变量"><a class="markdownIt-Anchor" href="#设置变量"></a> 设置变量</h3>
<p>修改 <code>/etc/profile</code> 文件，添加一些常用变量：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "export HISTTIMEFORMAT='`whoami` : %F %T :'" >> /etc/profile</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># echo "export NFS_SERVER=192.168.1.253" >> /etc/profile</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>NFS 服务器地址变量按实际情况填写。</p>
<h2 id="磁盘管理"><a class="markdownIt-Anchor" href="#磁盘管理"></a> 磁盘管理</h2>
<p>一般建议把容器工作目录和数据储存同系统根目录分开挂载，免得影响系统运行稳定性。下面以新增一块储存盘为例，演示磁盘管理操作。</p>
<h3 id="初始化"><a class="markdownIt-Anchor" href="#初始化"></a> 初始化</h3>
<p>服务器上新增一块固态硬盘 sdb，需要初始化后才能使用：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># lsblk</span>
NAME            MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
sda               <span class="token number">8</span>:0    <span class="token number">0</span> <span class="token number">223</span>.6G  <span class="token number">0</span> disk 
├─sda1            <span class="token number">8</span>:1    <span class="token number">0</span>   200M  <span class="token number">0</span> part /boot/efi
├─sda2            <span class="token number">8</span>:2    <span class="token number">0</span>     1G  <span class="token number">0</span> part /boot
└─sda3            <span class="token number">8</span>:3    <span class="token number">0</span> <span class="token number">222</span>.4G  <span class="token number">0</span> part 
  └─centos-root <span class="token number">253</span>:0    <span class="token number">0</span> <span class="token number">222</span>.4G  <span class="token number">0</span> lvm  /
sdb               <span class="token number">8</span>:16   <span class="token number">0</span> <span class="token number">931</span>.5G  <span class="token number">0</span> disk <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 <code>fdisk</code> 命令来管理磁盘：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># fdisk /dev/sdb</span>
Welcome to <span class="token function">fdisk</span> <span class="token punctuation">(</span>util-linux <span class="token number">2.23</span>.2<span class="token punctuation">)</span>.

Changes will remain <span class="token keyword">in</span> memory only, <span class="token keyword">until</span> you decide to <span class="token function">write</span> them.
Be careful before using the <span class="token function">write</span> command.

Device does not contain a recognized partition table
Building a new DOS disklabel with disk identifier 0x50398e42.

Command <span class="token punctuation">(</span>m <span class="token keyword">for</span> <span class="token builtin class-name">help</span><span class="token punctuation">)</span>: p

Disk /dev/sdb: <span class="token number">1000.2</span> GB, <span class="token number">1000204886016</span> bytes, <span class="token number">1953525168</span> sectors
Units <span class="token operator">=</span> sectors of <span class="token number">1</span> * <span class="token number">512</span> <span class="token operator">=</span> <span class="token number">512</span> bytes
Sector size <span class="token punctuation">(</span>logical/physical<span class="token punctuation">)</span>: <span class="token number">512</span> bytes / <span class="token number">512</span> bytes
I/O size <span class="token punctuation">(</span>minimum/optimal<span class="token punctuation">)</span>: <span class="token number">512</span> bytes / <span class="token number">512</span> bytes
Disk label type: dos
Disk identifier: 0x50398e42

   Device Boot      Start         End      Blocks   Id  System<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先使用初始化并分区：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Command <span class="token punctuation">(</span>m <span class="token keyword">for</span> <span class="token builtin class-name">help</span><span class="token punctuation">)</span>: n
Partition type:
   p   primary <span class="token punctuation">(</span><span class="token number">0</span> primary, <span class="token number">0</span> extended, <span class="token number">4</span> <span class="token function">free</span><span class="token punctuation">)</span>
   e   extended
Select <span class="token punctuation">(</span>default p<span class="token punctuation">)</span>: p
Partition number <span class="token punctuation">(</span><span class="token number">1</span>-4, default <span class="token number">1</span><span class="token punctuation">)</span>: 
First sector <span class="token punctuation">(</span><span class="token number">2048</span>-1953525167, default <span class="token number">2048</span><span class="token punctuation">)</span>: 
Using default value <span class="token number">2048</span>
Last sector, +sectors or +size<span class="token punctuation">&#123;</span>K,M,G<span class="token punctuation">&#125;</span> <span class="token punctuation">(</span><span class="token number">2048</span>-1953525167, default <span class="token number">1953525167</span><span class="token punctuation">)</span>: 
Using default value <span class="token number">1953525167</span>
Partition <span class="token number">1</span> of <span class="token builtin class-name">type</span> Linux and of size <span class="token number">931.5</span> GiB is <span class="token builtin class-name">set</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改分区 <code>system ID</code> 为 <code>lvm</code> ：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Command <span class="token punctuation">(</span>m <span class="token keyword">for</span> <span class="token builtin class-name">help</span><span class="token punctuation">)</span>: t
Selected partition <span class="token number">1</span>
Hex code <span class="token punctuation">(</span>type L to list all codes<span class="token punctuation">)</span>: 8e
Changed <span class="token builtin class-name">type</span> of partition <span class="token string">'Linux'</span> to <span class="token string">'Linux LVM'</span>
Command <span class="token punctuation">(</span>m <span class="token keyword">for</span> <span class="token builtin class-name">help</span><span class="token punctuation">)</span>: w
The partition table has been altered<span class="token operator">!</span>

Calling ioctl<span class="token punctuation">(</span><span class="token punctuation">)</span> to re-read partition table.
Syncing disks.
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># partprobe</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="创建-pv"><a class="markdownIt-Anchor" href="#创建-pv"></a> 创建 PV</h3>
<p>使用 <code>pvcreate</code> 命令来创建 PV：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-103 ~<span class="token punctuation">]</span><span class="token comment"># pvcreate /dev/sdb1</span>
  Physical volume <span class="token string">"/dev/sdb1"</span> successfully created.
<span class="token punctuation">[</span>root@k8s-103 ~<span class="token punctuation">]</span><span class="token comment"># pvscan</span>
  PV /dev/sda2   VG centos          lvm2 <span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token number">49.00</span> GiB / <span class="token number">0</span>    free<span class="token punctuation">]</span>
  PV /dev/sdb1                      lvm2 <span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token number">200.00</span> GiB<span class="token punctuation">]</span>
  Total: <span class="token number">2</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token number">249.00</span> GiB<span class="token punctuation">]</span> / <span class="token keyword">in</span> use: <span class="token number">1</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token number">49.00</span> GiB<span class="token punctuation">]</span> / <span class="token keyword">in</span> no VG: <span class="token number">1</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token number">200.00</span> GiB<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查询刚创建的 PV 详细信息：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-103 ~<span class="token punctuation">]</span><span class="token comment"># pvdisplay</span>
  --- Physical volume ---
  PV Name               /dev/sda2
  VG Name               centos
  PV Size               <span class="token operator">&lt;</span><span class="token number">49.00</span> GiB / not usable <span class="token number">3.00</span> MiB
  Allocatable           <span class="token function">yes</span> <span class="token punctuation">(</span>but full<span class="token punctuation">)</span>
  PE Size               <span class="token number">4.00</span> MiB
  Total PE              <span class="token number">12543</span>
  Free PE               <span class="token number">0</span>
  Allocated PE          <span class="token number">12543</span>
  PV UUID               FOgL5t-v6EE-neHA-Kdpy-ynt0-yzXr-Tin7Am
   
  <span class="token string">"/dev/sdb1"</span> is a new physical volume of <span class="token string">"&lt;200.00 GiB"</span>
  --- NEW Physical volume ---
  PV Name               /dev/sdb1
  VG Name               
  PV Size               <span class="token operator">&lt;</span><span class="token number">200.00</span> GiB
  Allocatable           NO
  PE Size               <span class="token number">0</span>   
  Total PE              <span class="token number">0</span>
  Free PE               <span class="token number">0</span>
  Allocated PE          <span class="token number">0</span>
  PV UUID               rxkppt-GxSK-igDI-NgI1-3CZw-F3r2-YtXIU9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="创建-vg"><a class="markdownIt-Anchor" href="#创建-vg"></a> 创建 VG</h3>
<p>声明变量：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-103 ~<span class="token punctuation">]</span><span class="token comment"># export DIR=ssd</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>新建 VG：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-103 ~<span class="token punctuation">]</span><span class="token comment"># vgcreate $&#123;DIR&#125; /dev/sdb1</span>
  Volume group <span class="token string">"ssd"</span> successfully created
<span class="token punctuation">[</span>root@k8s-103 ~<span class="token punctuation">]</span><span class="token comment"># vgscan</span>
  Reading volume <span class="token function">groups</span> from cache.
  Found volume group <span class="token string">"centos"</span> using metadata <span class="token builtin class-name">type</span> lvm2
  Found volume group <span class="token string">"ssd"</span> using metadata <span class="token builtin class-name">type</span> lvm2
<span class="token punctuation">[</span>root@k8s-103 ~<span class="token punctuation">]</span><span class="token comment"># vgdisplay</span>
  --- Volume group ---
  VG Name               centos
  System ID             
  Format                lvm2
  Metadata Areas        <span class="token number">1</span>
  Metadata Sequence No  <span class="token number">2</span>
  VG Access             read/write
  VG Status             resizable
  MAX LV                <span class="token number">0</span>
  Cur LV                <span class="token number">1</span>
  Open LV               <span class="token number">1</span>
  Max PV                <span class="token number">0</span>
  Cur PV                <span class="token number">1</span>
  Act PV                <span class="token number">1</span>
  VG Size               <span class="token operator">&lt;</span><span class="token number">49.00</span> GiB
  PE Size               <span class="token number">4.00</span> MiB
  Total PE              <span class="token number">12543</span>
  Alloc PE / Size       <span class="token number">12543</span> / <span class="token operator">&lt;</span><span class="token number">49.00</span> GiB
  Free  PE / Size       <span class="token number">0</span> / <span class="token number">0</span>   
  VG UUID               xuRCcF-ROBb-5OhK-4BAY-fuBi-EvlU-uqxs9T
   
  --- Volume group ---
  VG Name               ssd
  System ID             
  Format                lvm2
  Metadata Areas        <span class="token number">1</span>
  Metadata Sequence No  <span class="token number">1</span>
  VG Access             read/write
  VG Status             resizable
  MAX LV                <span class="token number">0</span>
  Cur LV                <span class="token number">0</span>
  Open LV               <span class="token number">0</span>
  Max PV                <span class="token number">0</span>
  Cur PV                <span class="token number">1</span>
  Act PV                <span class="token number">1</span>
  VG Size               <span class="token operator">&lt;</span><span class="token number">200.00</span> GiB
  PE Size               <span class="token number">4.00</span> MiB
  Total PE              <span class="token number">51199</span>
  Alloc PE / Size       <span class="token number">0</span> / <span class="token number">0</span>   
  Free  PE / Size       <span class="token number">51199</span> / <span class="token operator">&lt;</span><span class="token number">200.00</span> GiB
  VG UUID               yq6LIQ-D4Xm-hPGZ-2Zqi-Bdsc-vz3Y-cvuAmC<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="创建-lv"><a class="markdownIt-Anchor" href="#创建-lv"></a> 创建 LV</h3>
<p>建立名为 ssd 的 LV，使用参数 <code>-l</code> 指定分配 free PE 数量:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-103 ~<span class="token punctuation">]</span><span class="token comment"># lvcreate -l +100%FREE -n $&#123;DIR&#125; $&#123;DIR&#125;</span>
  Logical volume <span class="token string">"ssd"</span> created.
<span class="token punctuation">[</span>root@k8s-103 ~<span class="token punctuation">]</span><span class="token comment"># lvdisplay</span>
  --- Logical volume ---
  LV Path                /dev/centos/root
  LV Name                root
  VG Name                centos
  LV UUID                GySaQs-a1ni-kiUg-Ys86-j287-Sqpu-9PWECL
  LV Write Access        read/write
  LV Creation host, <span class="token function">time</span> localhost, <span class="token number">2023</span>-05-17 08:02:19 +0800
  LV Status              available
  <span class="token comment"># open                 1</span>
  LV Size                <span class="token operator">&lt;</span><span class="token number">49.00</span> GiB
  Current LE             <span class="token number">12543</span>
  Segments               <span class="token number">1</span>
  Allocation             inherit
  Read ahead sectors     auto
  - currently <span class="token builtin class-name">set</span> to     <span class="token number">8192</span>
  Block device           <span class="token number">253</span>:0
   
  --- Logical volume ---
  LV Path                /dev/ssd/ssd
  LV Name                ssd
  VG Name                ssd
  LV UUID                EkAIWn-ad01-3nsX-cfBN-rpgV-dSwk-Pc1MJI
  LV Write Access        read/write
  LV Creation host, <span class="token function">time</span> k8s-103, <span class="token number">2023</span>-05-17 02:28:34 +0800
  LV Status              available
  <span class="token comment"># open                 0</span>
  LV Size                <span class="token operator">&lt;</span><span class="token number">200.00</span> GiB
  Current LE             <span class="token number">51199</span>
  Segments               <span class="token number">1</span>
  Allocation             inherit
  Read ahead sectors     auto
  - currently <span class="token builtin class-name">set</span> to     <span class="token number">8192</span>
  Block device           <span class="token number">253</span>:1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="格式化"><a class="markdownIt-Anchor" href="#格式化"></a> 格式化</h3>
<p>格式化成 xfs 格式，并挂载到指定目录下面：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-103 ~<span class="token punctuation">]</span><span class="token comment"># mkfs.xfs /dev/$&#123;DIR&#125;/$&#123;DIR&#125;</span>
meta-data<span class="token operator">=</span>/dev/ssd/ssd           <span class="token assign-left variable">isize</span><span class="token operator">=</span><span class="token number">512</span>    <span class="token assign-left variable">agcount</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">agsize</span><span class="token operator">=</span><span class="token number">13106944</span> blks
         <span class="token operator">=</span>                       <span class="token assign-left variable">sectsz</span><span class="token operator">=</span><span class="token number">512</span>   <span class="token assign-left variable">attr</span><span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">projid32bit</span><span class="token operator">=</span><span class="token number">1</span>
         <span class="token operator">=</span>                       <span class="token assign-left variable">crc</span><span class="token operator">=</span><span class="token number">1</span>        <span class="token assign-left variable">finobt</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">sparse</span><span class="token operator">=</span><span class="token number">0</span>
data     <span class="token operator">=</span>                       <span class="token assign-left variable">bsize</span><span class="token operator">=</span><span class="token number">4096</span>   <span class="token assign-left variable">blocks</span><span class="token operator">=</span><span class="token number">52427776</span>, <span class="token assign-left variable">imaxpct</span><span class="token operator">=</span><span class="token number">25</span>
         <span class="token operator">=</span>                       <span class="token assign-left variable">sunit</span><span class="token operator">=</span><span class="token number">0</span>      <span class="token assign-left variable">swidth</span><span class="token operator">=</span><span class="token number">0</span> blks
naming   <span class="token operator">=</span>version <span class="token number">2</span>              <span class="token assign-left variable">bsize</span><span class="token operator">=</span><span class="token number">4096</span>   ascii-ci<span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ftype</span><span class="token operator">=</span><span class="token number">1</span>
log      <span class="token operator">=</span>internal log           <span class="token assign-left variable">bsize</span><span class="token operator">=</span><span class="token number">4096</span>   <span class="token assign-left variable">blocks</span><span class="token operator">=</span><span class="token number">25599</span>, <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token number">2</span>
         <span class="token operator">=</span>                       <span class="token assign-left variable">sectsz</span><span class="token operator">=</span><span class="token number">512</span>   <span class="token assign-left variable">sunit</span><span class="token operator">=</span><span class="token number">0</span> blks, lazy-count<span class="token operator">=</span><span class="token number">1</span>
realtime <span class="token operator">=</span>none                   <span class="token assign-left variable">extsz</span><span class="token operator">=</span><span class="token number">4096</span>   <span class="token assign-left variable">blocks</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">rtextents</span><span class="token operator">=</span><span class="token number">0</span>         <span class="token assign-left variable">extsz</span><span class="token operator">=</span><span class="token number">4096</span>   <span class="token assign-left variable">blocks</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">rtextents</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token punctuation">[</span>root@k8s-103 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /$&#123;DIR&#125;</span>
<span class="token punctuation">[</span>root@k8s-103 ~<span class="token punctuation">]</span><span class="token comment"># mount /dev/$&#123;DIR&#125;/$&#123;DIR&#125; /$&#123;DIR&#125;/</span>
<span class="token punctuation">[</span>root@k8s-103 ~<span class="token punctuation">]</span><span class="token comment"># echo "/dev/mapper/$&#123;DIR&#125;-$&#123;DIR&#125; /$&#123;DIR&#125; xfs defaults 0 0" >> /etc/fstab</span>
<span class="token punctuation">[</span>root@k8s-103 ~<span class="token punctuation">]</span><span class="token comment"># df -hT</span>
Filesystem              Type      Size  Used Avail Use% Mounted on
devtmpfs                devtmpfs  <span class="token number">3</span>.9G     <span class="token number">0</span>  <span class="token number">3</span>.9G   <span class="token number">0</span>% /dev
tmpfs                   tmpfs     <span class="token number">3</span>.9G     <span class="token number">0</span>  <span class="token number">3</span>.9G   <span class="token number">0</span>% /dev/shm
tmpfs                   tmpfs     <span class="token number">3</span>.9G  <span class="token number">9</span>.0M  <span class="token number">3</span>.9G   <span class="token number">1</span>% /run
tmpfs                   tmpfs     <span class="token number">3</span>.9G     <span class="token number">0</span>  <span class="token number">3</span>.9G   <span class="token number">0</span>% /sys/fs/cgroup
/dev/mapper/centos-root xfs        49G  <span class="token number">2</span>.2G   47G   <span class="token number">5</span>% /
/dev/sda1               xfs      1014M  184M  831M  <span class="token number">19</span>% /boot
tmpfs                   tmpfs     793M     <span class="token number">0</span>  793M   <span class="token number">0</span>% /run/user/0
/dev/mapper/ssd-ssd     xfs       200G   33M  200G   <span class="token number">1</span>% /ssd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="删除磁盘"><a class="markdownIt-Anchor" href="#删除磁盘"></a> 删除磁盘</h3>
<p>删除磁盘则是逆序操作。下面使删除挂载卷例子：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/fstab</span>
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span><span class="token comment"># umount /databases</span>
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span><span class="token comment"># yes | lvremove /dev/databases/databases</span>
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span><span class="token comment"># vgremove databases</span>
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span><span class="token comment"># pvremove /dev/sdb1</span>
<span class="token punctuation">[</span>root@k8s-248 ~<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload </span>
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart proc-fs-nfsd.mount</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="重启"><a class="markdownIt-Anchor" href="#重启"></a> 重启</h2>
<p>最后重启服务器，让改动生效：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># reboot</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1 id="高可用集群部署"><a class="markdownIt-Anchor" href="#高可用集群部署"></a> 高可用集群部署</h1>
<p>以部署三主节点高可用集群示例，系统为 CentOS 7，K8s 版本为 1.22.3。集群构架图如下：</p>
<p><img data-src="../../../images/%E9%9B%86%E7%BE%A4%E6%9E%84%E6%9E%B6%E5%9B%BE.png" alt="集群构架图" /></p>
<h2 id="kubeadm"><a class="markdownIt-Anchor" href="#kubeadm"></a> Kubeadm</h2>
<p>Kubeadm 是由志愿者开发的专门用于部署 K8s 的工具。自 K8s 1.14 版本以后，Kubeadm 项目已经正式宣布 GA（General Availability），可以在<a target="_blank" rel="noopener external nofollow noreferrer" href="https://kubernetes.io/zh/docs/setup/production-environment/tools/">官方文档</a>中查看详细的使用说明。</p>
<h3 id="kubeadm-init"><a class="markdownIt-Anchor" href="#kubeadm-init"></a> kubeadm init</h3>
<p>初始化的大致过程如下：</p>
<ol>
<li>kubeadm 执行初始化检查。</li>
<li>生成 token 和证书。</li>
<li>生成 KubeConfig 文件，kubelet 需要使用该文件与 Master 进行通信。</li>
<li>安装 Master 组件，从镜像仓库下载组件和 Docker 镜像。</li>
<li>安装附加组件 kube-proxy 和 kube-dns。</li>
<li>Kubernetes Master 初始化成功。</li>
<li>提示如何配置 kubectl，安装 pod 网络，以及其他节点注册到集群的方法。</li>
</ol>
<p>执行 <code>kubeadm init</code> 指令后，kubeadm 首先会进行一系列的检查工作，以确定本机是否适用于部署 K8s。这一步的检查被称为 Preflight Checks，其主要目的是检查内核版本、CGroups 模块、kubelet 版本、网络端口等必要的配置是否正确。</p>
<p>默认情况下，与 API 服务器的通信必须使用 HTTPS 方式，因此需要证书文件。在完成系统检查后，kubeadm 开始生成 K8s 对外提供服务所需的各种证书和目录。kubeadm 生成的证书存放在主节点的 <code>/etc/kubernetes/pki/</code> 目录下，其中最重要的文件是 <code>ca.crt</code> 和 <code>ca.key</code>。也可以将现有的证书复制到证书目录中，这样 kubeadm 就不会生成证书：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">ls</span> /etc/kubernetes/pki
apiserver.crt              apiserver.key                 ca.crt  front-proxy-ca.crt      front-proxy-client.key
apiserver-etcd-client.crt  apiserver-kubelet-client.crt  ca.key  front-proxy-ca.key      sa.key
apiserver-etcd-client.key  apiserver-kubelet-client.key  etcd    front-proxy-client.crt  sa.pub<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>生成证书之后，kubeadm 接下来会创建用于访问 API 服务器的配置文件，并存放在 <code>/etc/kubernetes/</code> 目录下。这些文件记录了主节点的服务器地址、端口和证书位置等信息，客户端可以直接使用这些信息：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">ls</span> /etc/kubernetes/
admin.conf  controller-manager.conf  kubeadm-master.config  kubelet.conf  manifests  pki  scheduler.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>随后，kubeadm 会为 Master 组件生成 pod 的配置文件，并以静态 pod 的形式运行。这种容器启动的方式允许将要部署的 pod 的 YAML 文件放在一起，当 Kubelet 启动时，会自动加载这些文件并启动 pod。这些配置文件默认存放在 <code>/etc/kubernetes/manifests/</code> 目录下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ ll /etc/kubernetes/manifests/
total <span class="token number">16</span>
-rw------- <span class="token number">1</span> root root <span class="token number">2258</span> Apr <span class="token number">20</span> <span class="token number">22</span>:19 etcd.yaml
-rw------- <span class="token number">1</span> root root <span class="token number">3424</span> Apr <span class="token number">20</span> <span class="token number">22</span>:29 kube-apiserver.yaml
-rw------- <span class="token number">1</span> root root <span class="token number">2906</span> Apr <span class="token number">20</span> <span class="token number">22</span>:30 kube-controller-manager.yaml
-rw------- <span class="token number">1</span> root root <span class="token number">1492</span> Apr <span class="token number">20</span> <span class="token number">22</span>:30 kube-scheduler.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，kubeadm 会为集群生成一个用于加入集群的 bootstrap token。其他证书等信息通过 ConfigMap 的方式保存在 etcd 中。</p>
<p>最后是安装默认插件，包括 kube-proxy 和 DNS 插件，用于提供整个集群的服务发现和 DNS 功能。</p>
<h3 id="kubeadm-join"><a class="markdownIt-Anchor" href="#kubeadm-join"></a> kubeadm join</h3>
<p>加入集群时，需要使用主节点初始化时生成的令牌（token），该令牌用于进行一次性身份验证。工作节点在获取 ConfigMap 中的证书后，将使用证书进行安全通信。</p>
<h2 id="安装组件"><a class="markdownIt-Anchor" href="#安装组件"></a> 安装组件</h2>
<p>kubelet 是唯一没有以容器形式运行的 K8s 组件，它通过 systemd 服务运行。kubeadm 用来创建 K8s 集群，kubectl 是用来执行 K8s 命令的工具。其他 K8s 的系统组件都以容器化运行，并被放到 kube-system namespaces 中，例如 coredns、etcd、apiserver、controller-manager。</p>
<p>在所有要加入 K8s 集群的主机中安装 kubelet、kubeadm 和 kubectl 1.22.3 版本：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># tee /etc/yum.repos.d/kubernetes.repo&lt;&lt;EOF</span>
<span class="token punctuation">[</span>kubernetes<span class="token punctuation">]</span>
<span class="token assign-left variable">name</span><span class="token operator">=</span>Kubernetes
<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">repo_gpgcheck</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y kubelet-1.22.3 kubeadm-1.22.3 kubectl-1.22.3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改 Kubelet 配置文件，设置 cgroup 驱动为 systemd，镜像 pause 使用阿里云的源，然后启动 Kubelet：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># tee /etc/sysconfig/kubelet&lt;&lt;EOF</span>
<span class="token assign-left variable">KUBELET_EXTRA_ARGS</span><span class="token operator">=</span><span class="token string">"--cgroup-driver=systemd --runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.2"</span>
EOF
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now kubelet</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="主节点配置"><a class="markdownIt-Anchor" href="#主节点配置"></a> 主节点配置</h2>
<p>主节点上部署 HAproxy 和 keepalived 来保证主节点高可用。</p>
<h3 id="部署-haproxy"><a class="markdownIt-Anchor" href="#部署-haproxy"></a> 部署 HAproxy</h3>
<p>HAproxy 提供高可用性、负载均衡、基于 TCP 和 HTTP 的代理，支持数以万记的并发连接。此处 HAproxy 为 apiserver 提供反向代理，HAproxy 将所有请求轮询转发到每个 master 节点上。</p>
<p>在所有主节点上安装 HAproxy：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y haproxy</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>HAproxy 的配置文件内容相同，前台监听 16443 端口，转发请求到后台 6443 端口上。主要是设置 <code>backend kubernetes-apiserver</code> 中 server 的地址列表，负载均衡模式 <code>balance</code> 默认为轮询的负载算法 roundrobin：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># tee /etc/haproxy/haproxy.cfg&lt;&lt;EOF</span>
<span class="token comment">#---------------------------------------------------------------------</span>
<span class="token comment"># Global settings</span>
<span class="token comment">#---------------------------------------------------------------------</span>
global
    log         <span class="token number">127.0</span>.0.1 local2

    <span class="token function">chroot</span>      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     <span class="token number">4000</span>
    user        haproxy
    group       haproxy
    daemon

    stats socket /var/lib/haproxy/stats

<span class="token comment">#---------------------------------------------------------------------</span>
<span class="token comment"># common defaults that all the 'listen' and 'backend' sections will</span>
<span class="token comment"># use if not designated in their block</span>
<span class="token comment">#---------------------------------------------------------------------</span>
defaults
    mode                    http
    log                     global
    option                  httplog
    option                  dontlognull
    option http-server-close
    option forwardfor       except <span class="token number">127.0</span>.0.0/8
    option                  redispatch
    retries                 <span class="token number">3</span>
    <span class="token function">timeout</span> http-request    10s
    <span class="token function">timeout</span> queue           1m
    <span class="token function">timeout</span> connect         10s
    <span class="token function">timeout</span> client          1m
    <span class="token function">timeout</span> server          1m
    <span class="token function">timeout</span> http-keep-alive 10s
    <span class="token function">timeout</span> check           10s
    maxconn                 <span class="token number">3000</span>

<span class="token comment">#---------------------------------------------------------------------</span>
<span class="token comment"># kubernetes apiserver frontend which proxys to the backends</span>
<span class="token comment">#---------------------------------------------------------------------</span>
frontend kubernetes-apiserver
    mode                 tcp
    <span class="token builtin class-name">bind</span>                 *:16443
    option               tcplog
    default_backend      kubernetes-apiserver

<span class="token comment">#---------------------------------------------------------------------</span>
<span class="token comment"># round robin balancing between the various backends</span>
<span class="token comment">#---------------------------------------------------------------------</span>
backend kubernetes-apiserver
    mode        tcp
    balance     roundrobin
    server  k8s-101 <span class="token number">192.168</span>.1.101:6443 check
    server  k8s-102 <span class="token number">192.168</span>.1.102:6443 check
    server  k8s-103 <span class="token number">192.168</span>.1.103:6443 check

<span class="token comment">#---------------------------------------------------------------------</span>
<span class="token comment"># collection haproxy statistics message</span>
<span class="token comment">#---------------------------------------------------------------------</span>
listen stats
    <span class="token builtin class-name">bind</span>                 *:10001
    stats auth           admin:4we50meP455w0rd
    stats refresh        5s
    stats realm          HAProxy<span class="token punctuation">\</span> Statistics
    stats uri            /
EOF<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动后服务后，在浏览器访问任意一台主节点 10001 端口来查询状态。登录使用配置文件中的账号 <code>admin</code> 密码 <code>4we50meP455w0rd</code>：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now haproxy.service</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># systemctl status haproxy</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># netstat -ntulp |grep "16443\|10001"</span>
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:10001           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">28052</span>/haproxy       
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:16443           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">28052</span>/haproxy    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="部署-keepalived"><a class="markdownIt-Anchor" href="#部署-keepalived"></a> 部署 keepalived</h3>
<p>keepalived 以 VRRP（虚拟路由冗余协议）协议为基础，包括一个 master 和多个 backup。master 劫持 VIP 对外提供服务。master 发送组播，backup 节点收不到 VRRP 包时认为 master 宕机，此时选出剩余优先级最高的节点作为新 master 劫持 VIP。</p>
<p>此处的 keepalived 的主要作用是为 haproxy 提供 VIP（192.168.1.253）。在 3 个 HAProxy 实例之间提供主备，降低当其中一个 HAProxy 失效时对服务的影响。</p>
<p>先在所有主节点上安装 keepalived：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># yum -y install keepalived psmisc</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>选主节点 k8s-101 作为 keepalived 的 <code>MASTER</code> ，配置文件内容如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/keepalived/keepalived.conf</span>
global_defs <span class="token punctuation">&#123;</span>
    router_id LVS_DEVEL
    script_user root
    enable_script_security
<span class="token punctuation">&#125;</span>
vrrp_script check_haproxy <span class="token punctuation">&#123;</span>
script <span class="token string">"/bin/bash -c 'if [[ <span class="token variable"><span class="token variable">$(</span><span class="token function">netstat</span> <span class="token parameter variable">-nlp</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">16443</span><span class="token variable">)</span></span> ]]; then exit 0; else exit 1; fi'"</span>
interval <span class="token number">2</span>
weight <span class="token parameter variable">-11</span>
<span class="token punctuation">&#125;</span>
vrrp_instance VI_1 <span class="token punctuation">&#123;</span>
    state MASTER
    interface ens32
    virtual_router_id <span class="token number">51</span>
    priority <span class="token number">100</span>
    advert_int <span class="token number">1</span>
    authentication <span class="token punctuation">&#123;</span>
        auth_type PASS
        auth_pass 2G4phJHIK27jPXq2HJs4BG
    <span class="token punctuation">&#125;</span>
    virtual_ipaddress <span class="token punctuation">&#123;</span>
        <span class="token number">192.168</span>.1.253
    <span class="token punctuation">&#125;</span>
track_script <span class="token punctuation">&#123;</span>
check_haproxy
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其他节点的配置修改 <code>vrrp_instance VI_1</code> 中角色 <code>state</code> 为 <code>BACKUP</code>，优先级 <code>priority</code> 为 90：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-102 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/keepalived/keepalived.conf</span>
global_defs <span class="token punctuation">&#123;</span>
    router_id LVS_DEVEL
    script_user root
    enable_script_security
<span class="token punctuation">&#125;</span>
vrrp_script check_haproxy <span class="token punctuation">&#123;</span>
script <span class="token string">"/bin/bash -c 'if [[ <span class="token variable"><span class="token variable">$(</span><span class="token function">netstat</span> <span class="token parameter variable">-nlp</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">16443</span><span class="token variable">)</span></span> ]]; then exit 0; else exit 1; fi'"</span>
interval <span class="token number">2</span>
weight <span class="token parameter variable">-11</span>
<span class="token punctuation">&#125;</span>
vrrp_instance VI_1 <span class="token punctuation">&#123;</span>
    state BACKUP
    interface ens32
    virtual_router_id <span class="token number">51</span>
    priority <span class="token number">90</span>
    advert_int <span class="token number">1</span>
    authentication <span class="token punctuation">&#123;</span>
        auth_type PASS
        auth_pass 2G4phJHIK27jPXq2HJs4BG
    <span class="token punctuation">&#125;</span>
    virtual_ipaddress <span class="token punctuation">&#123;</span>
        <span class="token number">192.168</span>.1.253
    <span class="token punctuation">&#125;</span>
track_script <span class="token punctuation">&#123;</span>
check_haproxy
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置文件中主要配置项有：</p>
<ul>
<li><code>vrrp_script check_haproxy&#123;&#125;</code>：检测 HAProxy 进程是否存活脚本。每 2 秒检测本地 HAProxy 监听端口 16443。如果端口没响应，优先级分数会被减去 11，VIP 地址会转移到更高优先级的节点。</li>
<li><code>state MASTER</code>：指定节点角色。</li>
<li><code>interface ens32</code>：指定 VIP 地址绑定网卡名称。</li>
<li><code>virtual_router_id 51</code>：虚拟路由组的 ID。</li>
<li><code>priority 100</code>：节点优先级。</li>
<li><code>authentication</code>：节点之间认证密码。</li>
<li><code>virtual_ipaddress&#123;&#125;</code>：VIP 虚拟 IP 地址。</li>
</ul>
<p>配置好后，在所有主节点启动服务：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now keepalived.service</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>注意，重启网络服务后，必须连带重启 <code>keepalived</code> 服务，否则 VIP 地址会失效。</p>
<h3 id="测试故障转移"><a class="markdownIt-Anchor" href="#测试故障转移"></a> 测试故障转移</h3>
<p>使用 <code>ip a s</code> 查看当前 VIP 绑定的主机，并在停止绑定主机上停止 keepalived 或 HAproxy 服务后，观察 VIP 的漂移：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># ip a s</span>
<span class="token number">2</span>: ens32: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="token number">1000</span>
    link/ether 00:0c:29:f3:57:42 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">192.168</span>.1.101/24 brd <span class="token number">192.168</span>.1.255 scope global noprefixroute ens32
       valid_lft forever preferred_lft forever
    inet <span class="token number">192.168</span>.1.253/32 scope global ens32
       valid_lft forever preferred_lft forever
    inet6 fe80::e99f:f473:5c6b:60e9/64 scope <span class="token function">link</span> noprefixroute 
       valid_lft forever preferred_lft forever
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># systemctl stop haproxy</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># netstat -ntulp |grep 16443</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># ip a s</span>
<span class="token number">2</span>: ens32: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="token number">1000</span>
    link/ether 00:0c:29:f3:57:42 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">192.168</span>.1.101/24 brd <span class="token number">192.168</span>.1.255 scope global noprefixroute ens32
       valid_lft forever preferred_lft forever
    inet6 fe80::e99f:f473:5c6b:60e9/64 scope <span class="token function">link</span> noprefixroute 
       valid_lft forever preferred_lft forever<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 k8s-101 上关闭 HAProxy 服务后，VIP 地址已经转移到别的节点上面。即使 k8s-101 节点重新启动也不会转移回去：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-103 ~<span class="token punctuation">]</span><span class="token comment"># ip a s</span>
<span class="token number">2</span>: ens32: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="token number">1000</span>
    link/ether 00:50:56:22:32:88 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">192.168</span>.1.103/24 brd <span class="token number">192.168</span>.1.255 scope global noprefixroute ens32
       valid_lft forever preferred_lft forever
    inet <span class="token number">192.168</span>.1.253/32 scope global ens32
       valid_lft forever preferred_lft forever
    inet6 fe80::2526:9131:23cc:8de8/64 scope <span class="token function">link</span> noprefixroute 
       valid_lft forever preferred_lft forever<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="建立集群"><a class="markdownIt-Anchor" href="#建立集群"></a> 建立集群</h2>
<p>为了组成高可用集群，至少需要 3 个主节点，否则会出现脑裂现象。</p>
<h3 id="初始化主节点"><a class="markdownIt-Anchor" href="#初始化主节点"></a> 初始化主节点</h3>
<p>采用 kubeadm 来部署集群，首先需要初始化一个主节点。</p>
<p>可以生成默认的 <code>kubeadm-master.config</code> 配置文件，并在修改后指定使用该配置运行命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm config print init-defaults > /etc/kubernetes/kubeadm-master.config</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm init --config=/etc/kubernetes/kubeadm-master.config --upload-certs</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>或者，可以使用指定的参数来初始化主节点：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm init --apiserver-advertise-address=192.168.1.101 --image-repository=registry.aliyuncs.com/google_containers --kubernetes-version=v1.22.3 --service-cidr=10.96.0.0/12 --pod-network-cidr=10.244.0.0/16</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>常见参数配置说明如下：</p>
<ul>
<li><code>--apiserver-advertise-address</code>：第一个主节点的 IP 地址，一般为内网地址。</li>
<li><code>--image-repository</code>：设置镜像仓库地址。</li>
<li><code>--kubernetes-version</code>：设置 Kubernetes 版本。版本高于 1.23 无法使用 Docker 容器运行时。</li>
<li><code>--service-cidr</code>：设置服务器通信使用的 IP 网段。默认为 <code>10.96.0.0/12</code></li>
<li><code>--pod-network-cidr</code>：设置内部的 Pod 节点之间网络可以使用的 IP 段。对于使用不同的网络插件，默认值有所不同。常见的网络插件默认值配置如下：
<ul>
<li>Calico 网络插件：默认为 <code>192.168.0.0/16</code>。</li>
<li>Flannel 网络插件：默认为 <code>10.244.0.0/16</code>。</li>
<li>Weave 网络插件：默认为 <code>10.32.0.0/12</code>。</li>
</ul>
</li>
<li><code>--upload-certs</code>：上传证书到 <code>kubeadm-certs</code> Secret。</li>
<li><code>--control-plane-endpoint</code>：设置控制节点主机地址。</li>
</ul>
<p>下面使用声明的变量来生成配置：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># export APISERVER_ADVERTISE_ADDRESS=192.168.1.101</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># export KUBERNETES_VERSION=v1.22.3</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># export SERVICE_CIDR=10.96.0.0/16</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># export POD_NETWORK_CIDR=10.244.0.1/16</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># export CONTROL_PLANE_ENDPOINT=192.168.1.253:16443</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /hxz393/local/k8s/config/</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># cat &lt;&lt;EOF > /hxz393/local/k8s/config/kubeadm-config.yaml</span>
apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
kubernetesVersion: <span class="token string">"<span class="token variable">$&#123;KUBERNETES_VERSION&#125;</span>"</span>
imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers
controlPlaneEndpoint: <span class="token string">"<span class="token variable">$&#123;CONTROL_PLANE_ENDPOINT&#125;</span>"</span>
networking:
  serviceSubnet: <span class="token string">"<span class="token variable">$&#123;SERVICE_CIDR&#125;</span>"</span>
  podSubnet: <span class="token string">"<span class="token variable">$&#123;POD_NETWORK_CIDR&#125;</span>"</span>
  dnsDomain: <span class="token string">"cluster.local"</span>
EOF
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm init --config=/hxz393/local/k8s/config/kubeadm-config.yaml --upload-certs</span>
Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span>

To start using your cluster, you need to run the following as a regular user:

  <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

Alternatively, <span class="token keyword">if</span> you are the root user, you can run:

  <span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now <span class="token function">join</span> any number of the control-plane <span class="token function">node</span> running the following <span class="token builtin class-name">command</span> on each as root:

  kubeadm <span class="token function">join</span> k8s-250:6443 <span class="token parameter variable">--token</span> 66e1on.yh84w71x6mauu6em <span class="token punctuation">\</span>
        --discovery-token-ca-cert-hash sha256:5849bdad8508feeb3b40e634f7c97f074eb79705d365d097ee75a44374545715 <span class="token punctuation">\</span>
        --control-plane --certificate-key 337bb228b52a88c297d72102652834aeef9666b847247b2b17471a78236af909

Please note that the certificate-key gives access to cluster sensitive data, keep it secret<span class="token operator">!</span>
As a safeguard, uploaded-certs will be deleted <span class="token keyword">in</span> two hours<span class="token punctuation">;</span> If necessary, you can use
<span class="token string">"kubeadm init phase upload-certs --upload-certs"</span> to reload certs afterward.

Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:

kubeadm <span class="token function">join</span> k8s-250:6443 <span class="token parameter variable">--token</span> 66e1on.yh84w71x6mauu6em <span class="token punctuation">\</span>
        --discovery-token-ca-cert-hash sha256:5849bdad8508feeb3b40e634f7c97f074eb79705d365d097ee75a44374545715 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面是主节点搭建成功后，输出后续操作提示。如果因为拉取镜像时间太长导致失败，可以用下面命令提前拉取镜像：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm config images pull --image-repository=registry.aliyuncs.com/google_containers</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="配置-kubectl"><a class="markdownIt-Anchor" href="#配置-kubectl"></a> 配置 Kubectl</h3>
<p>按照提示，将变量声明写入到 <code>.bashrc</code> 中：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># echo "export KUBECONFIG=/etc/kubernetes/admin.conf" >>~/.bashrc</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>或者，将 <code>admin.conf</code> 放入 <code>$HOME/.kube</code> 目录中，才能使用 <code>kubectl</code> 命令操作集群：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p $HOME/.kube &amp;&amp; cp -i /etc/kubernetes/admin.conf $HOME/.kube/config &amp;&amp; cp -i /etc/kubernetes/admin.conf /hxz393/local/k8s/config/admin.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>同样地，可以将 <code>admin.conf</code> 放入其他用户的家目录或其他主机上，以赋予其集群管理权限。请注意修改配置文件的所有者和权限：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">scp</span> /etc/kubernetes/admin.conf shareuser@192.168.1.248:/home/shareuser/.kube/config
<span class="token punctuation">[</span>root@k8s-248 ~<span class="token punctuation">]</span>$ <span class="token function">chown</span> <span class="token parameter variable">-R</span> shareuser:shareuser /home/shareuser/.kube
<span class="token punctuation">[</span>root@k8s-248 ~<span class="token punctuation">]</span>$ <span class="token function">chmod</span> <span class="token parameter variable">-R</span> <span class="token number">755</span> /home/shareuser/.kube<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>配置 <code>kubectl</code> 命令的自动补全：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># echo "source &lt;(kubectl completion bash)" >>~/.bashrc</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># source ~/.bashrc</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="部署网络"><a class="markdownIt-Anchor" href="#部署网络"></a> 部署网络</h3>
<p>可以选择安装高性能的 Underlay 网络，如 Flannel 或 Calico。只能安装其中一种网络。</p>
<ul>
<li>
<p><strong>Flannel</strong></p>
<p>官方网站提供的安装 Flannel 网络：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml</span>
Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="token keyword">in</span> v1.21+, unavailable <span class="token keyword">in</span> v1.25+
podsecuritypolicy.policy/psp.flannel.unprivileged created
clusterrole.rbac.authorization.k8s.io/flannel created
clusterrolebinding.rbac.authorization.k8s.io/flannel created
serviceaccount/flannel created
configmap/kube-flannel-cfg created
daemonset.apps/kube-flannel-ds created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于 <code>githubusercontent.com</code> 经常连接不通，可以手动将 <code>kube-flannel.yml</code> 下载下来后部署：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f /hxz393/local/k8s/apply/kube-flannel.yml</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>
<p><strong>Calico</strong></p>
<p>使用以下方式安装 Calico 网络：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># wget https://kuboard.cn/install-script/calico/calico-3.9.2.yaml</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># sed -i "s#192\.168\.0\.0/16#$&#123;pod_SUBNET&#125;#" calico-3.9.2.yaml</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f calico-3.9.2.yaml</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>根据官方网站提供的安装方式：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f https://docs.projectcalico.org/manifests/tigera-operator.yaml</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f https://docs.projectcalico.org/manifests/custom-resources.yaml</span>
installation.operator.tigera.io/default created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h3 id="完成部署"><a class="markdownIt-Anchor" href="#完成部署"></a> 完成部署</h3>
<p>等待网络部署完成，所有 8 个容器都部署完毕后，主节点就搭建好了：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-system -o wide --watch</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># journalctl -u kubelet -f</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>添加 Node 标签，其中 NodeRole 角色名可以是 master（主节点）或 worker（从节点）。NodeName 是主机名，NodeEnv 可以是 base（基础服务）或 app（应用）：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl label node k8s-101 NodeRole=master</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl label node k8s-101 NodeName=k8s-101</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl label node k8s-101 NodeEnv=local</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="加入集群"><a class="markdownIt-Anchor" href="#加入集群"></a> 加入集群</h2>
<p>加入集群按照以下步骤进行操作。加入失败时，可以在加入命令加上 <code>--v=5</code> 来显示详细错误日志。</p>
<h3 id="获取参数"><a class="markdownIt-Anchor" href="#获取参数"></a> 获取参数</h3>
<p>加入集群所需的 3 个参数如下：</p>
<ul>
<li>
<p><strong>Token</strong></p>
<p>token 的有效期为 1 天。在失效后，可以使用 <code>kubeadm token create</code> 命令重新创建：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm token create</span>
xjp771.yrjc4oe1thjjt112
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm token list</span>
TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA <span class="token environment constant">GROUPS</span>
xjp771.yrjc4oe1thjjt112   23h         <span class="token number">2022</span>-04-21T02:14:35Z   authentication,signing   <span class="token operator">&lt;</span>none<span class="token operator">></span>                                                     system:bootstrappers:kubeadm:default-node-token<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p><strong>Discovery Token CA Cert Hash</strong></p>
<p>获得 discovery-token-ca-cert-hash 参数的方法如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'</span>
1499ca908be1d430887b67d4dbfff06a5374cf3d340d3c0ba9db1aa51ad9ddfb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p><strong>Certificate Key</strong></p>
<p>直接更新证书来获取 certificate-key 参数：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm init phase upload-certs --upload-certs</span>
I0420 <span class="token number">10</span>:15:58.086168    <span class="token number">6701</span> version.go:255<span class="token punctuation">]</span> remote version is much newer: v1.23.5<span class="token punctuation">;</span> falling back to: stable-1.22
<span class="token punctuation">[</span>upload-certs<span class="token punctuation">]</span> Storing the certificates <span class="token keyword">in</span> Secret <span class="token string">"kubeadm-certs"</span> <span class="token keyword">in</span> the <span class="token string">"kube-system"</span> Namespace
<span class="token punctuation">[</span>upload-certs<span class="token punctuation">]</span> Using certificate key:
937bf7194bd6e346e177f3a64de9ec01e9043828cb263f0ed80bddc359a351e2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h3 id="加入从节点"><a class="markdownIt-Anchor" href="#加入从节点"></a> 加入从节点</h3>
<p>加入从节点只需要使用 <code>token</code> 和 <code>discovery-token-ca-cert-hash</code> 参数。指定集群的 Control Plane 地址（192.168.1.253:16443）或单个主节点的 IP 地址加端口号 6443（192.168.1.101:6443），并使用 <code>kubeadm join</code> 命令将从节点加入集群：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># echo "192.168.1.101   k8s-101" >> /etc/hosts</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm join k8s-101:6443 --token xjp771.yrjc4oe1thjjt112 --discovery-token-ca-cert-hash sha256:1499ca908be1d430887b67d4dbfff06a5374cf3d340d3c0ba9db1aa51ad9ddfb</span>
This <span class="token function">node</span> has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run <span class="token string">'kubectl get nodes'</span> on the control-plane to see this <span class="token function">node</span> <span class="token function">join</span> the cluster.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>加入成功后，在主节点给新节点标签：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl label node k8s-104 NodeRole=worker</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl label node k8s-104 NodeName=k8s-104</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl label node k8s-104 NodeEnv=local</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl label node k8s-104 node-role.kubernetes.io/worker=app</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="加入主节点"><a class="markdownIt-Anchor" href="#加入主节点"></a> 加入主节点</h3>
<p>加入主节点的步骤与加入从节点类似，多需要提供一个 <code>--certificate-key</code> 参数：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># echo "192.168.1.101   k8s-101" >> /etc/hosts</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm join k8s-101:644 --token 4sz9hf.dwt05n1ohpb772au \</span>
        --discovery-token-ca-cert-hash sha256:864ee6f29ac83d7ec0db3e75c2b54a70ac7622c8c82e52cc71511255febf5b28 <span class="token punctuation">\</span>
        --control-plane --certificate-key af928d1032d723ae3f16c7218b07afb41b4d588d746bbeb6ed9c657a460591cd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>添加集群控制权限：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p $HOME/.kube &amp;&amp; cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># echo "source &lt;(kubectl completion bash)" >>~/.bashrc</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># source ~/.bashrc</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>添加节点标签：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl label node k8s-249 NodeRole=master</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl label node k8s-249 NodeName=k8s-249</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl label node k8s-249 NodeEnv=base</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="等待完成"><a class="markdownIt-Anchor" href="#等待完成"></a> 等待完成</h3>
<p>查看已加入的节点：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get node</span>
NAME      STATUS     ROLES                  AGE   VERSION
k8s-101   Ready      control-plane,master   25m   v1.22.3
k8s-104   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">></span>                 95s   v1.22.3
k8s-105   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">></span>                 95s   v1.22.3
k8s-106   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">></span>                 87s   v1.22.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 <code>--all-namespaces</code> 参数来查看所有节点上的容器运行信息，确保所有的 Pod 都处于运行状态：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod --all-namespaces -o wide</span>
NAMESPACE     NAME                              READY   STATUS                  RESTARTS   AGE     IP              NODE      NOMINATED NODE   READINESS GATES
kube-system   coredns-7d89d9b6b8-6p4wt          <span class="token number">1</span>/1     Running                 <span class="token number">0</span>          26m     <span class="token number">10.244</span>.0.2      k8s-101   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   coredns-7d89d9b6b8-dd5h6          <span class="token number">1</span>/1     Running                 <span class="token number">0</span>          26m     <span class="token number">10.244</span>.0.3      k8s-101   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   etcd-k8s-101                      <span class="token number">1</span>/1     Running                 <span class="token number">0</span>          26m     <span class="token number">192.168</span>.1.101   k8s-101   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-apiserver-k8s-101            <span class="token number">1</span>/1     Running                 <span class="token number">0</span>          26m     <span class="token number">192.168</span>.1.101   k8s-101   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-controller-manager-k8s-101   <span class="token number">1</span>/1     Running                 <span class="token number">0</span>          26m     <span class="token number">192.168</span>.1.101   k8s-101   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-flannel-ds-bhck2             <span class="token number">1</span>/1     Running                 <span class="token number">0</span>          2m17s   <span class="token number">192.168</span>.1.105   k8s-105   <span class="token operator">&lt;</span>none<span class="token operator">></span> 
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get all --all-namespaces </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="移除节点"><a class="markdownIt-Anchor" href="#移除节点"></a> 移除节点</h2>
<p>如果您想从集群中移除节点，首先使用 <code>drain</code> 命令驱逐节点上运行的 Pod：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl drain k8s-249 --ignore-daemonsets
node/k8s-249 cordoned
WARNING: ignoring DaemonSet-managed Pods: kube-system/kube-flannel-ds-8rfqm, kube-system/kube-proxy-qnxcw
evicting pod base/zookeeper-2
evicting pod base/zookeeper-0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在所有的 Pod 转移完成后，可以运行以下命令删除节点（主节点还需要手动修改 <code>etcd</code> 数据库）：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl delete <span class="token function">node</span> k8s-249
<span class="token function">node</span> <span class="token string">"k8s-249"</span> deleted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>最后在要移除的节点上运行以下命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ <span class="token function">yes</span> <span class="token operator">|</span> kubeadm reset
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ <span class="token function">rm</span> <span class="token parameter variable">-rf</span> /var/lib/cni/ /etc/cni/net.d <span class="token environment constant">$HOME</span>/.kube/config /var/lib/etcd
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ <span class="token function">ifconfig</span> cni0 down
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ <span class="token function">ip</span> <span class="token function">link</span> delete cni0
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ <span class="token function">ifconfig</span> flannel.1 down
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ <span class="token function">ip</span> <span class="token function">link</span> delete flannel.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="节点配置"><a class="markdownIt-Anchor" href="#节点配置"></a> 节点配置</h2>
<p>安装完毕后还需要做一些配置修改和初始化工作。</p>
<h3 id="主节点配置-2"><a class="markdownIt-Anchor" href="#主节点配置-2"></a> 主节点配置</h3>
<p>开发环境下，为了允许在主节点上部署应用程序，需要移除主节点上的污点（去除 <code>taint</code> 命令最后的减号 <code>-</code> 则是重新加入污点）：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl taint nodes --all node-role.kubernetes.io/master=true:NoSchedule-</span>
node/k8s-101 untainted
node/k8s-102 untainted
node/k8s-103 untainted
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get no -o yaml | grep taint -A 5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改 <code>NodePort</code> 端口范围为无限制。在 <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> 文件中加入一行配置 <code>- --service-node-port-range=1-65535</code> ，配置会自动更新:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># sed -i '40a\    - --service-node-port-range=1-65535' /etc/kubernetes/manifests/kube-apiserver.yaml</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/kubernetes/manifests/kube-apiserver.yaml</span>
    - --tls-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.crt
    - --tls-private-key-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.key
    - --service-node-port-range<span class="token operator">=</span><span class="token number">1</span>-65535
    image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.3
    imagePullPolicy: IfNotPresent<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注释掉 <code>/etc/kubernetes/manifests/kube-controller-manager.yaml</code> 和 <code>/etc/kubernetes/manifests/kube-scheduler.yaml</code> 文件中的端口绑定，免得健康检查一直报错：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># sed -i "s/    - --port=0/#    - --port=0/g" /etc/kubernetes/manifests/kube-controller-manager.yaml</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># sed -i "s/    - --port=0/#    - --port=0/g" /etc/kubernetes/manifests/kube-scheduler.yaml</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># sed -i "s/    - --bind-address=127.0.0.1/    - --bind-address=0.0.0.0/g" /etc/kubernetes/manifests/kube-controller-manager.yaml</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># sed -i "s/    - --bind-address=127.0.0.1/    - --bind-address=0.0.0.0/g" /etc/kubernetes/manifests/kube-scheduler.yaml</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart kubelet.service</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get cs</span>
Warning: v1 ComponentStatus is deprecated <span class="token keyword">in</span> v1.19+
NAME                 STATUS    MESSAGE                         ERROR
scheduler            Healthy   ok                              
controller-manager   Healthy   ok                              
etcd-0               Healthy   <span class="token punctuation">&#123;</span><span class="token string">"health"</span><span class="token builtin class-name">:</span><span class="token string">"true"</span>,<span class="token string">"reason"</span><span class="token builtin class-name">:</span><span class="token string">""</span><span class="token punctuation">&#125;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改节点预留服务器资源，预留 1 核 CPU 加 1 GB 内存：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># sed -i '38a\systemReserved:\n  cpu: "500m"\n  memory: "500Mi"\nkubeReserved:\n  cpu: "500m"\n  memory: "500Mi"' /var/lib/kubelet/config.yaml</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart kubelet.service</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="从节点配置"><a class="markdownIt-Anchor" href="#从节点配置"></a> 从节点配置</h3>
<p>修改节点预留服务器资源:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-104 ~<span class="token punctuation">]</span><span class="token comment"># sed -i '38a\systemReserved:\n  cpu: "500m"\n  memory: "500Mi"\nkubeReserved:\n  cpu: "500m"\n  memory: "500Mi"' /var/lib/kubelet/config.yaml</span>
<span class="token punctuation">[</span>root@k8s-104 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart kubelet.service</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="集群配置"><a class="markdownIt-Anchor" href="#集群配置"></a> 集群配置</h2>
<p>以下是一些常见的配置项目。</p>
<h3 id="建立命名空间"><a class="markdownIt-Anchor" href="#建立命名空间"></a> 建立命名空间</h3>
<p>可依据需要建立多命名空间，来区分不同的环境。例如：用 <code>dev</code> 表示开发环境、用 <code>test</code> 表示测试环境、用 <code>base</code> 表示基础服务环境：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># tee /hxz393/local/k8s/apply/kube-namespaces.yml&lt;&lt;EOF</span>
apiVersion: v1
kind: Namespace
metadata:
  name: <span class="token builtin class-name">local</span>
EOF
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f /hxz393/local/k8s/apply/kube-namespaces.yml</span>
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get namespaces </span>
NAME              STATUS   AGE
default           Active   69m
kube-node-lease   Active   69m
kube-public       Active   69m
kube-system       Active   69m
<span class="token builtin class-name">local</span>             Active   23m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="绑定权限"><a class="markdownIt-Anchor" href="#绑定权限"></a> 绑定权限</h3>
<p>有时为了测试目的，需要将集群管理员角色绑定到对应命名空间默认 <code>sa</code>（service account）账号上。这样默认命名空间中应用可以访问其他命名空间的资源：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># tee /nanruan/test/k8s/apply/kube-crb.yml&lt;&lt;EOF</span>
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: test-crb
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: default
  namespace: <span class="token builtin class-name">local</span>
EOF
<span class="token punctuation">[</span>root@k8s-101 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f /nanruan/test/k8s/apply/test-crb.yml</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="阿里云部署"><a class="markdownIt-Anchor" href="#阿里云部署"></a> 阿里云部署</h2>
<p>在阿里云上部署 Kubernetes 时，ECS 不支持自建 VIP。但将 SLB 的 VIP 指定为高可用地址时，初始化主节点会失败。这是因为 4 层 SLB 不支持其调度的后端服务器访问其 VIP，也就是服务器不能同时充当服务端和客户端。</p>
<p>解决方法如下：</p>
<ul>
<li>在从节点部署 <code>HAProxy</code>，并监听 <code>16443</code> 端口，后端服务器指向主节点 <code>6443</code> 端口。</li>
<li>在 CLB（传统型负载均衡，原 SLB）上新建虚拟服务器组 <code>k8s-haproxy</code>，将安装有 <code>HAProxy</code> 的从节点加进去，监听端口为 <code>16443</code>。</li>
<li>在监听页新建监听配置 <code>k8s_haproxy</code>，选择监听 <code>TCP/6443</code> 端口，后端服务器选择虚拟服务器组 <code>k8s-haproxy</code>，开启健康检查，提交。</li>
<li>如果不需要通过外网来管理集群，可以修改监听 <code>k8s_haproxy</code> 的访问控制。例如添加内网 IP 地址段 <code>172.16.0.0/16</code> 到白名单，这样可以防止集群对外暴露。</li>
<li>在建立集群时，配置 <code>controlPlaneEndpoint</code> 的值为 <code>&lt;CLB内网IP地址&gt;:6443</code>。例如：<code>--control-plane-endpoint=172.16.17.100:6443</code>。</li>
<li>加入集群时，使用<code>controlPlaneEndpoint</code> 的值。例如：<code>kubeadm join 172.16.17.100:6443</code>。</li>
</ul>
<p>如果需要通过外网来管理集群，还需要在主节点上将 CLB 的外网 IP 地址更新进去，重新生成证书：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master1-pro ~<span class="token punctuation">]</span><span class="token comment"># mkdir -pv /opt/cert &amp;&amp; mv /etc/kubernetes/pki/apiserver.* /opt/cert</span>
<span class="token punctuation">[</span>root@k8s-master1-pro ~<span class="token punctuation">]</span><span class="token comment"># kubeadm init phase certs apiserver --apiserver-advertise-address 172.16.17.100 --apiserver-cert-extra-sans 110.112.110.102 --apiserver-cert-extra-sans 172.16.17.99 --apiserver-cert-extra-sans 80.114.163.80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>其他关于解决此问题的参考连接：</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.cnblogs.com/gmmy/p/12372805.html">https://www.cnblogs.com/gmmy/p/12372805.html</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.cnblogs.com/noah-luo/p/13218837.html">https://www.cnblogs.com/noah-luo/p/13218837.html</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://zhuanlan.zhihu.com/p/107703112">https://zhuanlan.zhihu.com/p/107703112</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.51cto.com/caiyuanji/2405434">https://blog.51cto.com/caiyuanji/2405434</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jianshu.com/p/ba94db1c3599">https://www.jianshu.com/p/ba94db1c3599</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/weixin_44334279/article/details/119355653">https://blog.csdn.net/weixin_44334279/article/details/119355653</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jianshu.com/p/d645bbe8e621">https://www.jianshu.com/p/d645bbe8e621</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.kubernetes.org.cn/7033.html">https://www.kubernetes.org.cn/7033.html</a></p>
<h1 id="集群升级"><a class="markdownIt-Anchor" href="#集群升级"></a> 集群升级</h1>
<p>整个集群升级需要分三步进行：</p>
<ul>
<li>第一步是主节点升级 <code>kubeadm</code> 和 <code>kubectl</code>。</li>
<li>第二步是主节点升级 <code>kubelet</code>。</li>
<li>第三步是从节点升级 <code>kubelet</code>。</li>
</ul>
<p>主节点升级 <code>kubeadm</code> 和 <code>kubectl</code> 不会对集群的运行产生影响：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ yum list <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'kubeadm\|kubectl\|kubelet'</span>
kubeadm.x86_64                           <span class="token number">1.22</span>.3-0                      @kubernetes
kubectl.x86_64                           <span class="token number">1.22</span>.3-0                      @kubernetes
kubelet.x86_64                           <span class="token number">1.22</span>.3-0                      @kubernetes
kubeadm.x86_64                           <span class="token number">1.23</span>.5-0                      kubernetes
kubectl.x86_64                           <span class="token number">1.23</span>.5-0                      kubernetes
kubelet.x86_64                           <span class="token number">1.23</span>.5-0                      kubernetes
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ yum <span class="token parameter variable">-y</span> <span class="token function">install</span> kubeadm-1.23.5-0 kubectl-1.23.5-0
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubeadm upgrade plan
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubeadm upgrade apply v1.23.5-0 <span class="token parameter variable">--config</span> /nanruan/base/k8s/kubeadm/kubeadm-config.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主节点和从节点升级 <code>kubelet</code> 的步骤是一样的。首先禁用调度，然后升级并重启 <code>kubelet</code>，最后恢复允许调度：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl drain k8s-250 --ignore-daemonsets
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ yum <span class="token parameter variable">-y</span> <span class="token function">install</span> kubelet-1.23.5-0
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ systemctl daemon-reload
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ systemctl restart kubelet
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ systemctl status kubelet
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl uncordon k8s-250
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl get nodes
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl get all --all-namespaces<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="故障处理"><a class="markdownIt-Anchor" href="#故障处理"></a> 故障处理</h1>
<p>一些集群组建时遇到的问题。</p>
<h2 id="没有-pod-network-cidr"><a class="markdownIt-Anchor" href="#没有-pod-network-cidr"></a> 没有 pod-network-cidr</h2>
<p>在安装 Flannel 时，出现错误提示缺少分配的 Pod CIDR。这可能是因为在使用 kubeadm 初始化时没有指定 <code>--pod-network-cidr</code> 参数，或者 <code>kube-flannel.yml</code> 文件中的 “Network” 字段与 <code>--pod-network-cidr</code> 参数不一致：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl logs <span class="token parameter variable">-n</span> kube-system kube-flannel-ds-7xp24 
I1103 04:42:22.796211       <span class="token number">1</span> vxlan.go:137<span class="token punctuation">]</span> VXLAN config: <span class="token assign-left variable">VNI</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">Port</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">GBP</span><span class="token operator">=</span>false <span class="token assign-left variable">Learning</span><span class="token operator">=</span>false <span class="token assign-left variable">DirectRouting</span><span class="token operator">=</span>false
E1103 04:42:22.797028       <span class="token number">1</span> main.go:325<span class="token punctuation">]</span> Error registering network: failed to acquire lease: <span class="token function">node</span> <span class="token string">"server4-master"</span> pod cidr not assigned
I1103 04:42:22.797248       <span class="token number">1</span> main.go:439<span class="token punctuation">]</span> Stopping shutdownHandler<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>要解决此问题，可以修改 <code>kube-controller-manager.yaml</code> 配置文件，在其中添加 <code>- --allocate-node-cidrs=true</code> 和 <code>- --cluster-cidr=10.244.0.0/16</code> 参数：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> /etc/kubernetes/manifests/kube-controller-manager.yaml
spec:
  containers:
  - command:
    - kube-controller-manager
    - --allocate-node-cidrs<span class="token operator">=</span>true
    - --cluster-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，删除错误的 Flannel 容器并重新创建，这样就可以使用正确的配置了：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl delete pod <span class="token parameter variable">-n</span> kube-system kube-flannel-*
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl cluster-info dump <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-m</span> <span class="token number">1</span> cluster-cidr
                            <span class="token string">"--cluster-cidr=10.244.0.0/16"</span>,<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="没有-controlplaneendpoint"><a class="markdownIt-Anchor" href="#没有-controlplaneendpoint"></a> 没有 controlPlaneEndpoint</h2>
<p>在将第二个主节点加入已存在的单节点集群过程中，预检阶段会报错缺少 controlPlaneEndpoint。这是因为在初始化时没有指定 <code>--control-plane-endpoint</code> 参数导致的：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server1 ~<span class="token punctuation">]</span>$ kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.2.204:6443 <span class="token parameter variable">--token</span> nre8hl.4awo2mnyxr5l0tsu      --discovery-token-ca-cert-hash sha256:8055ad40e280bc4b48b0c3b4daea9aa3f515d3b2fea5fb3ae3fcad398c325a52      --control-plane --certificate-key 5ac22cea4cfc19753cd289c96b968957554b4e4204fe47fc3f56a53dded96716
error execution phase preflight: 
One or <span class="token function">more</span> conditions <span class="token keyword">for</span> hosting a new control plane instance is not satisfied.

unable to <span class="token function">add</span> a new control plane instance a cluster that doesn't have a stable controlPlaneEndpoint address

Please ensure that:
* The cluster has a stable controlPlaneEndpoint address.
* The certificates that must be shared among control plane instances are provided.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>要解决此问题，可以使用 <code>kubectl edit</code> 命令编辑 <code>kubeadm-config</code> 配置文件，并将 <code>controlPlaneEndpoint</code> 地址添加为虚拟 IP 或正在运行的主节点的 IP：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl edit cm kubeadm-config <span class="token parameter variable">-n</span> kube-system
    imageRepository: registry.aliyuncs.com/google_containers
    kind: ClusterConfiguration
    controlPlaneEndpoint: <span class="token number">192.168</span>.2.204:6443
    kubernetesVersion: v1.22.3
    networking:
      dnsDomain: cluster.local
      podSubnet: <span class="token number">10.244</span>.0.0/16<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>保存并退出编辑器。然后，重新执行 <code>kubeadm join</code> 命令将第二个主节点加入集群。这样就能成功添加第二个主节点，完成集群的扩容。</p>
<h2 id="token-过期"><a class="markdownIt-Anchor" href="#token-过期"></a> Token 过期</h2>
<p>当加入集群时出现 “x509: certificate has expired or is not yet valid” 错误时，可以重新生成令牌：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubeadm token create
87668a.lfvdqsr3l5ijlode
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubeadm token list
TOKEN                     TTL       EXPIRES                     USAGES                   DESCRIPTION   EXTRA <span class="token environment constant">GROUPS</span>
1yrznt.lzj1kl0qecosl4es   23h       <span class="token number">2019</span>-07-21T13:14:33+08:00   authentication,signing   <span class="token operator">&lt;</span>none<span class="token operator">></span>        system:bootstrappers:kubeadm:default-node-token
87668a.lfvdqsr3l5ijlode   23h       <span class="token number">2019</span>-07-21T13:24:28+08:00   authentication,signing   <span class="token operator">&lt;</span>none<span class="token operator">></span>        system:bootstrappers:kubeadm:default-node-token
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ kubeadm init phase upload-certs --upload-certs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后在客户端同步时间，并再次尝试加入集群：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span>$ ntpdate cn.pool.ntp.org
<span class="token number">20</span> Jul <span class="token number">13</span>:25:59 ntpdate<span class="token punctuation">[</span><span class="token number">118642</span><span class="token punctuation">]</span>: step <span class="token function">time</span> server <span class="token number">199.182</span>.204.197 offset <span class="token number">137559.272548</span> sec<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="证书过期"><a class="markdownIt-Anchor" href="#证书过期"></a> 证书过期</h2>
<p>可以使用以下命令查看证书的有效期：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubeadm certs check-expiration
<span class="token punctuation">[</span>check-expiration<span class="token punctuation">]</span> Reading configuration from the cluster<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>check-expiration<span class="token punctuation">]</span> FYI: You can <span class="token function">look</span> at this config <span class="token function">file</span> with <span class="token string">'kubectl -n kube-system get cm kubeadm-config -o yaml'</span>

CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Nov 03, <span class="token number">2022</span> 05:36 UTC   217d                                    no      
apiserver                  Nov 03, <span class="token number">2022</span> 05:36 UTC   217d            ca                      no      
apiserver-etcd-client      Nov 03, <span class="token number">2022</span> 05:36 UTC   217d            etcd-ca                 no      
apiserver-kubelet-client   Nov 03, <span class="token number">2022</span> 05:36 UTC   217d            ca                      no      
controller-manager.conf    Nov 03, <span class="token number">2022</span> 05:36 UTC   217d                                    no      
etcd-healthcheck-client    Nov 03, <span class="token number">2022</span> 05:36 UTC   217d            etcd-ca                 no      
etcd-peer                  Nov 03, <span class="token number">2022</span> 05:36 UTC   217d            etcd-ca                 no      
etcd-server                Nov 03, <span class="token number">2022</span> 05:36 UTC   217d            etcd-ca                 no      
front-proxy-client         Nov 03, <span class="token number">2022</span> 05:36 UTC   217d            front-proxy-ca          no      
scheduler.conf             Nov 03, <span class="token number">2022</span> 05:36 UTC   217d                                    no      

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      Nov 01, <span class="token number">2031</span> 05:36 UTC   9y              no      
etcd-ca                 Nov 01, <span class="token number">2031</span> 05:36 UTC   9y              no      
front-proxy-ca          Nov 01, <span class="token number">2031</span> 05:36 UTC   9y              no   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重新生成所有证书：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubeadm certs renew all
<span class="token punctuation">[</span>renew<span class="token punctuation">]</span> Reading configuration from the cluster<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>renew<span class="token punctuation">]</span> FYI: You can <span class="token function">look</span> at this config <span class="token function">file</span> with <span class="token string">'kubectl -n kube-system get cm kubeadm-config -o yaml'</span>

certificate embedded <span class="token keyword">in</span> the kubeconfig <span class="token function">file</span> <span class="token keyword">for</span> the admin to use and <span class="token keyword">for</span> kubeadm itself renewed
certificate <span class="token keyword">for</span> serving the Kubernetes API renewed
certificate the apiserver uses to access etcd renewed
certificate <span class="token keyword">for</span> the API server to connect to kubelet renewed
certificate embedded <span class="token keyword">in</span> the kubeconfig <span class="token function">file</span> <span class="token keyword">for</span> the controller manager to use renewed
certificate <span class="token keyword">for</span> liveness probes to healthcheck etcd renewed
certificate <span class="token keyword">for</span> etcd nodes to communicate with each other renewed
certificate <span class="token keyword">for</span> serving etcd renewed
certificate <span class="token keyword">for</span> the front proxy client renewed
certificate embedded <span class="token keyword">in</span> the kubeconfig <span class="token function">file</span> <span class="token keyword">for</span> the scheduler manager to use renewed

Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据提示分别在所有主节点上重启组件容器：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">docker</span> <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">'k8s_kube-apiserver|k8s_kube-controller-manager|k8s_kube-scheduler|k8s_etcd_etcd'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token parameter variable">-F</span> <span class="token string">' '</span> <span class="token string">'&#123;print $1&#125;'</span> <span class="token operator">|</span><span class="token function">xargs</span> <span class="token function">docker</span> restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="证书不符"><a class="markdownIt-Anchor" href="#证书不符"></a> 证书不符</h2>
<p>如果在加入集群时出现 “x509: certificate is valid for 10.96.0.1, 192.168.2.204, not 192.168.2.199” 的错误，提示证书的 IP 地址不符合要求，这通常在更新节点的 <code>apiserver-advertise-address</code> 或 <code>controlPlaneEndpoint</code> 时会发生。解决方法是删除当前集群下 <code>apiserver</code> 的证书和密钥，然后重新生成：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ <span class="token function">rm</span> <span class="token parameter variable">-f</span> /etc/kubernetes/pki/apiserver.*<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>设置原先主机的 IP 地址为 192.168.2.204，现在的虚拟 IP 地址为 192.168.2.199：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ kubeadm init phase certs apiserver --apiserver-advertise-address <span class="token number">192.168</span>.2.204 --apiserver-cert-extra-sans <span class="token number">192.168</span>.2.199
<span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ kubeadm alpha certs renew admin.conf
Kubeadm experimental sub-commands<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>重启 API Server，然后查看证书：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ kubectl <span class="token parameter variable">-n</span> kube-system delete pod kube-apiserver-server4 kube-apiserver-server6
pod <span class="token string">"kube-apiserver-server4"</span> deleted
pod <span class="token string">"kube-apiserver-server6"</span> deleted
<span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ openssl x509 <span class="token parameter variable">-in</span> /etc/kubernetes/pki/apiserver.crt <span class="token parameter variable">-noout</span> <span class="token parameter variable">-text</span>
Certificate:
    Data:
        Version: <span class="token number">3</span> <span class="token punctuation">(</span>0x2<span class="token punctuation">)</span>
        Serial Number: <span class="token number">2687592491658220129</span> <span class="token punctuation">(</span>0x254c3f21b64b9261<span class="token punctuation">)</span>
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: <span class="token assign-left variable">CN</span><span class="token operator">=</span>kubernetes
        Validity
            Not Before: Apr  <span class="token number">4</span> <span class="token number">16</span>:21:14 <span class="token number">2022</span> GMT
            Not After <span class="token builtin class-name">:</span> Apr <span class="token number">19</span> <span class="token number">13</span>:48:19 <span class="token number">2023</span> GMT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将新的 <code>admin.conf</code> 文件复制到其他需要访问集群的主节点上：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ <span class="token function">scp</span> /etc/kubernetes/admin.conf root@192.168.2.206:./.kube<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>现在可以加入新的主节点了。</p>
<h2 id="cni0-地址错误"><a class="markdownIt-Anchor" href="#cni0-地址错误"></a> cni0 地址错误</h2>
<p>在重新构建 Kubernetes 集群后，由于节点上残留了未删除的虚拟网卡，导致创建 Pod 失败，提示 cni0 地址冲突：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ kubectl describe po kubia-74967b5695-ftk77
  Warning  FailedCreatePodSandBox  56s <span class="token punctuation">(</span>x4 over 59s<span class="token punctuation">)</span>   kubelet            <span class="token punctuation">(</span>combined from similar events<span class="token punctuation">)</span>: Failed to create pod sandbox: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to <span class="token builtin class-name">set</span> up sandbox container <span class="token string">"18dd9bc5076666ed605b2d3331864859454878d7e1f9fae2160f1be71c59c48f"</span> network <span class="token keyword">for</span> pod <span class="token string">"kubia-74967b5695-ftk77"</span><span class="token builtin class-name">:</span> networkPlugin cni failed to <span class="token builtin class-name">set</span> up pod <span class="token string">"kubia-74967b5695-ftk77_default"</span> network: failed to delegate add: failed to <span class="token builtin class-name">set</span> bridge addr: <span class="token string">"cni0"</span> already has an IP address different from <span class="token number">10.100</span>.4.1/24
<span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">ip</span> a
<span class="token number">5</span>: cni0: <span class="token operator">&lt;</span>NO-CARRIER,BROADCAST,MULTICAST,UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noqueue state DOWN group default qlen <span class="token number">1000</span>
    link/ether <span class="token number">92</span>:1d:b1:d9:ba:19 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">10.100</span>.9.1/24 brd <span class="token number">10.100</span>.9.255 scope global cni0
       valid_lft forever preferred_lft forever<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解决方法是手动删除网卡，让它重新创建：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">ifconfig</span> cni0 down
<span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">ip</span> <span class="token function">link</span> delete cni0
<span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">ip</span> a
<span class="token number">926</span>: cni0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1450</span> qdisc noqueue state UP group default qlen <span class="token number">1000</span>
    link/ether <span class="token number">92</span>:6a:c8:8b:2c:5b brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">10.100</span>.4.1/24 brd <span class="token number">10.100</span>.4.255 scope global cni0
       valid_lft forever preferred_lft forever<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="etcd-错误"><a class="markdownIt-Anchor" href="#etcd-错误"></a> etcd 错误</h2>
<p>在 etcd 中存在已被删除的节点记录时，当节点重新加入集群时会报错 “etcd cluster is not healthy: failed to dial endpoint”。这时需要手动维护 etcd 数据库。</p>
<p>进入节点的 etcd 容器内部，查询 etcd 集群的成员列表，然后删除错误的成员，这样集群就恢复正常了：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ kubectl <span class="token parameter variable">-n</span> kube-system <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> etcd-k8s-239 -- <span class="token function">sh</span>
sh-5.0<span class="token comment"># export ETCDCTL_API=3</span>
sh-5.0<span class="token comment"># alias etcdctl='etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key'</span>
sh-5.0<span class="token comment"># etcdctl member list</span>
2e1d3dc8363ee756, started, server5, https://192.168.2.205:2380, https://192.168.2.205:2379, <span class="token boolean">false</span>
4b8b623fba4c1f57, started, server6, https://192.168.2.206:2380, https://192.168.2.206:2379, <span class="token boolean">false</span>
ad703513a2c4e54a, started, server4, https://192.168.2.204:2380, https://192.168.2.204:2379, <span class="token boolean">false</span>
sh-5.0<span class="token comment"># etcdctl member remove 63bfe05c4646fb08</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="备份恢复"><a class="markdownIt-Anchor" href="#备份恢复"></a> 备份恢复</h1>
<p>单主节点集群一定要做好备份工作。</p>
<h2 id="查看-etcd-配置"><a class="markdownIt-Anchor" href="#查看-etcd-配置"></a> 查看 etcd 配置</h2>
<p>在使用 kubeadm 部署的 Kubernetes 集群中，etcd 作为容器运行，并通过本地挂载来存储数据库和配置文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ ll /var/lib/etcd/member/snap
total <span class="token number">5124</span>
-rw-r--r--  <span class="token number">1</span> root root    <span class="token number">9851</span> Apr  <span class="token number">1</span> 03:37 0000000000000012-00000000000222f1.snap
-rw-r--r--  <span class="token number">1</span> root root    <span class="token number">9851</span> Apr  <span class="token number">1</span> 04:46 0000000000000012-0000000000024a02.snap
-rw-r--r--  <span class="token number">1</span> root root    <span class="token number">9851</span> Apr  <span class="token number">1</span> 05:55 0000000000000012-0000000000027113.snap
-rw-r--r--  <span class="token number">1</span> root root    <span class="token number">9851</span> Apr  <span class="token number">1</span> 07:04 0000000000000012-0000000000029824.snap
-rw-r--r--  <span class="token number">1</span> root root    <span class="token number">9851</span> Apr  <span class="token number">1</span> 08:14 0000000000000012-000000000002bf35.snap
-rw-------. <span class="token number">1</span> root root <span class="token number">5185536</span> Apr  <span class="token number">1</span> 08:58 db
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ ll /etc/kubernetes/pki/etcd
total <span class="token number">32</span>
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1086</span> Mar <span class="token number">31</span> <span class="token number">11</span>:49 ca.crt
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> Mar <span class="token number">31</span> <span class="token number">11</span>:49 ca.key
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1159</span> Mar <span class="token number">31</span> <span class="token number">11</span>:49 healthcheck-client.crt
-rw-------. <span class="token number">1</span> root root <span class="token number">1675</span> Mar <span class="token number">31</span> <span class="token number">11</span>:49 healthcheck-client.key
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1212</span> Mar <span class="token number">31</span> <span class="token number">11</span>:49 peer.crt
-rw-------. <span class="token number">1</span> root root <span class="token number">1679</span> Mar <span class="token number">31</span> <span class="token number">11</span>:49 peer.key
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">1212</span> Mar <span class="token number">31</span> <span class="token number">11</span>:49 server.crt
-rw-------. <span class="token number">1</span> root root <span class="token number">1675</span> Mar <span class="token number">31</span> <span class="token number">11</span>:49 server.key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中，以 “.snap” 结尾的文件是快照文件。</p>
<h2 id="安装-etcd-客户端"><a class="markdownIt-Anchor" href="#安装-etcd-客户端"></a> 安装 etcd 客户端</h2>
<p>在主节点上安装 etcd 客户端：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ yum <span class="token function">install</span> <span class="token parameter variable">-y</span> etcd
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ etcdctl <span class="token parameter variable">--version</span>
etcdctl version: <span class="token number">3.3</span>.11
API version: <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="查看-etcd-数据库"><a class="markdownIt-Anchor" href="#查看-etcd-数据库"></a> 查看 etcd 数据库</h2>
<p>首先尝试连接到本地 etcd 数据库：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ etcdctl version
etcdctl version: <span class="token number">3.3</span>.11
API version: <span class="token number">3.3</span>
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">ETCD</span><span class="token operator">=</span><span class="token string">"etcdctl --endpoints https://127.0.0.1:2379 --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key --cacert=/etc/kubernetes/pki/etcd/ca.crt"</span>
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token variable">$ETCD</span> member list
273040abda86d599, started, server9-node1, https://192.168.2.209:2380, https://192.168.2.209:2379
4c80ad008d949110, started, server8-node1, https://192.168.2.208:2380, https://192.168.2.208:2379
dcddbc08262b69e1, started, server7-master, https://192.168.2.207:2380, https://192.168.2.207:2379<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看所有 Pod 对象的存储名称：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token variable">$ETCD</span> get /registry/pods <span class="token parameter variable">--prefix</span> --keys-only
/registry/pods/default/kubia-74967b5695-bzxtf
/registry/pods/default/kubia-74967b5695-vhjkz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="使用命令备份恢复"><a class="markdownIt-Anchor" href="#使用命令备份恢复"></a> 使用命令备份恢复</h2>
<p>使用 <code>etcdctl snapshot save</code> 命令将 etcd 数据库备份到当前目录：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token variable">$ETCD</span> snapshot save snap.db
Snapshot saved at snap.db
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token variable">$ETCD</span> snapshot status snap.db
c477d6ef, <span class="token number">144130</span>, <span class="token number">1216</span>, <span class="token number">5.2</span> MB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先对一个正在运行的服务进行缩容：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ kubectl get po
NAME                     READY   STATUS    RESTARTS        AGE
kubia-74967b5695-bzxtf   <span class="token number">1</span>/1     Running   <span class="token number">2</span> <span class="token punctuation">(</span>7h19m ago<span class="token punctuation">)</span>   20h
kubia-74967b5695-vhjkz   <span class="token number">1</span>/1     Running   <span class="token number">2</span> <span class="token punctuation">(</span>7h19m ago<span class="token punctuation">)</span>   20h
kubia-74967b5695-wsd5c   <span class="token number">1</span>/1     Running   <span class="token number">2</span> <span class="token punctuation">(</span>7h19m ago<span class="token punctuation">)</span>   20h
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ kubectl scale deployment kubia <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">1</span>
deployment.apps/kubia scaled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后暂停 API Server 和 etcd 容器：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ systemctl stop kubelet
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token function">docker</span> stop <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-q</span><span class="token variable">)</span></span> <span class="token operator">&amp;</span> <span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-aq</span><span class="token variable">)</span></span>
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token function">mv</span> /etc/kubernetes/manifests /etc/kubernetes/manifests.bak
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token function">mv</span> /var/lib/etcd/ /var/lib/etcd.bak<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>恢复 etcd 数据库：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token variable">$ETCD</span> snapshot restore snap.db --data-dir<span class="token operator">=</span>/var/lib/etcd
<span class="token number">2022</span>-04-01 09:40:54.304594 I <span class="token operator">|</span> mvcc: restore compact to <span class="token number">143285</span>
<span class="token number">2022</span>-04-01 09:40:54.315885 I <span class="token operator">|</span> etcdserver/membership: added member 8e9e05c52164694d <span class="token punctuation">[</span>http://localhost:2380<span class="token punctuation">]</span> to cluster cdf818194e3a8c32<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>恢复运行 API Server 和 etcd 容器后，再次验证数据：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token function">mv</span> /etc/kubernetes/manifests.bak /etc/kubernetes/manifests
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ systemctl start kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="使用文件备份恢复"><a class="markdownIt-Anchor" href="#使用文件备份恢复"></a> 使用文件备份恢复</h2>
<p>由于版本问题，使用 <code>etcdctl</code> 备份恢复的数据库经常出错，因此可以使用备份文件夹的方式来备份数据库：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ <span class="token function">cp</span> <span class="token parameter variable">-r</span> /var/lib/etcd/ /root/etcd/
<span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ ll /root/etcd/
total <span class="token number">0</span>
drwx------. <span class="token number">4</span> root root <span class="token number">29</span> Apr  <span class="token number">5</span> 02:08 member<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>进行一系列操作后：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ kubectl scale deployment kubia <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">11</span>
deployment.apps/kubia scaled
<span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ kubectl create ns pro
namespace/pro created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>停止 kubelet，删除所有 Docker 容器，删除原数据库文件，然后将备份文件夹复制回来，启动 kubelet：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ systemctl stop kubelet
<span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ <span class="token function">docker</span> stop <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-q</span><span class="token variable">)</span></span> <span class="token operator">&amp;</span> <span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-aq</span><span class="token variable">)</span></span>
<span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ <span class="token function">rm</span> <span class="token parameter variable">-rf</span> /var/lib/etcd/ 
<span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ <span class="token function">cp</span> <span class="token parameter variable">-r</span> /root/etcd/ /var/lib/etcd/
<span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ systemctl start kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>恢复的数据将回到备份时的状态。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>干杯！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="../images/wechatpay.png" alt="assassing 微信">
        <span>微信</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>assassing
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://blog.x2b.net/1488965608/" title="K8s 系统部署">https://blog.x2b.net/1488965608/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="followme">
  <span>欢迎订阅</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="../atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="../1457906456/" rel="prev" title="K8s 组件介绍">
                  <i class="fa fa-chevron-left"></i> K8s 组件介绍
                </a>
            </div>
            <div class="post-nav-item">
                <a href="../376871778/" rel="next" title="K8s 系统介绍">
                  K8s 系统介绍 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2020 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">assassing</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">273k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">15:10</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener external nofollow noreferrer" target="_blank">NexT.Gemini</a> on Kubernetes
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/hxz393" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener external nofollow noreferrer" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@next-theme/pjax@0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="../js/comments.js"></script><script src="../js/utils.js"></script><script src="../js/motion.js"></script><script src="../js/next-boot.js"></script><script src="../js/pjax.js"></script>

  <script src="https://unpkg.com/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="../js/third-party/search/local-search.js"></script>




  <script src="../js/third-party/pace.js"></script>

  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://unpkg.com/katex@0.16.4/dist/katex.min.css" integrity="sha256-gMRN4/6qeELzO1wbFa8qQLU8kfuF2dnAPiUoI0ATjx8=" crossorigin="anonymous">
  <script class="next-config" data-name="katex" type="application/json">{"copy_tex_js":{"url":"https://unpkg.com/katex@0.16.4/dist/contrib/copy-tex.min.js","integrity":"sha256-Us54+rSGDSTvIhKKUs4kygE2ipA0RXpWWh0/zLqw3bs="}}</script>
  <script src="../js/third-party/math/katex.js"></script>


  <script src="https://unpkg.com/quicklink@2.3.0/dist/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":5000,"priority":true,"url":"https://blog.x2b.net/1488965608/"}</script>
  <script src="../js/third-party/quicklink.js"></script>
<link rel="stylesheet" href="https://unpkg.com/gitalk@1.8.0/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"hxz393","repo":"x2b.net-deploy","client_id":"26664aab919326dcf7e7","client_secret":"40882da22b7a77aea4a985ccd95a9363cfb7ba9a","admin_user":"hxz393","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://unpkg.com/gitalk@1.8.0/dist/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"d41d8cd98f00b204e9800998ecf8427e"}</script>
<script src="../js/third-party/comments/gitalk.js"></script>


        <script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script>
        <script>
        const hasAttr = (e,a) => a.some(_=> e.attr(_)!==undefined);
        $('a').each(function() {
          const $this = $(this);
          if(hasAttr($this,["data-fancybox","ignore-external-link"])) return;
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== 'blog.x2b.net' || window.location.host) {
                    $this.attr('href', '/go.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });
        </script></body>
</html>
