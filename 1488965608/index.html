<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#922"><meta name="generator" content="Hexo 6.3.0">
<link rel="preconnect" href="https://fonts.cat.net" crossorigin>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="../images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png">
  <link rel="mask-icon" href="../images/favicon-32x32.png" color="#922">

<link rel="stylesheet" href="../css/main.css">

<link rel="stylesheet" href="https://fonts.cat.net/css?family=Monda:300,300italic,400,400italic,700,700italic%7CArvo:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/pace-js@1.2.4/themes/red/pace-theme-minimal.css">
  <script src="https://unpkg.com/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.x2b.net","root":"/","images":"../images","scheme":"Gemini","darkmode":false,"version":"8.15.1","exturl":false,"sidebar":{"position":"left","width":300,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#922","save":"manual"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":{"gitalk":{"order":-1}},"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"../search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":true,"preload":true}}</script><script src="../js/config.js"></script>

    <meta name="description" content="快速入门 通过 Minikube 快速体验 Kubernetes 系统。">
<meta property="og:type" content="article">
<meta property="og:title" content="K8s 系统部署">
<meta property="og:url" content="https://blog.x2b.net/1488965608/index.html">
<meta property="og:site_name" content="X to Bytes">
<meta property="og:description" content="快速入门 通过 Minikube 快速体验 Kubernetes 系统。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-03-20T01:01:17.000Z">
<meta property="article:modified_time" content="2023-05-15T12:04:03.851Z">
<meta property="article:author" content="assassing">
<meta property="article:tag" content="docker k8s linux python">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.x2b.net/1488965608/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.x2b.net/1488965608/","path":"1488965608/","title":"K8s 系统部署"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>K8s 系统部署 | X to Bytes</title>
  

  <script src="../js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?71ae334aaa654e1cd3ba0c9eb55f88a3"></script>







  <noscript>
    <link rel="stylesheet" href="../css/noscript.css">
  </noscript>
<link rel="alternate" href="atom.xml" title="X to Bytes" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">X to Bytes</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="../about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-categories"><a href="../categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">12</span></a></li><li class="menu-item menu-item-archives"><a href="../archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">77</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="nav-number">1.</span> <span class="nav-text"> 快速入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-%E5%9F%BA%E7%A1%80"><span class="nav-number">1.1.</span> <span class="nav-text"> Docker 基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-nodejs-%E5%BA%94%E7%94%A8"><span class="nav-number">1.1.1.</span> <span class="nav-text"> 创建 Node.js 应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-dockerfile"><span class="nav-number">1.1.2.</span> <span class="nav-text"> 创建 Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F"><span class="nav-number">1.1.3.</span> <span class="nav-text"> 构建容器镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F"><span class="nav-number">1.1.4.</span> <span class="nav-text"> 运行容器镜像</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA-minikube"><span class="nav-number">1.2.</span> <span class="nav-text"> 搭建 Minikube</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">1.2.1.</span> <span class="nav-text"> 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8"><span class="nav-number">1.2.2.</span> <span class="nav-text"> 启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B"><span class="nav-number">1.2.3.</span> <span class="nav-text"> 查看</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-pod"><span class="nav-number">1.2.4.</span> <span class="nav-text"> 建立 pod</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9A%B4%E9%9C%B2%E7%AB%AF%E5%8F%A3"><span class="nav-number">1.2.5.</span> <span class="nav-text"> 暴露端口</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-number">2.</span> <span class="nav-text"> 高可用集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#kubeadm"><span class="nav-number">2.1.</span> <span class="nav-text"> Kubeadm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kubeadm-init"><span class="nav-number">2.1.1.</span> <span class="nav-text"> kubeadm init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubeadm-join"><span class="nav-number">2.1.2.</span> <span class="nav-text"> kubeadm join</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">2.2.</span> <span class="nav-text"> 准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%BB%E6%9C%BA%E5%90%8D"><span class="nav-number">2.2.1.</span> <span class="nav-text"> 修改主机名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A6%81%E7%94%A8%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98"><span class="nav-number">2.2.2.</span> <span class="nav-text"> 禁用虚拟内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="nav-number">2.2.3.</span> <span class="nav-text"> 开启端口转发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99"><span class="nav-number">2.2.4.</span> <span class="nav-text"> 关闭防火墙</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E7%BB%84%E4%BB%B6"><span class="nav-number">2.3.</span> <span class="nav-text"> 安装组件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="nav-number">2.4.</span> <span class="nav-text"> 主节点配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-keepalived"><span class="nav-number">2.4.1.</span> <span class="nav-text"> 部署 keepalived</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-haproxy"><span class="nav-number">2.4.2.</span> <span class="nav-text"> 部署 HAproxy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E9%9B%86%E7%BE%A4"><span class="nav-number">2.5.</span> <span class="nav-text"> 建立集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="nav-number">2.5.1.</span> <span class="nav-text"> 初始化主节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-kubectl"><span class="nav-number">2.5.2.</span> <span class="nav-text"> 配置 Kubectl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E7%BD%91%E7%BB%9C"><span class="nav-number">2.5.3.</span> <span class="nav-text"> 部署网络</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E7%BD%91%E7%BB%9C"><span class="nav-number">2.5.4.</span> <span class="nav-text"> 删除网络</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E5%AE%8C%E6%AF%95"><span class="nav-number">2.5.5.</span> <span class="nav-text"> 建立完毕</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="nav-number">2.6.</span> <span class="nav-text"> 加入集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%8F%82%E6%95%B0"><span class="nav-number">2.6.1.</span> <span class="nav-text"> 获取参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E5%85%A5%E4%BB%8E%E8%8A%82%E7%82%B9"><span class="nav-number">2.6.2.</span> <span class="nav-text"> 加入从节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E5%85%A5%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="nav-number">2.6.3.</span> <span class="nav-text"> 加入主节点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9"><span class="nav-number">2.7.</span> <span class="nav-text"> 移除节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE"><span class="nav-number">2.8.</span> <span class="nav-text"> 修改配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E6%94%BE%E6%9D%83%E9%99%90"><span class="nav-number">2.8.1.</span> <span class="nav-text"> 开放权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%81%E8%AE%B8%E4%B8%BB%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2"><span class="nav-number">2.8.2.</span> <span class="nav-text"> 允许主节点部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E6%9A%B4%E9%9C%B2%E7%AB%AF%E5%8F%A3%E8%8C%83%E5%9B%B4"><span class="nav-number">2.8.3.</span> <span class="nav-text"> 修改暴露端口范围</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%81%A2%E5%A4%8D%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="nav-number">2.8.4.</span> <span class="nav-text"> 恢复健康检查</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%8D%87%E7%BA%A7"><span class="nav-number">2.9.</span> <span class="nav-text"> 集群升级</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86"><span class="nav-number">2.10.</span> <span class="nav-text"> 故障处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B2%A1%E6%9C%89-pod-network-cidr"><span class="nav-number">2.10.1.</span> <span class="nav-text"> 没有 pod-network-cidr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B2%A1%E6%9C%89-controlplaneendpoint"><span class="nav-number">2.10.2.</span> <span class="nav-text"> 没有 controlPlaneEndpoint</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#token-%E8%BF%87%E6%9C%9F"><span class="nav-number">2.10.3.</span> <span class="nav-text"> Token 过期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%81%E4%B9%A6%E8%BF%87%E6%9C%9F"><span class="nav-number">2.10.4.</span> <span class="nav-text"> 证书过期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%81%E4%B9%A6%E4%B8%8D%E7%AC%A6"><span class="nav-number">2.10.5.</span> <span class="nav-text"> 证书不符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cni0-%E5%9C%B0%E5%9D%80%E9%94%99%E8%AF%AF"><span class="nav-number">2.10.6.</span> <span class="nav-text"> cni0 地址错误</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#etcd-%E9%94%99%E8%AF%AF"><span class="nav-number">2.10.7.</span> <span class="nav-text"> etcd 错误</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91%E9%83%A8%E7%BD%B2"><span class="nav-number">2.11.</span> <span class="nav-text"> 阿里云部署</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="assassing"
      src="../images/avatar.jpg">
  <p class="site-author-name" itemprop="name">assassing</p>
  <div class="site-description" itemprop="description">技术分享</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="../archives/">
          <span class="site-state-item-count">77</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="../categories/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hxz393" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxz393" rel="noopener me external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://youtube.com/hxz393" title="YouTube → https:&#x2F;&#x2F;youtube.com&#x2F;hxz393" rel="noopener me external nofollow noreferrer" target="_blank"><i class="fab fa-youtube fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://www.discogs.com/user/assassing" title="https:&#x2F;&#x2F;www.discogs.com&#x2F;user&#x2F;assassing" rel="noopener external nofollow noreferrer" target="_blank">Discogs</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://www.last.fm/user/assassing" title="https:&#x2F;&#x2F;www.last.fm&#x2F;user&#x2F;assassing" rel="noopener external nofollow noreferrer" target="_blank">Last.fm</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://anidb.net/up795303" title="https:&#x2F;&#x2F;anidb.net&#x2F;up795303" rel="noopener external nofollow noreferrer" target="_blank">AniDB</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.x2b.net/1488965608/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../images/avatar.jpg">
      <meta itemprop="name" content="assassing">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="X to Bytes">
      <meta itemprop="description" content="技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="K8s 系统部署 | X to Bytes">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          K8s 系统部署
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-03-20 09:01:17" itemprop="dateCreated datePublished" datetime="2022-03-20T09:01:17+08:00">2022-03-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-15 20:04:03" itemprop="dateModified" datetime="2023-05-15T20:04:03+08:00">2023-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Kubernets/" itemprop="url" rel="index"><span itemprop="name">Kubernets</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Kubernets/0-%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">0.基本知识</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>8.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>29 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="快速入门"><a class="markdownIt-Anchor" href="#快速入门"></a> 快速入门</h1>
<p>通过 Minikube 快速体验 Kubernetes 系统。</p>
<h2 id="docker-基础"><a class="markdownIt-Anchor" href="#docker-基础"></a> Docker 基础</h2>
<p>首先需要在主机上安装好 Docker，然后创建一个简单的 Node.js 镜像并运行。</p>
<h3 id="创建-nodejs-应用"><a class="markdownIt-Anchor" href="#创建-nodejs-应用"></a> 创建 Node.js 应用</h3>
<p>创建一个简单的 Node.js Web 应用，并打包成容器镜像。应用会接受 HTTP 请求并响应应用运行的主机名。</p>
<p>新建一个 app.js 文件，内容如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> app.js
const http <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const os <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console.log<span class="token punctuation">(</span><span class="token string">"Runing..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

var handle <span class="token operator">=</span> function<span class="token punctuation">(</span>request, response<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        console.log<span class="token punctuation">(</span><span class="token string">"Request IP: "</span> + request.connection.remoteAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response.writeHead<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response.end<span class="token punctuation">(</span><span class="token string">"Hostname: "</span> + os.hostname<span class="token punctuation">(</span><span class="token punctuation">)</span> + <span class="token string">"<span class="token entity" title="\n">\n</span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

var www <span class="token operator">=</span> http.createServer<span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
www.listen<span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>应用在 8080 端口启动一个 HTTP 服务器，服务器会以状态码 200 和输出消息来响应每个请求。请求处理程序会将客户端 IP 打印到标准输出。</p>
<h3 id="创建-dockerfile"><a class="markdownIt-Anchor" href="#创建-dockerfile"></a> 创建 Dockerfile</h3>
<p>Dockerfile 文件需要和 <code>app.js</code> 文件放在同一目录，内容如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> Dockerfile
FROM node:7
ADD app.js /app.js
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"node"</span>, <span class="token string">"app.js"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里使用 Node 7 版本的基础镜像，然后将 <code>app.js</code> 文件添加到镜像根目录，最后执行 <code>node app.js</code> 命令。</p>
<h3 id="构建容器镜像"><a class="markdownIt-Anchor" href="#构建容器镜像"></a> 构建容器镜像</h3>
<p>构建不是由 Docker 客户端进行的，而是将整个目录的文件上传到 Docker 守护进程并在那里进行。因此，在守护进程运行在另外一个服务器时，不要在构建目录中包含不需要的文件。</p>
<p>使用 docker build 构建名为 kubia 的镜像：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">docker</span> build <span class="token parameter variable">-t</span> kubia <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Dockerfile 中每一条指令都会创建一个新层。上面的例子中，有一层用来添加 <code>app.js</code>，另外一层运行 <code>node app.js</code> 命令，最后一层会被标记为 kubia:latest。构建完成后镜像会存储在本地。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">docker</span> images kubia
REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
kubia        latest    3749c66c19c7   <span class="token number">2</span> minutes ago   660MB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="运行容器镜像"><a class="markdownIt-Anchor" href="#运行容器镜像"></a> 运行容器镜像</h3>
<p>指定容器名为 kubia-container，暴露端口 8080，在后台运行：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">docker</span> run <span class="token parameter variable">--name</span> kubia-container <span class="token parameter variable">-p</span> <span class="token number">8080</span>:8080 <span class="token parameter variable">-d</span> kubia
c971ba30949f2b1dbca90a96274a3a06a577d33f981e9bc82f327fbdb7010277<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启动后在浏览器通过 192.168.2.206:8080 访问服务：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server5 ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> <span class="token number">192.168</span>.2.206:8080
Hostname: c971ba30949f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>此时容器主机名就是 Docker 容器短 ID。可以查询容器日志：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">docker</span> logs kubia-container
Runing<span class="token punctuation">..</span>.
Request IP: ::ffff:192.168.2.101
Request IP: ::ffff:192.168.2.205<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="搭建-minikube"><a class="markdownIt-Anchor" href="#搭建-minikube"></a> 搭建 Minikube</h2>
<p>Minikube 是一个构建单节点集群的工具，具体使用可以参考 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/kubernetes/minikube">GitHub</a>。</p>
<h3 id="安装"><a class="markdownIt-Anchor" href="#安装"></a> 安装</h3>
<p>下面通过下载 RPM 包的方式安装 Minikube：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> <span class="token parameter variable">-LO</span> https://storage.googleapis.com/minikube/releases/latest/minikube-latest.x86_64.rpm
<span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">rpm</span> <span class="token parameter variable">-Uvh</span> minikube-latest.x86_64.rpm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>还需要安装 Kubectl 客户端来与 Minikube 进行交互：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> <span class="token parameter variable">-LO</span> https://storage.googleapis.com/kubernetes-release/release/<span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> <span class="token parameter variable">-s</span> https://storage.googleapis.com/kubernetes-release/release/stable.txt<span class="token variable">)</span></span>/bin/linux/amd64/kubectl
<span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">chmod</span> +x ./kubectl <span class="token operator">&amp;&amp;</span> <span class="token function">mv</span> ./kubectl /usr/local/bin/kubectl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="启动"><a class="markdownIt-Anchor" href="#启动"></a> 启动</h3>
<p>如果不带参数启动，会报错说不能使用 root 权限运行。这里使用一个加入了 docker 组的 user1 来运行。</p>
<p>另外经常会碰到镜像拉取失败的情况，可以加入 <code>--registry-mirror</code> 参数指定仓库：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">usermod</span> <span class="token parameter variable">-G</span> <span class="token function">docker</span> user1
<span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">su</span> <span class="token parameter variable">-l</span> user1
<span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ minikube start --image-mirror-country<span class="token operator">=</span>cn --image-repository<span class="token operator">=</span>registry.cn-hangzhou.aliyuncs.com/google_containers
* minikube v1.23.2 on Centos <span class="token number">7.9</span>.2009
* Automatically selected the <span class="token function">docker</span> driver
* Using image repository registry.cn-hangzhou.aliyuncs.com/google_containers
* Starting control plane <span class="token function">node</span> minikube <span class="token keyword">in</span> cluster minikube
* Pulling base image <span class="token punctuation">..</span>.
* Creating <span class="token function">docker</span> container <span class="token punctuation">(</span>CPUs<span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">Memory</span><span class="token operator">=</span>2200MB<span class="token punctuation">)</span> <span class="token punctuation">..</span>.
* Verifying Kubernetes components<span class="token punctuation">..</span>.
* Enabled addons: storage-provisioner, default-storageclass
* kubectl not found. If you need it, try: <span class="token string">'minikube kubectl -- get pods -A'</span>
* Done<span class="token operator">!</span> kubectl is now configured to use <span class="token string">"minikube"</span> cluster and <span class="token string">"default"</span> namespace by default<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>遇到其他报错可以删除文件重新启动：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ minikube delete
* Deleting <span class="token string">"minikube"</span> <span class="token keyword">in</span> <span class="token function">docker</span> <span class="token punctuation">..</span>.
* Removed all traces of the <span class="token string">"minikube"</span> cluster.
<span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ <span class="token function">rm</span> <span class="token parameter variable">-rf</span> .minikube<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="查看"><a class="markdownIt-Anchor" href="#查看"></a> 查看</h3>
<p>安装好以后可以使用 <code>kubectl</code> 命令查看集群工作状态：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ kubectl cluster-info 
Kubernetes control plane is running at https://192.168.49.2:8443
CoreDNS is running at https://192.168.49.2:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
<span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ kubectl get nodes
NAME       STATUS   ROLES                  AGE     VERSION
minikube   Ready    control-plane,master   8m40s   v1.22.2
<span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ kubectl describe <span class="token function">node</span> minikube 
Name:               minikube
Roles:              control-plane,master
Labels:             beta.kubernetes.io/arch<span class="token operator">=</span>amd64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="建立-pod"><a class="markdownIt-Anchor" href="#建立-pod"></a> 建立 pod</h3>
<p>使用 <code>kubectl run</code> 命令可以创建所有必要组件而无需使用 JSON 或 YAML 文件。其中使用 <code>--image</code> 指定镜像，使用 <code>--port</code> 说明容器监听端口：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ kubectl run kubia <span class="token parameter variable">--image</span><span class="token operator">=</span>assassing/kubia <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">8080</span>
pod/kubia created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>不能用 <code>kubectl</code> 直接列出容器，因为 Pod 才是操作对象。一个 Pod 包含一个或多个容器，每个容器都运行一个应用进程，它们总是运行在同一个工作节点及命名空间中。查看 Pod 运行状态：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ kubectl get pod
NAME    READY   STATUS    RESTARTS   AGE
kubia   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          58s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="暴露端口"><a class="markdownIt-Anchor" href="#暴露端口"></a> 暴露端口</h3>
<p>每个 Pod 都有自己的 IP，Pod 分布在不同的工作节点上。它们不能被外部访问，需要通过服务对象来公开：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ kubectl expose pod kubia <span class="token parameter variable">--type</span><span class="token operator">=</span>NodePort 
service/kubia exposed
<span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ minikube <span class="token function">service</span> kubia <span class="token parameter variable">--url</span>
http://192.168.49.2:32556
<span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ kubectl expose pod kubia <span class="token parameter variable">--type</span><span class="token operator">=</span>LoadBalancer <span class="token parameter variable">--name</span> kubia-http
service/kubia-http exposed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看刚刚新建的服务：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ kubectl get services
NAME         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
kubernetes   ClusterIP      <span class="token number">10.96</span>.0.1       <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">443</span>/TCP          42m
kubia        NodePort       <span class="token number">10.107</span>.120.56   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">8080</span>:32556/TCP   3m22s
kubia-http   LoadBalancer   <span class="token number">10.108</span>.108.14   <span class="token operator">&lt;</span>pending<span class="token operator">></span>     <span class="token number">8080</span>:31003/TCP   56s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>显示 pending 是因为 Minikube 不支持 LoadBalancer 类型的服务，可以用另外一个命令查看：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>user1@server6 ~<span class="token punctuation">]</span>$ minikube <span class="token function">service</span> kubia-http
<span class="token operator">|</span>-----------<span class="token operator">|</span>------------<span class="token operator">|</span>-------------<span class="token operator">|</span>---------------------------<span class="token operator">|</span>
<span class="token operator">|</span> NAMESPACE <span class="token operator">|</span>    NAME    <span class="token operator">|</span> TARGET PORT <span class="token operator">|</span>            URL            <span class="token operator">|</span>
<span class="token operator">|</span>-----------<span class="token operator">|</span>------------<span class="token operator">|</span>-------------<span class="token operator">|</span>---------------------------<span class="token operator">|</span>
<span class="token operator">|</span> default   <span class="token operator">|</span> kubia-http <span class="token operator">|</span>        <span class="token number">8080</span> <span class="token operator">|</span> http://192.168.49.2:31003 <span class="token operator">|</span>
<span class="token operator">|</span>-----------<span class="token operator">|</span>------------<span class="token operator">|</span>-------------<span class="token operator">|</span>---------------------------<span class="token operator">|</span>
* Opening <span class="token function">service</span> default/kubia-http <span class="token keyword">in</span> default browser<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="高可用集群部署"><a class="markdownIt-Anchor" href="#高可用集群部署"></a> 高可用集群部署</h1>
<p>以部署三主节点高可用集群示例，系统为 CentOS 7，K8s 版本为 1.22.3。</p>
<h2 id="kubeadm"><a class="markdownIt-Anchor" href="#kubeadm"></a> Kubeadm</h2>
<p>Kubeadm 是由志愿者开发的专门用于部署 K8s 的工具。自 K8s 1.14 版本以后，Kubeadm 项目已经正式宣布 GA（General Availability），可以在<a target="_blank" rel="noopener external nofollow noreferrer" href="https://kubernetes.io/zh/docs/setup/production-environment/tools/">官方文档</a>中查看详细的使用说明。</p>
<h3 id="kubeadm-init"><a class="markdownIt-Anchor" href="#kubeadm-init"></a> kubeadm init</h3>
<p>初始化的大致过程如下：</p>
<ol>
<li>kubeadm 执行初始化检查。</li>
<li>生成 token 和证书。</li>
<li>生成 KubeConfig 文件，kubelet 需要使用该文件与 Master 进行通信。</li>
<li>安装 Master 组件，从镜像仓库下载组件和 Docker 镜像。</li>
<li>安装附加组件 kube-proxy 和 kube-dns。</li>
<li>Kubernetes Master 初始化成功。</li>
<li>提示如何配置 kubectl，安装 pod 网络，以及其他节点注册到集群的方法。</li>
</ol>
<p>执行 <code>kubeadm init</code> 指令后，kubeadm 首先会进行一系列的检查工作，以确定本机是否适用于部署 K8s。这一步的检查被称为 Preflight Checks，其主要目的是检查内核版本、CGroups 模块、kubelet 版本、网络端口等必要的配置是否正确。</p>
<p>默认情况下，与 API 服务器的通信必须使用 HTTPS 方式，因此需要证书文件。在完成系统检查后，kubeadm 开始生成 K8s 对外提供服务所需的各种证书和目录。kubeadm 生成的证书存放在主节点的 <code>/etc/kubernetes/pki/</code> 目录下，其中最重要的文件是 <code>ca.crt</code> 和 <code>ca.key</code>。也可以将现有的证书复制到证书目录中，这样 kubeadm 就不会生成证书：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">ls</span> /etc/kubernetes/pki
apiserver.crt              apiserver.key                 ca.crt  front-proxy-ca.crt      front-proxy-client.key
apiserver-etcd-client.crt  apiserver-kubelet-client.crt  ca.key  front-proxy-ca.key      sa.key
apiserver-etcd-client.key  apiserver-kubelet-client.key  etcd    front-proxy-client.crt  sa.pub<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>生成证书之后，kubeadm 接下来会创建用于访问 API 服务器的配置文件，并存放在 <code>/etc/kubernetes/</code> 目录下。这些文件记录了主节点的服务器地址、端口和证书位置等信息，客户端可以直接使用这些信息：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">ls</span> /etc/kubernetes/
admin.conf  controller-manager.conf  kubeadm-master.config  kubelet.conf  manifests  pki  scheduler.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>随后，kubeadm 会为 Master 组件生成 pod 的配置文件，并以静态 pod 的形式运行。这种容器启动的方式允许将要部署的 pod 的 YAML 文件放在一起，当 Kubelet 启动时，会自动加载这些文件并启动 pod。这些配置文件默认存放在 <code>/etc/kubernetes/manifests/</code> 目录下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ ll /etc/kubernetes/manifests/
total <span class="token number">16</span>
-rw------- <span class="token number">1</span> root root <span class="token number">2258</span> Apr <span class="token number">20</span> <span class="token number">22</span>:19 etcd.yaml
-rw------- <span class="token number">1</span> root root <span class="token number">3424</span> Apr <span class="token number">20</span> <span class="token number">22</span>:29 kube-apiserver.yaml
-rw------- <span class="token number">1</span> root root <span class="token number">2906</span> Apr <span class="token number">20</span> <span class="token number">22</span>:30 kube-controller-manager.yaml
-rw------- <span class="token number">1</span> root root <span class="token number">1492</span> Apr <span class="token number">20</span> <span class="token number">22</span>:30 kube-scheduler.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，kubeadm 会为集群生成一个用于加入集群的 bootstrap token。其他证书等信息通过 ConfigMap 的方式保存在 etcd 中。</p>
<p>最后是安装默认插件，包括 kube-proxy 和 DNS 插件，用于提供整个集群的服务发现和 DNS 功能。</p>
<h3 id="kubeadm-join"><a class="markdownIt-Anchor" href="#kubeadm-join"></a> kubeadm join</h3>
<p>加入集群时，需要使用主节点初始化时生成的令牌（token），该令牌用于进行一次性身份验证。工作节点在获取 ConfigMap 中的证书后，将使用证书进行安全通信。</p>
<h2 id="准备工作"><a class="markdownIt-Anchor" href="#准备工作"></a> 准备工作</h2>
<p>首先需要先安装好 Docker，系统版本为 CentOS 7。</p>
<h3 id="修改主机名"><a class="markdownIt-Anchor" href="#修改主机名"></a> 修改主机名</h3>
<p>修改所有节点上的主机名，例如 server4-master，server5-node1，server6-node2：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ hostnamectl set-hostname k8s-204<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>将主机名添加到 <code>/etc/hosts</code> 中：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> <span class="token string">"127.0.0.1   <span class="token variable"><span class="token variable">$(</span><span class="token function">hostname</span><span class="token variable">)</span></span>"</span> <span class="token operator">>></span> /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="禁用虚拟内存"><a class="markdownIt-Anchor" href="#禁用虚拟内存"></a> 禁用虚拟内存</h3>
<p>调整开机挂载选项，并重新挂载根目录：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ swapoff <span class="token parameter variable">-a</span>
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token function">yes</span> <span class="token operator">|</span> <span class="token function">cp</span> /etc/fstab /etc/fstab_bak
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> /etc/fstab_bak <span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> swap <span class="token operator">></span> /etc/fstab
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">mount</span> <span class="token parameter variable">-n</span> <span class="token parameter variable">-o</span> remount,rw /
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/.*swap.*/#&amp;/'</span> /etc/fstab<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="开启端口转发"><a class="markdownIt-Anchor" href="#开启端口转发"></a> 开启端口转发</h3>
<p>首先要确认网卡 MAC 地址没有冲突，然后确保 br_netfilter 模块被加载：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6-node2 ~<span class="token punctuation">]</span>$ lsmod <span class="token operator">|</span> <span class="token function">grep</span> br_netfilter
br_netfilter           <span class="token number">22256</span>  <span class="token number">0</span> 
bridge                <span class="token number">151336</span>  <span class="token number">1</span> br_netfilter
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ modprobe ip_vs
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ modprobe ip_vs_rr
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ modprobe ip_vs_wrr
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ modprobe ip_vs_sh
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span>  /etc/sysctl.d/k8s.conf</span>
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_nonlocal_bind = 1
net.ipv4.ip_forward = 1
vm.swappiness=0
EOF</span>
<span class="token punctuation">[</span>root@server6-node2 ~<span class="token punctuation">]</span>$ <span class="token function">sysctl</span> <span class="token parameter variable">--system</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="关闭防火墙"><a class="markdownIt-Anchor" href="#关闭防火墙"></a> 关闭防火墙</h3>
<p>关闭防火墙和 SELinux，否则容器访问主机文件系统会不正常：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-204 ~<span class="token punctuation">]</span>$ <span class="token function">service</span> iptables stop
<span class="token punctuation">[</span>root@k8s-204 ~<span class="token punctuation">]</span>$ <span class="token function">chkconfig</span> iptables off
<span class="token punctuation">[</span>root@k8s-204 ~<span class="token punctuation">]</span>$ systemctl stop firewalld
<span class="token punctuation">[</span>root@k8s-204 ~<span class="token punctuation">]</span>$ systemctl disable firewalld
<span class="token punctuation">[</span>root@k8s-204 ~<span class="token punctuation">]</span>$ setenforce <span class="token number">0</span>
<span class="token punctuation">[</span>root@k8s-204 ~<span class="token punctuation">]</span>$ <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/^SELINUX=enforcing$/SELINUX=disabled/'</span> /etc/selinux/config
<span class="token punctuation">[</span>root@k8s-204 ~<span class="token punctuation">]</span>$ getenforce <span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="安装组件"><a class="markdownIt-Anchor" href="#安装组件"></a> 安装组件</h2>
<p>kubelet 是唯一没有以容器形式运行的 K8s 组件，它通过 systemd 服务运行。kubeadm 用来创建 K8s 集群，kubectl 是用来执行 K8s 命令的工具。其他 K8s 的系统组件都以容器化运行，并被放到 kube-system namespaces 中，例如 coredns、etcd、apiserver、controller-manager。</p>
<p>在所有要加入 K8s 集群的主机中安装 kubelet、kubeadm 和 kubectl 1.22.3 版本：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server5-node1 ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> /etc/yum.repos.d/kubernetes.repo</span>
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ yum <span class="token function">install</span> <span class="token parameter variable">-y</span> kubelet-1.22.3 kubeadm-1.22.3 kubectl-1.22.3 <span class="token parameter variable">--disableexcludes</span><span class="token operator">=</span>kubernetes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改 Kubelet 配置文件，设置 cgroup 驱动为 systemd，镜像 pause 使用阿里云的源，然后启动 Kubelet：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> <span class="token operator">></span>/etc/sysconfig/kubelet<span class="token operator">&lt;&lt;</span><span class="token string">EOF
KUBELET_EXTRA_ARGS="--cgroup-driver=systemd --runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.2"
EOF</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ systemctl daemon-reload
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果没有配置过 Docker，需要先修改 Docker 的启动参数采用相同 cgroup 驱动：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#^ExecStart=/usr/bin/dockerd.*#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd#g"</span> /usr/lib/systemd/system/docker.service
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> https://get.daocloud.io/daotools/set_mirror.sh <span class="token operator">|</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> http://f1361db2.m.daocloud.io
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ systemctl daemon-reload
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ systemctl restart <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="主节点配置"><a class="markdownIt-Anchor" href="#主节点配置"></a> 主节点配置</h2>
<p>主节点上部署 HAproxy 和 keepalived 来保证主节点高可用。</p>
<h3 id="部署-keepalived"><a class="markdownIt-Anchor" href="#部署-keepalived"></a> 部署 keepalived</h3>
<p>keepalived 以 VRRP（虚拟路由冗余协议）协议为基础，包括一个 master 和多个 backup。master 劫持 VIP 对外提供服务。master 发送组播，backup 节点收不到 VRRP 包时认为 master 宕机，此时选出剩余优先级最高的节点作为新 master 劫持 VIP。</p>
<p>此处的 keepalived 的主要作用是为 haproxy 提供 VIP（192.168.2.199）。在三个 haproxy 实例之间提供主备，降低当其中一个 haproxy 失效时对服务的影响。</p>
<p>先在所有主节点上安装 keepalived：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ yum <span class="token parameter variable">-y</span> <span class="token function">install</span> keepalived psmisc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>配置文件内容如下。其他节点的配置修改 <code>vrrp_instance VI_1</code> 中角色 <code>state</code> 为 <code>BACKUP</code>：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> /etc/keepalived/keepalived.conf
global_defs <span class="token punctuation">&#123;</span>
    router_id LVS_DEVEL
    script_user root
    enable_script_security
<span class="token punctuation">&#125;</span>
vrrp_script check_haproxy <span class="token punctuation">&#123;</span>
script <span class="token string">"/bin/bash -c 'if [[ <span class="token variable"><span class="token variable">$(</span><span class="token function">netstat</span> <span class="token parameter variable">-nlp</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">16443</span><span class="token variable">)</span></span> ]]; then exit 0; else exit 1; fi'"</span>
interval <span class="token number">30</span>
weight <span class="token parameter variable">-11</span>
<span class="token punctuation">&#125;</span>
vrrp_instance VI_1 <span class="token punctuation">&#123;</span>
    state MASTER
    interface eth
    virtual_router_id <span class="token number">51</span>
    priority <span class="token number">100</span>
    advert_int <span class="token number">1</span>
    authentication <span class="token punctuation">&#123;</span>
        auth_type PASS
        auth_pass <span class="token number">1111</span>
    <span class="token punctuation">&#125;</span>
    virtual_ipaddress <span class="token punctuation">&#123;</span>
        <span class="token number">192.168</span>.1.253
    <span class="token punctuation">&#125;</span>
track_script <span class="token punctuation">&#123;</span>
check_haproxy
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置文件中主要配置项有：</p>
<ul>
<li>vrrp_script check_haproxy{}：检测 haproxy 进程是否存活脚本，interval 设置检测间隔为 3 秒。</li>
<li>state MASTER：指定节点名称。</li>
<li>virtual_router_id 51：虚拟路由组的 ID。</li>
<li>interface ens37：指定 VIP 绑定网卡名称。</li>
<li>priority 100：节点优先级。</li>
<li>authentication：节点之间认证密码。</li>
<li>virtual_ipaddress{}：虚拟 VIP 的地址。</li>
</ul>
<p>在所有节点上启动服务：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> keepalived.service
systemctl start keepalived.serviceCreated symlink from /etc/systemd/system/multi-user.target.wants/keepalived.service to /usr/lib/systemd/system/keepalived.service.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="部署-haproxy"><a class="markdownIt-Anchor" href="#部署-haproxy"></a> 部署 HAproxy</h3>
<p>HAproxy 提供高可用性、负载均衡、基于 TCP 和 HTTP 的代理，支持数以万记的并发连接。</p>
<p>此处 HAproxy 为 apiserver 提供反向代理，HAproxy 将所有请求轮询转发到每个 master 节点上。</p>
<p>在所有节点上安装并配置 HAproxy，配置文件内容相同，主要是设置 <code>backend kubernetes-apiserver</code> 中 server 的地址列表，负载均衡模式 <code>balance</code> 默认为轮询的负载算法 roundrobin：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ yum <span class="token function">install</span> <span class="token parameter variable">-y</span> haproxy
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> /etc/haproxy/haproxy.cfg
<span class="token comment">#---------------------------------------------------------------------</span>
<span class="token comment"># Global settings</span>
<span class="token comment">#---------------------------------------------------------------------</span>
global
    <span class="token comment"># to have these messages end up in /var/log/haproxy.log you will</span>
    <span class="token comment"># need to:</span>
    <span class="token comment">#</span>
    <span class="token comment"># 1) configure syslog to accept network log events.  This is done</span>
    <span class="token comment">#    by adding the '-r' option to the SYSLOGD_OPTIONS in</span>
    <span class="token comment">#    /etc/sysconfig/syslog</span>
    <span class="token comment">#</span>
    <span class="token comment"># 2) configure local2 events to go to the /var/log/haproxy.log</span>
    <span class="token comment">#   file. A line like the following can be added to</span>
    <span class="token comment">#   /etc/sysconfig/syslog</span>
    <span class="token comment">#</span>
    <span class="token comment">#    local2.*                       /var/log/haproxy.log</span>
    <span class="token comment">#</span>
    log         <span class="token number">127.0</span>.0.1 local2

    <span class="token function">chroot</span>      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     <span class="token number">4000</span>
    user        haproxy
    group       haproxy
    daemon

    <span class="token comment"># turn on stats unix socket</span>
    stats socket /var/lib/haproxy/stats

<span class="token comment">#---------------------------------------------------------------------</span>
<span class="token comment"># common defaults that all the 'listen' and 'backend' sections will</span>
<span class="token comment"># use if not designated in their block</span>
<span class="token comment">#---------------------------------------------------------------------</span>
defaults
    mode                    http
    log                     global
    option                  httplog
    option                  dontlognull
    option http-server-close
    option forwardfor       except <span class="token number">127.0</span>.0.0/8
    option                  redispatch
    retries                 <span class="token number">3</span>
    <span class="token function">timeout</span> http-request    10s
    <span class="token function">timeout</span> queue           1m
    <span class="token function">timeout</span> connect         10s
    <span class="token function">timeout</span> client          1m
    <span class="token function">timeout</span> server          1m
    <span class="token function">timeout</span> http-keep-alive 10s
    <span class="token function">timeout</span> check           10s
    maxconn                 <span class="token number">3000</span>

<span class="token comment">#---------------------------------------------------------------------</span>
<span class="token comment"># kubernetes apiserver frontend which proxys to the backends</span>
<span class="token comment">#---------------------------------------------------------------------</span>
frontend kubernetes-apiserver
    mode                 tcp
    <span class="token builtin class-name">bind</span>                 *:16443
    option               tcplog
    default_backend      kubernetes-apiserver

<span class="token comment">#---------------------------------------------------------------------</span>
<span class="token comment"># round robin balancing between the various backends</span>
<span class="token comment">#---------------------------------------------------------------------</span>
backend kubernetes-apiserver
    mode        tcp
    balance     roundrobin
    server  k8s-250 <span class="token number">192.168</span>.1.250:6443 check
    server  k8s-248 <span class="token number">192.168</span>.1.248:6443 check
    server  k8s-249 <span class="token number">192.168</span>.1.249:6443 check

<span class="token comment">#---------------------------------------------------------------------</span>
<span class="token comment"># collection haproxy statistics message</span>
<span class="token comment">#---------------------------------------------------------------------</span>
listen stats
    <span class="token builtin class-name">bind</span>                 *:1080
    stats auth           admin:awesomePassword
    stats refresh        5s
    stats realm          HAProxy<span class="token punctuation">\</span> Statistics
    stats uri            /admin?stats<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动后观察端口监听状态，16443 端口绑定服务监听，1080 端口为状态查询前端入口，可以在浏览器访问 <a target="_blank" rel="noopener external nofollow noreferrer" href="http://192.168.1.253:1080/admin?stats">http://192.168.1.253:1080/admin?stats</a> 来查询 HAproxy 运行状态：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> haproxy.service
Created symlink from /etc/systemd/system/multi-user.target.wants/haproxy.service to /usr/lib/systemd/system/haproxy.service.
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ systemctl status haproxy
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">netstat</span> <span class="token parameter variable">-ntulp</span> <span class="token operator">|</span><span class="token function">grep</span> <span class="token number">16443</span>
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:16443           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">122579</span>/haproxy      
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">netstat</span> <span class="token parameter variable">-ntulp</span> <span class="token operator">|</span><span class="token function">grep</span> <span class="token number">1080</span>
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:1080            <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">122579</span>/haproxy   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 <code>ip a s</code> 查看当前 VIP 绑定的主机，并在停止绑定主机上停止 keepalived 或 HAproxy 服务后，观察 VIP 的漂移：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token function">ip</span> a s
<span class="token number">2</span>: ens37: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="token number">1000</span>
    link/ether 00:0c:29:f6:ab:84 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">192.168</span>.2.207/24 brd <span class="token number">192.168</span>.2.255 scope global noprefixroute ens37
       valid_lft forever preferred_lft forever
    inet <span class="token number">192.168</span>.2.199/32 scope global ens37
       valid_lft forever preferred_lft forever
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ systemctl stop haproxy
<span class="token punctuation">[</span>root@server8-node1 ~<span class="token punctuation">]</span>$ <span class="token function">ip</span> a s
<span class="token number">2</span>: ens37: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="token number">1000</span>
    link/ether 00:0c:29:10:4d:fd brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">192.168</span>.2.208/24 brd <span class="token number">192.168</span>.2.255 scope global noprefixroute ens37
       valid_lft forever preferred_lft forever
    inet <span class="token number">192.168</span>.2.199/32 scope global ens37
       valid_lft forever preferred_lft forever<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>VIP 会根据配置文件中设置的优先级来选择主机。</p>
<h2 id="建立集群"><a class="markdownIt-Anchor" href="#建立集群"></a> 建立集群</h2>
<p>为了组成高可用集群，至少需要 3 个主节点，否则会出现脑裂现象。</p>
<h3 id="初始化主节点"><a class="markdownIt-Anchor" href="#初始化主节点"></a> 初始化主节点</h3>
<p>可以生成默认的 <code>kubeadm-master.config</code> 配置文件，并在修改后指定使用该配置运行命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubeadm config print init-defaults <span class="token operator">></span> /etc/kubernetes/kubeadm-master.config
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ kubeadm init <span class="token parameter variable">--config</span><span class="token operator">=</span>/etc/kubernetes/kubeadm-master.config --upload-certs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>或者，可以使用指定的参数来初始化主节点，其中 <code>service-cidr</code> 和 <code>pod-network-cidr</code> 对应于使用 Flannel 网络插件的网段 10.244.0.0/16。如果使用 Calico 网络插件，则默认使用 <code>pod-network-cidr=192.168.0.0/16</code>：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubeadm init --apiserver-advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.2.204 --image-repository<span class="token operator">=</span>registry.aliyuncs.com/google_containers --kubernetes-version<span class="token operator">=</span>v1.22.3 --service-cidr<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12 --pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>主要使用了以下参数：</p>
<ul>
<li><code>--apiserver-advertise-address</code>：设置本机的 IP 地址。</li>
<li><code>--image-repository</code>：设置镜像仓库地址。</li>
<li><code>--kubernetes-version</code>：设置 Kubernetes 版本。</li>
<li><code>--service-cidr</code>：设置服务器通信使用的 IP 网段。</li>
<li><code>--pod-network-cidr</code>：设置内部的 Pod 节点之间网络可以使用的 IP 段。</li>
<li><code>--upload-certs</code>：上传证书到 <code>kubeadm-certs</code> Secret。</li>
<li><code>--control-plane-endpoint</code>：设置控制节点主机地址。</li>
</ul>
<p>下面使用声明的变量来生成配置：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">APISERVER_ADVERTISE_ADDRESS</span><span class="token operator">=</span><span class="token number">192.168</span>.1.250
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBERNETES_VERSION</span><span class="token operator">=</span>v1.22.3
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SERVICE_CIDR</span><span class="token operator">=</span><span class="token number">10.96</span>.0.0/16
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">POD_NETWORK_CIDR</span><span class="token operator">=</span><span class="token number">10.244</span>.0.1/16
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">CONTROL_PLANE_ENDPOINT</span><span class="token operator">=</span><span class="token number">192.168</span>.1.253:16443
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /nanruan/base/k8s/kubeadm/
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> /nanruan/base/k8s/kubeadm/kubeadm-config.yaml</span>
apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
localAPIEndpoint:
  advertiseAddress: "<span class="token variable">$&#123;APISERVER_ADVERTISE_ADDRESS&#125;</span>"
  bindPort: 6443
kubernetesVersion: "<span class="token variable">$&#123;KUBERNETES_VERSION&#125;</span>"
imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers
controlPlaneEndpoint: "<span class="token variable">$&#123;CONTROL_PLANE_ENDPOINT&#125;</span>"
networking:
  serviceSubnet: "<span class="token variable">$&#123;SERVICE_CIDR&#125;</span>"
  podSubnet: "<span class="token variable">$&#123;POD_NETWORK_CIDR&#125;</span>"
  dnsDomain: "cluster.local"
EOF</span>
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubeadm init <span class="token parameter variable">--config</span><span class="token operator">=</span>/nanruan/base/k8s/kubeadm/kubeadm-config.yaml --upload-certs
Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span>

To start using your cluster, you need to run the following as a regular user:

  <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

Alternatively, <span class="token keyword">if</span> you are the root user, you can run:

  <span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now <span class="token function">join</span> any number of the control-plane <span class="token function">node</span> running the following <span class="token builtin class-name">command</span> on each as root:

  kubeadm <span class="token function">join</span> k8s-250:6443 <span class="token parameter variable">--token</span> 66e1on.yh84w71x6mauu6em <span class="token punctuation">\</span>
        --discovery-token-ca-cert-hash sha256:5849bdad8508feeb3b40e634f7c97f074eb79705d365d097ee75a44374545715 <span class="token punctuation">\</span>
        --control-plane --certificate-key 337bb228b52a88c297d72102652834aeef9666b847247b2b17471a78236af909

Please note that the certificate-key gives access to cluster sensitive data, keep it secret<span class="token operator">!</span>
As a safeguard, uploaded-certs will be deleted <span class="token keyword">in</span> two hours<span class="token punctuation">;</span> If necessary, you can use
<span class="token string">"kubeadm init phase upload-certs --upload-certs"</span> to reload certs afterward.

Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:

kubeadm <span class="token function">join</span> k8s-250:6443 <span class="token parameter variable">--token</span> 66e1on.yh84w71x6mauu6em <span class="token punctuation">\</span>
        --discovery-token-ca-cert-hash sha256:5849bdad8508feeb3b40e634f7c97f074eb79705d365d097ee75a44374545715 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以提前拉取镜像：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubeadm config images pull --image-repository<span class="token operator">=</span>registry.aliyuncs.com/google_containers<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="配置-kubectl"><a class="markdownIt-Anchor" href="#配置-kubectl"></a> 配置 Kubectl</h3>
<p>按照提示，将变量声明写入到 <code>.bashrc</code> 中：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> <span class="token string">"export KUBECONFIG=/etc/kubernetes/admin.conf"</span> <span class="token operator">>></span>~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>或者，将 <code>admin.conf</code> 放入 <code>$HOME/.kube</code> 目录中，才能使用 <code>kubectl</code> 命令操作集群：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube <span class="token operator">&amp;&amp;</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf /root/.kube/config<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>同样地，可以将 <code>admin.conf</code> 放入其他用户的家目录或其他主机上，以赋予其集群管理权限。请注意修改配置文件的所有者和权限：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">scp</span> /etc/kubernetes/admin.conf shareuser@192.168.1.248:/home/shareuser/.kube/config
<span class="token punctuation">[</span>root@k8s-248 ~<span class="token punctuation">]</span>$ <span class="token function">chown</span> <span class="token parameter variable">-R</span> shareuser:shareuser /home/shareuser/.kube
<span class="token punctuation">[</span>root@k8s-248 ~<span class="token punctuation">]</span>$ <span class="token function">chmod</span> <span class="token parameter variable">-R</span> <span class="token number">755</span> /home/shareuser/.kube<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>配置 <code>kubectl</code> 命令的自动补全：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> <span class="token string">"source &lt;(kubectl completion bash)"</span> <span class="token operator">>></span>~/.bashrc
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="部署网络"><a class="markdownIt-Anchor" href="#部署网络"></a> 部署网络</h3>
<p>可以选择安装高性能的 Underlay 网络，如 Flannel 或 Calico。只能安装其中一种网络。</p>
<ul>
<li>
<p>Flannel</p>
<p>使用以下方式安装 Flannel 网络：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl apply <span class="token parameter variable">-f</span> https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="token keyword">in</span> v1.21+, unavailable <span class="token keyword">in</span> v1.25+
podsecuritypolicy.policy/psp.flannel.unprivileged created
clusterrole.rbac.authorization.k8s.io/flannel created
clusterrolebinding.rbac.authorization.k8s.io/flannel created
serviceaccount/flannel created
configmap/kube-flannel-cfg created
daemonset.apps/kube-flannel-ds created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>Calico</p>
<p>使用以下方式安装 Calico 网络：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token function">wget</span> https://kuboard.cn/install-script/calico/calico-3.9.2.yaml
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#192\.168\.0\.0/16#<span class="token variable">$&#123;pod_SUBNET&#125;</span>#"</span> calico-3.9.2.yaml
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ kubectl apply <span class="token parameter variable">-f</span> calico-3.9.2.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>根据官方网站提供的安装方式：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> https://docs.projectcalico.org/manifests/tigera-operator.yaml
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> https://docs.projectcalico.org/manifests/custom-resources.yaml
installation.operator.tigera.io/default created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h3 id="删除网络"><a class="markdownIt-Anchor" href="#删除网络"></a> 删除网络</h3>
<p>要删除 Calico 网络，请先通过配置文件删除相关资源：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl delete <span class="token parameter variable">-f</span> custom-resources.yaml
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl delete <span class="token parameter variable">-f</span> tigera-operator.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>然后，在每个节点上移除 Calico 的配置文件，并删除 CoreDNS 的 Pod，最后重新启动 kubelet。等待相关的 Pod 全部移除，确保 CoreDNS 处于 pending 状态即可：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server5-node1 ~<span class="token punctuation">]</span>$ <span class="token function">rm</span> <span class="token parameter variable">-rf</span> /etc/cni/net.d/*calico*
<span class="token punctuation">[</span>root@server1 ~<span class="token punctuation">]</span>$ systemctl restart kubelet
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl delete <span class="token parameter variable">-n</span> kube-system po coredns-7f6cbbb7b8-vvtxz
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token function">ifconfig</span> cni0 down
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ <span class="token function">ip</span> <span class="token function">link</span> delete cni0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="建立完毕"><a class="markdownIt-Anchor" href="#建立完毕"></a> 建立完毕</h3>
<p>等待网络部署完成，所有 8 个容器都部署完毕后，主节点就搭建好了：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl get pod <span class="token parameter variable">-n</span> kube-system <span class="token parameter variable">-o</span> wide <span class="token parameter variable">--watch</span>
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ journalctl <span class="token parameter variable">-u</span> kubelet <span class="token parameter variable">-f</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>添加 Node 标签，其中 NodeRole 角色名可以是 master（主节点）或 worker（从节点）。NodeName 是主机名，NodeEnv 可以是 base（基础服务）或 app（应用）：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl label <span class="token function">node</span> k8s-250 <span class="token assign-left variable">NodeRole</span><span class="token operator">=</span>master
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl label <span class="token function">node</span> k8s-250 <span class="token assign-left variable">NodeName</span><span class="token operator">=</span>k8s-250
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl label <span class="token function">node</span> k8s-250 <span class="token assign-left variable">NodeEnv</span><span class="token operator">=</span>base<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="加入集群"><a class="markdownIt-Anchor" href="#加入集群"></a> 加入集群</h2>
<p>加入集群按照以下步骤进行操作。</p>
<h3 id="获取参数"><a class="markdownIt-Anchor" href="#获取参数"></a> 获取参数</h3>
<p>加入集群所需的 3 个参数如下：</p>
<ul>
<li>
<p>Token</p>
<p>Token 的有效期为 1 天。在失效后，可以使用 <code>kubeadm token create</code> 命令重新创建：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubeadm token create
xjp771.yrjc4oe1thjjt112
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubeadm token list
TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA <span class="token environment constant">GROUPS</span>
xjp771.yrjc4oe1thjjt112   23h         <span class="token number">2022</span>-04-21T02:14:35Z   authentication,signing   <span class="token operator">&lt;</span>none<span class="token operator">></span>                                                     system:bootstrappers:kubeadm:default-node-token<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>Discovery Token CA Cert Hash</p>
<p>获得 Discovery Token CA Cert Hash 参数的方法如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ openssl x509 <span class="token parameter variable">-pubkey</span> <span class="token parameter variable">-in</span> /etc/kubernetes/pki/ca.crt <span class="token operator">|</span> openssl rsa <span class="token parameter variable">-pubin</span> <span class="token parameter variable">-outform</span> der <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> openssl dgst <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-hex</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/^.* //'</span>
1499ca908be1d430887b67d4dbfff06a5374cf3d340d3c0ba9db1aa51ad9ddfb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p>Certificate Key</p>
<p>更新证书的 key：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubeadm init phase upload-certs --upload-certs
I0420 <span class="token number">10</span>:15:58.086168    <span class="token number">6701</span> version.go:255<span class="token punctuation">]</span> remote version is much newer: v1.23.5<span class="token punctuation">;</span> falling back to: stable-1.22
<span class="token punctuation">[</span>upload-certs<span class="token punctuation">]</span> Storing the certificates <span class="token keyword">in</span> Secret <span class="token string">"kubeadm-certs"</span> <span class="token keyword">in</span> the <span class="token string">"kube-system"</span> Namespace
<span class="token punctuation">[</span>upload-certs<span class="token punctuation">]</span> Using certificate key:
937bf7194bd6e346e177f3a64de9ec01e9043828cb263f0ed80bddc359a351e2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h3 id="加入从节点"><a class="markdownIt-Anchor" href="#加入从节点"></a> 加入从节点</h3>
<p>加入从节点只需要使用 <code>token</code> 和 <code>discovery-token-ca-cert-hash</code> 参数。请指定集群的 Control Plane 或单个主节点的 IP 地址和端口号 6443，并使用 <code>kubeadm join</code> 命令将从节点加入集群：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-248 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> <span class="token string">"192.168.1.250   k8s-250"</span> <span class="token operator">>></span> /etc/hosts
<span class="token punctuation">[</span>root@k8s-248 ~<span class="token punctuation">]</span>$ kubeadm <span class="token function">join</span> k8s-250:6443 <span class="token parameter variable">--token</span> xjp771.yrjc4oe1thjjt112 --discovery-token-ca-cert-hash sha256:1499ca908be1d430887b67d4dbfff06a5374cf3d340d3c0ba9db1aa51ad9ddfb
This <span class="token function">node</span> has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run <span class="token string">'kubectl get nodes'</span> on the control-plane to see this <span class="token function">node</span> <span class="token function">join</span> the cluster.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>加入成功后，记得在主节点添加节点标签：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-248 ~<span class="token punctuation">]</span>$ kubectl label <span class="token function">node</span> k8s-248 <span class="token assign-left variable">NodeRole</span><span class="token operator">=</span>worker
<span class="token punctuation">[</span>root@k8s-248 ~<span class="token punctuation">]</span>$ kubectl label <span class="token function">node</span> k8s-248 <span class="token assign-left variable">NodeName</span><span class="token operator">=</span>k8s-248
<span class="token punctuation">[</span>root@k8s-248 ~<span class="token punctuation">]</span>$ kubectl label <span class="token function">node</span> k8s-248 <span class="token assign-left variable">NodeEnv</span><span class="token operator">=</span>base<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>查看已加入的节点：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl get nodes
NAME             STATUS     ROLES                  AGE   VERSION
server4-master   Ready      control-plane,master   31m   v1.22.3
server5-node1    Ready      <span class="token operator">&lt;</span>none<span class="token operator">></span>                 84s   v1.22.3
server6-node2    NotReady   <span class="token operator">&lt;</span>none<span class="token operator">></span>                 19s   v1.22.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 <code>--all-namespaces</code> 参数来查看所有节点上的容器运行信息，确保所有的 Pod 都处于运行状态：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl get pod --all-namespaces <span class="token parameter variable">-o</span> wide
NAMESPACE     NAME                              READY   STATUS    RESTARTS   AGE    IP              NODE      NOMINATED NODE   READINESS GATES
kube-system   coredns-7d89d9b6b8-6gkhb          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          101m   <span class="token number">10.244</span>.0.2      k8s-250   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   coredns-7d89d9b6b8-qwcmx          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          101m   <span class="token number">10.244</span>.0.3      k8s-250   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   etcd-k8s-248                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          92m    <span class="token number">192.168</span>.1.248   k8s-248   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   etcd-k8s-249                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          93m    <span class="token number">192.168</span>.1.249   k8s-249   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   etcd-k8s-250                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          101m   <span class="token number">192.168</span>.1.250   k8s-250   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-apiserver-k8s-248            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          91m    <span class="token number">192.168</span>.1.248   k8s-248   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-apiserver-k8s-249            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          91m    <span class="token number">192.168</span>.1.249   k8s-249   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-apiserver-k8s-250            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          91m    <span class="token number">192.168</span>.1.250   k8s-250   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-controller-manager-k8s-248   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          90m    <span class="token number">192.168</span>.1.248   k8s-248   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-controller-manager-k8s-249   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          90m    <span class="token number">192.168</span>.1.249   k8s-249   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-controller-manager-k8s-250   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          90m    <span class="token number">192.168</span>.1.250   k8s-250   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-flannel-ds-2vtj4             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          93m    <span class="token number">192.168</span>.1.248   k8s-248   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-flannel-ds-8t46b             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          101m   <span class="token number">192.168</span>.1.250   k8s-250   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-flannel-ds-pj9s9             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          93m    <span class="token number">192.168</span>.1.249   k8s-249   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-proxy-8msfm                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          93m    <span class="token number">192.168</span>.1.249   k8s-249   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-proxy-g85tq                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          101m   <span class="token number">192.168</span>.1.250   k8s-250   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-proxy-htszg                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          93m    <span class="token number">192.168</span>.1.248   k8s-248   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-scheduler-k8s-248            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          90m    <span class="token number">192.168</span>.1.248   k8s-248   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-scheduler-k8s-249            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          90m    <span class="token number">192.168</span>.1.249   k8s-249   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-scheduler-k8s-250            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          90m    <span class="token number">192.168</span>.1.250   k8s-250   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl get all --all-namespaces <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="加入主节点"><a class="markdownIt-Anchor" href="#加入主节点"></a> 加入主节点</h3>
<p>加入主节点的步骤与加入从节点类似。同样需要指定集群的 Control Plane 或单个主节点的 IP 地址和端口号 6443，并使用 <code>kubeadm join</code> 命令将主节点加入集群：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-248 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> <span class="token string">"192.168.1.250   k8s-250"</span> <span class="token operator">>></span> /etc/hosts
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ kubeadm <span class="token function">join</span> k8s-250:644 <span class="token parameter variable">--token</span> 4sz9hf.dwt05n1ohpb772au <span class="token punctuation">\</span>
        --discovery-token-ca-cert-hash sha256:864ee6f29ac83d7ec0db3e75c2b54a70ac7622c8c82e52cc71511255febf5b28 <span class="token punctuation">\</span>
        --control-plane --certificate-key af928d1032d723ae3f16c7218b07afb41b4d588d746bbeb6ed9c657a460591cd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>添加集群控制权限：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube <span class="token operator">&amp;&amp;</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> <span class="token string">"source &lt;(kubectl completion bash)"</span> <span class="token operator">>></span>~/.bashrc
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>添加节点标签：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ kubectl label <span class="token function">node</span> k8s-249 <span class="token assign-left variable">NodeRole</span><span class="token operator">=</span>master
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ kubectl label <span class="token function">node</span> k8s-249 <span class="token assign-left variable">NodeName</span><span class="token operator">=</span>k8s-249
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ kubectl label <span class="token function">node</span> k8s-249 <span class="token assign-left variable">NodeEnv</span><span class="token operator">=</span>base<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>还可以参考快速搭建工具 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/fanux/sealos">SealOS</a>。</p>
<h2 id="移除节点"><a class="markdownIt-Anchor" href="#移除节点"></a> 移除节点</h2>
<p>如果您想从集群中移除节点，首先使用 <code>drain</code> 命令驱逐节点上运行的 Pod：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl drain k8s-249 --ignore-daemonsets
node/k8s-249 cordoned
WARNING: ignoring DaemonSet-managed Pods: kube-system/kube-flannel-ds-8rfqm, kube-system/kube-proxy-qnxcw
evicting pod base/zookeeper-2
evicting pod base/zookeeper-0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在所有的 Pod 转移完成后，可以运行以下命令删除节点：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl delete <span class="token function">node</span> k8s-249
<span class="token function">node</span> <span class="token string">"k8s-249"</span> deleted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>如果需要彻底移除节点，还可以在要移除的节点上运行以下命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ <span class="token function">yes</span> <span class="token operator">|</span> kubeadm reset
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ <span class="token function">rm</span> <span class="token parameter variable">-rf</span> /var/lib/cni/ /etc/cni/net.d <span class="token environment constant">$HOME</span>/.kube/config /var/lib/etcd
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ <span class="token function">ifconfig</span> cni0 down
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ <span class="token function">ip</span> <span class="token function">link</span> delete cni0
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ <span class="token function">ifconfig</span> flannel.1 down
<span class="token punctuation">[</span>root@k8s-249 ~<span class="token punctuation">]</span>$ <span class="token function">ip</span> <span class="token function">link</span> delete flannel.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="修改配置"><a class="markdownIt-Anchor" href="#修改配置"></a> 修改配置</h2>
<p>以下是一些常见的配置项目。</p>
<h3 id="开放权限"><a class="markdownIt-Anchor" href="#开放权限"></a> 开放权限</h3>
<p>有时为了测试目的，需要将集群管理员角色绑定到所有 <code>sa</code>（service account）账号上：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubectl create clusterrolebinding permissive-binding <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>cluster-admin <span class="token parameter variable">--group</span><span class="token operator">=</span>system:serviceaccounts
clusterrolebinding.rbac.authorization.k8s.io/permissive-binding created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>删除该绑定方法：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master <span class="token number">2</span><span class="token punctuation">]</span>$ kubectl delete clusterrolebinding permissive-binding
clusterrolebinding.rbac.authorization.k8s.io <span class="token string">"permissive-binding"</span> deleted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="允许主节点部署"><a class="markdownIt-Anchor" href="#允许主节点部署"></a> 允许主节点部署</h3>
<p>为了允许在主节点上部署应用程序，需要移除主节点上的污点：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl taint nodes <span class="token parameter variable">--all</span> node-role.kubernetes.io/master<span class="token operator">=</span>true:NoSchedule-
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl get no <span class="token parameter variable">-o</span> yaml <span class="token operator">|</span> <span class="token function">grep</span> taint <span class="token parameter variable">-A</span> <span class="token number">5</span>
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl taint nodes k8s-250 node.kubernetes.io/unreachable-<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>重新添加污点方法：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master pv<span class="token punctuation">]</span>$ kubectl taint nodes k8s-master node-role.kubernetes.io/master<span class="token operator">=</span>true:NoSchedule
node/k8s-master tainted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="修改暴露端口范围"><a class="markdownIt-Anchor" href="#修改暴露端口范围"></a> 修改暴露端口范围</h3>
<p>可以修改 <code>NodePort</code> 端口范围。在 <code>kube-apiserver.yaml</code> 文件中添加一行 <code>service-node-port-range</code>，服务器会自动更新：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'40a\    - --service-node-port-range=1-65535'</span> /etc/kubernetes/manifests/kube-apiserver.yaml
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> /etc/kubernetes/manifests/kube-apiserver.yaml
    - --tls-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.crt
    - --tls-private-key-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.key
    - --service-node-port-range<span class="token operator">=</span><span class="token number">1</span>-65535
    image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.3
    imagePullPolicy: IfNotPresent<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="恢复健康检查"><a class="markdownIt-Anchor" href="#恢复健康检查"></a> 恢复健康检查</h3>
<p>可以注释掉 <code>scheduler</code> 和 <code>controller-manager</code> 配置文件中的端口绑定，以避免健康检查出错：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s/    - --port=0/#    - --port=0/g"</span> /etc/kubernetes/manifests/kube-controller-manager.yaml
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s/    - --port=0/#    - --port=0/g"</span> /etc/kubernetes/manifests/kube-scheduler.yaml
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ systemctl restart kubelet.service
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl get cs
Warning: v1 ComponentStatus is deprecated <span class="token keyword">in</span> v1.19+
NAME                 STATUS    MESSAGE                         ERROR
scheduler            Healthy   ok                              
controller-manager   Healthy   ok                              
etcd-0               Healthy   <span class="token punctuation">&#123;</span><span class="token string">"health"</span><span class="token builtin class-name">:</span><span class="token string">"true"</span>,<span class="token string">"reason"</span><span class="token builtin class-name">:</span><span class="token string">""</span><span class="token punctuation">&#125;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="集群升级"><a class="markdownIt-Anchor" href="#集群升级"></a> 集群升级</h2>
<p>整个集群升级需要分三步进行：</p>
<ul>
<li>第一步是主节点升级 <code>kubeadm</code> 和 <code>kubectl</code>。</li>
<li>第二步是主节点升级 <code>kubelet</code>。</li>
<li>第三步是从节点升级 <code>kubelet</code>。</li>
</ul>
<p>主节点升级 <code>kubeadm</code> 和 <code>kubectl</code> 不会对集群的运行产生影响：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ yum list <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'kubeadm\|kubectl\|kubelet'</span>
kubeadm.x86_64                           <span class="token number">1.22</span>.3-0                      @kubernetes
kubectl.x86_64                           <span class="token number">1.22</span>.3-0                      @kubernetes
kubelet.x86_64                           <span class="token number">1.22</span>.3-0                      @kubernetes
kubeadm.x86_64                           <span class="token number">1.23</span>.5-0                      kubernetes
kubectl.x86_64                           <span class="token number">1.23</span>.5-0                      kubernetes
kubelet.x86_64                           <span class="token number">1.23</span>.5-0                      kubernetes
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ yum <span class="token parameter variable">-y</span> <span class="token function">install</span> kubeadm-1.23.5-0 kubectl-1.23.5-0
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubeadm upgrade plan
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubeadm upgrade apply v1.23.5-0 <span class="token parameter variable">--config</span> /nanruan/base/k8s/kubeadm/kubeadm-config.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主节点和从节点升级 <code>kubelet</code> 的步骤是一样的。首先禁用调度，然后升级并重启 <code>kubelet</code>，最后恢复允许调度：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl drain k8s-250 --ignore-daemonsets
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ yum <span class="token parameter variable">-y</span> <span class="token function">install</span> kubelet-1.23.5-0
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ systemctl daemon-reload
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ systemctl restart kubelet
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ systemctl status kubelet
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl uncordon k8s-250
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl get nodes
<span class="token punctuation">[</span>root@k8s-250 ~<span class="token punctuation">]</span>$ kubectl get all --all-namespaces<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="故障处理"><a class="markdownIt-Anchor" href="#故障处理"></a> 故障处理</h2>
<p>一些集群组建时遇到的问题.</p>
<h3 id="没有-pod-network-cidr"><a class="markdownIt-Anchor" href="#没有-pod-network-cidr"></a> 没有 pod-network-cidr</h3>
<p>在安装 Flannel 时，出现错误提示缺少分配的 Pod CIDR。这可能是因为在使用 kubeadm 初始化时没有指定 <code>--pod-network-cidr</code> 参数，或者 <code>kube-flannel.yml</code> 文件中的 “Network” 字段与 <code>--pod-network-cidr</code> 参数不一致：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl logs <span class="token parameter variable">-n</span> kube-system kube-flannel-ds-7xp24 
I1103 04:42:22.796211       <span class="token number">1</span> vxlan.go:137<span class="token punctuation">]</span> VXLAN config: <span class="token assign-left variable">VNI</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">Port</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">GBP</span><span class="token operator">=</span>false <span class="token assign-left variable">Learning</span><span class="token operator">=</span>false <span class="token assign-left variable">DirectRouting</span><span class="token operator">=</span>false
E1103 04:42:22.797028       <span class="token number">1</span> main.go:325<span class="token punctuation">]</span> Error registering network: failed to acquire lease: <span class="token function">node</span> <span class="token string">"server4-master"</span> pod cidr not assigned
I1103 04:42:22.797248       <span class="token number">1</span> main.go:439<span class="token punctuation">]</span> Stopping shutdownHandler<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>要解决此问题，可以修改 <code>kube-controller-manager.yaml</code> 配置文件，在其中添加 <code>- --allocate-node-cidrs=true</code> 和 <code>- --cluster-cidr=10.244.0.0/16</code> 参数：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> /etc/kubernetes/manifests/kube-controller-manager.yaml
spec:
  containers:
  - command:
    - kube-controller-manager
    - --allocate-node-cidrs<span class="token operator">=</span>true
    - --cluster-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后，删除错误的 Flannel 容器并重新创建，这样就可以使用正确的配置了：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl delete pod <span class="token parameter variable">-n</span> kube-system kube-flannel-*
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl cluster-info dump <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-m</span> <span class="token number">1</span> cluster-cidr
                            <span class="token string">"--cluster-cidr=10.244.0.0/16"</span>,<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="没有-controlplaneendpoint"><a class="markdownIt-Anchor" href="#没有-controlplaneendpoint"></a> 没有 controlPlaneEndpoint</h3>
<p>在将第二个主节点加入已存在的单节点集群过程中，预检阶段会报错缺少 controlPlaneEndpoint。这是因为在初始化时没有指定 <code>--control-plane-endpoint</code> 参数导致的：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server1 ~<span class="token punctuation">]</span>$ kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.2.204:6443 <span class="token parameter variable">--token</span> nre8hl.4awo2mnyxr5l0tsu      --discovery-token-ca-cert-hash sha256:8055ad40e280bc4b48b0c3b4daea9aa3f515d3b2fea5fb3ae3fcad398c325a52      --control-plane --certificate-key 5ac22cea4cfc19753cd289c96b968957554b4e4204fe47fc3f56a53dded96716
error execution phase preflight: 
One or <span class="token function">more</span> conditions <span class="token keyword">for</span> hosting a new control plane instance is not satisfied.

unable to <span class="token function">add</span> a new control plane instance a cluster that doesn't have a stable controlPlaneEndpoint address

Please ensure that:
* The cluster has a stable controlPlaneEndpoint address.
* The certificates that must be shared among control plane instances are provided.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>要解决此问题，可以使用 <code>kubectl edit</code> 命令编辑 <code>kubeadm-config</code> 配置文件，并将 <code>controlPlaneEndpoint</code> 地址添加为虚拟 IP 或正在运行的主节点的 IP：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl edit cm kubeadm-config <span class="token parameter variable">-n</span> kube-system
    imageRepository: registry.aliyuncs.com/google_containers
    kind: ClusterConfiguration
    controlPlaneEndpoint: <span class="token number">192.168</span>.2.204:6443
    kubernetesVersion: v1.22.3
    networking:
      dnsDomain: cluster.local
      podSubnet: <span class="token number">10.244</span>.0.0/16<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>保存并退出编辑器。然后，重新执行 <code>kubeadm join</code> 命令将第二个主节点加入集群。这样就能成功添加第二个主节点，完成集群的扩容。</p>
<h3 id="token-过期"><a class="markdownIt-Anchor" href="#token-过期"></a> Token 过期</h3>
<p>当加入集群时出现 “x509: certificate has expired or is not yet valid” 错误时，可以重新生成令牌：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubeadm token create
87668a.lfvdqsr3l5ijlode
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubeadm token list
TOKEN                     TTL       EXPIRES                     USAGES                   DESCRIPTION   EXTRA <span class="token environment constant">GROUPS</span>
1yrznt.lzj1kl0qecosl4es   23h       <span class="token number">2019</span>-07-21T13:14:33+08:00   authentication,signing   <span class="token operator">&lt;</span>none<span class="token operator">></span>        system:bootstrappers:kubeadm:default-node-token
87668a.lfvdqsr3l5ijlode   23h       <span class="token number">2019</span>-07-21T13:24:28+08:00   authentication,signing   <span class="token operator">&lt;</span>none<span class="token operator">></span>        system:bootstrappers:kubeadm:default-node-token
<span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ kubeadm init phase upload-certs --upload-certs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后在客户端同步时间，并再次尝试加入集群：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span>$ ntpdate cn.pool.ntp.org
<span class="token number">20</span> Jul <span class="token number">13</span>:25:59 ntpdate<span class="token punctuation">[</span><span class="token number">118642</span><span class="token punctuation">]</span>: step <span class="token function">time</span> server <span class="token number">199.182</span>.204.197 offset <span class="token number">137559.272548</span> sec<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="证书过期"><a class="markdownIt-Anchor" href="#证书过期"></a> 证书过期</h3>
<p>可以使用以下命令查看证书的有效期：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubeadm certs check-expiration
<span class="token punctuation">[</span>check-expiration<span class="token punctuation">]</span> Reading configuration from the cluster<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>check-expiration<span class="token punctuation">]</span> FYI: You can <span class="token function">look</span> at this config <span class="token function">file</span> with <span class="token string">'kubectl -n kube-system get cm kubeadm-config -o yaml'</span>

CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Nov 03, <span class="token number">2022</span> 05:36 UTC   217d                                    no      
apiserver                  Nov 03, <span class="token number">2022</span> 05:36 UTC   217d            ca                      no      
apiserver-etcd-client      Nov 03, <span class="token number">2022</span> 05:36 UTC   217d            etcd-ca                 no      
apiserver-kubelet-client   Nov 03, <span class="token number">2022</span> 05:36 UTC   217d            ca                      no      
controller-manager.conf    Nov 03, <span class="token number">2022</span> 05:36 UTC   217d                                    no      
etcd-healthcheck-client    Nov 03, <span class="token number">2022</span> 05:36 UTC   217d            etcd-ca                 no      
etcd-peer                  Nov 03, <span class="token number">2022</span> 05:36 UTC   217d            etcd-ca                 no      
etcd-server                Nov 03, <span class="token number">2022</span> 05:36 UTC   217d            etcd-ca                 no      
front-proxy-client         Nov 03, <span class="token number">2022</span> 05:36 UTC   217d            front-proxy-ca          no      
scheduler.conf             Nov 03, <span class="token number">2022</span> 05:36 UTC   217d                                    no      

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      Nov 01, <span class="token number">2031</span> 05:36 UTC   9y              no      
etcd-ca                 Nov 01, <span class="token number">2031</span> 05:36 UTC   9y              no      
front-proxy-ca          Nov 01, <span class="token number">2031</span> 05:36 UTC   9y              no   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重新生成所有证书：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubeadm certs renew all
<span class="token punctuation">[</span>renew<span class="token punctuation">]</span> Reading configuration from the cluster<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>renew<span class="token punctuation">]</span> FYI: You can <span class="token function">look</span> at this config <span class="token function">file</span> with <span class="token string">'kubectl -n kube-system get cm kubeadm-config -o yaml'</span>

certificate embedded <span class="token keyword">in</span> the kubeconfig <span class="token function">file</span> <span class="token keyword">for</span> the admin to use and <span class="token keyword">for</span> kubeadm itself renewed
certificate <span class="token keyword">for</span> serving the Kubernetes API renewed
certificate the apiserver uses to access etcd renewed
certificate <span class="token keyword">for</span> the API server to connect to kubelet renewed
certificate embedded <span class="token keyword">in</span> the kubeconfig <span class="token function">file</span> <span class="token keyword">for</span> the controller manager to use renewed
certificate <span class="token keyword">for</span> liveness probes to healthcheck etcd renewed
certificate <span class="token keyword">for</span> etcd nodes to communicate with each other renewed
certificate <span class="token keyword">for</span> serving etcd renewed
certificate <span class="token keyword">for</span> the front proxy client renewed
certificate embedded <span class="token keyword">in</span> the kubeconfig <span class="token function">file</span> <span class="token keyword">for</span> the scheduler manager to use renewed

Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据提示分别在所有主节点上重启组件容器：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">docker</span> <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">'k8s_kube-apiserver|k8s_kube-controller-manager|k8s_kube-scheduler|k8s_etcd_etcd'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token parameter variable">-F</span> <span class="token string">' '</span> <span class="token string">'&#123;print $1&#125;'</span> <span class="token operator">|</span><span class="token function">xargs</span> <span class="token function">docker</span> restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="证书不符"><a class="markdownIt-Anchor" href="#证书不符"></a> 证书不符</h3>
<p>如果在加入集群时出现 “x509: certificate is valid for 10.96.0.1, 192.168.2.204, not 192.168.2.199” 的错误，提示证书的 IP 地址不符合要求，这通常在更新节点的 <code>apiserver-advertise-address</code> 或 <code>controlPlaneEndpoint</code> 时会发生。解决方法是删除当前集群下 <code>apiserver</code> 的证书和密钥，然后重新生成：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ <span class="token function">rm</span> <span class="token parameter variable">-f</span> /etc/kubernetes/pki/apiserver.*<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>设置原先主机的 IP 地址为 192.168.2.204，现在的虚拟 IP 地址为 192.168.2.199：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ kubeadm init phase certs apiserver --apiserver-advertise-address <span class="token number">192.168</span>.2.204 --apiserver-cert-extra-sans <span class="token number">192.168</span>.2.199
<span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ kubeadm alpha certs renew admin.conf
Kubeadm experimental sub-commands<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>重启 API Server，然后查看证书：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ kubectl <span class="token parameter variable">-n</span> kube-system delete pod kube-apiserver-server4 kube-apiserver-server6
pod <span class="token string">"kube-apiserver-server4"</span> deleted
pod <span class="token string">"kube-apiserver-server6"</span> deleted
<span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ openssl x509 <span class="token parameter variable">-in</span> /etc/kubernetes/pki/apiserver.crt <span class="token parameter variable">-noout</span> <span class="token parameter variable">-text</span>
Certificate:
    Data:
        Version: <span class="token number">3</span> <span class="token punctuation">(</span>0x2<span class="token punctuation">)</span>
        Serial Number: <span class="token number">2687592491658220129</span> <span class="token punctuation">(</span>0x254c3f21b64b9261<span class="token punctuation">)</span>
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: <span class="token assign-left variable">CN</span><span class="token operator">=</span>kubernetes
        Validity
            Not Before: Apr  <span class="token number">4</span> <span class="token number">16</span>:21:14 <span class="token number">2022</span> GMT
            Not After <span class="token builtin class-name">:</span> Apr <span class="token number">19</span> <span class="token number">13</span>:48:19 <span class="token number">2023</span> GMT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将新的 <code>admin.conf</code> 文件复制到其他需要访问集群的主节点上：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4 ~<span class="token punctuation">]</span>$ <span class="token function">scp</span> /etc/kubernetes/admin.conf root@192.168.2.206:./.kube<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>现在可以加入新的主节点了。</p>
<h3 id="cni0-地址错误"><a class="markdownIt-Anchor" href="#cni0-地址错误"></a> cni0 地址错误</h3>
<p>在重新构建 Kubernetes 集群后，由于节点上残留了未删除的虚拟网卡，导致创建 Pod 失败，提示 cni0 地址冲突：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server7-master ~<span class="token punctuation">]</span>$ kubectl describe po kubia-74967b5695-ftk77
  Warning  FailedCreatePodSandBox  56s <span class="token punctuation">(</span>x4 over 59s<span class="token punctuation">)</span>   kubelet            <span class="token punctuation">(</span>combined from similar events<span class="token punctuation">)</span>: Failed to create pod sandbox: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to <span class="token builtin class-name">set</span> up sandbox container <span class="token string">"18dd9bc5076666ed605b2d3331864859454878d7e1f9fae2160f1be71c59c48f"</span> network <span class="token keyword">for</span> pod <span class="token string">"kubia-74967b5695-ftk77"</span><span class="token builtin class-name">:</span> networkPlugin cni failed to <span class="token builtin class-name">set</span> up pod <span class="token string">"kubia-74967b5695-ftk77_default"</span> network: failed to delegate add: failed to <span class="token builtin class-name">set</span> bridge addr: <span class="token string">"cni0"</span> already has an IP address different from <span class="token number">10.100</span>.4.1/24
<span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">ip</span> a
<span class="token number">5</span>: cni0: <span class="token operator">&lt;</span>NO-CARRIER,BROADCAST,MULTICAST,UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noqueue state DOWN group default qlen <span class="token number">1000</span>
    link/ether <span class="token number">92</span>:1d:b1:d9:ba:19 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">10.100</span>.9.1/24 brd <span class="token number">10.100</span>.9.255 scope global cni0
       valid_lft forever preferred_lft forever<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解决方法是手动删除网卡，让它重新创建：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">ifconfig</span> cni0 down
<span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">ip</span> <span class="token function">link</span> delete cni0
<span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ <span class="token function">ip</span> a
<span class="token number">926</span>: cni0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1450</span> qdisc noqueue state UP group default qlen <span class="token number">1000</span>
    link/ether <span class="token number">92</span>:6a:c8:8b:2c:5b brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">10.100</span>.4.1/24 brd <span class="token number">10.100</span>.4.255 scope global cni0
       valid_lft forever preferred_lft forever<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="etcd-错误"><a class="markdownIt-Anchor" href="#etcd-错误"></a> etcd 错误</h3>
<p>在 etcd 中存在已被删除的节点记录时，当节点重新加入集群时会报错 “etcd cluster is not healthy: failed to dial endpoint”。这时需要手动维护 etcd 数据库。</p>
<p>进入节点的 etcd 容器内部，查询 etcd 集群的成员列表，然后删除错误的成员，这样集群就恢复正常了：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server6 ~<span class="token punctuation">]</span>$ kubectl <span class="token parameter variable">-n</span> kube-system <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> etcd-k8s-239 -- <span class="token function">sh</span>
sh-5.0<span class="token comment"># export ETCDCTL_API=3</span>
sh-5.0<span class="token comment"># alias etcdctl='etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key'</span>
sh-5.0<span class="token comment"># etcdctl member list</span>
2e1d3dc8363ee756, started, server5, https://192.168.2.205:2380, https://192.168.2.205:2379, <span class="token boolean">false</span>
4b8b623fba4c1f57, started, server6, https://192.168.2.206:2380, https://192.168.2.206:2379, <span class="token boolean">false</span>
ad703513a2c4e54a, started, server4, https://192.168.2.204:2380, https://192.168.2.204:2379, <span class="token boolean">false</span>
sh-5.0<span class="token comment"># etcdctl member remove 63bfe05c4646fb08</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="阿里云部署"><a class="markdownIt-Anchor" href="#阿里云部署"></a> 阿里云部署</h2>
<p>在阿里云上部署 Kubernetes 时，ECS 不支持自建 VIP。当将 SLB 的 VIP 指定为高可用地址时，初始化主节点会失败。这是因为 4 层 SLB 不支持其调度的后端服务器访问其 VIP，也就是服务器不能同时充当服务端和客户端。</p>
<p>解决方法是在 hosts 文件中解析一个域名作为 controlPlaneEndpoint 地址。主节点的 hosts 文件将 127.0.0.1 指向该域名，而节点的 hosts 文件则将该域名解析为 SLB 地址即可。</p>
<p>参考网址:</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.cnblogs.com/gmmy/p/12372805.html">https://www.cnblogs.com/gmmy/p/12372805.html</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.cnblogs.com/noah-luo/p/13218837.html">https://www.cnblogs.com/noah-luo/p/13218837.html</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://zhuanlan.zhihu.com/p/107703112">https://zhuanlan.zhihu.com/p/107703112</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.51cto.com/caiyuanji/2405434">https://blog.51cto.com/caiyuanji/2405434</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/chenleiking/article/details/84841394">https://blog.csdn.net/chenleiking/article/details/84841394</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://jimmysong.io/kubernetes-handbook/">https://jimmysong.io/kubernetes-handbook/</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jianshu.com/p/ba94db1c3599">https://www.jianshu.com/p/ba94db1c3599</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/weixin_44334279/article/details/119355653">https://blog.csdn.net/weixin_44334279/article/details/119355653</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jianshu.com/p/d645bbe8e621">https://www.jianshu.com/p/d645bbe8e621</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.kubernetes.org.cn/7033.html">https://www.kubernetes.org.cn/7033.html</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>干杯！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="../images/wechatpay.png" alt="assassing 微信">
        <span>微信</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>assassing
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://blog.x2b.net/1488965608/" title="K8s 系统部署">https://blog.x2b.net/1488965608/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="followme">
  <span>欢迎订阅</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="../atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="../4087499240/" rel="prev" title="Linux 目录配置标准与结构">
                  <i class="fa fa-chevron-left"></i> Linux 目录配置标准与结构
                </a>
            </div>
            <div class="post-nav-item">
                <a href="../1457906456/" rel="next" title="K8s 组件介绍">
                  K8s 组件介绍 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2020 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">assassing</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">221k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">12:16</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener external nofollow noreferrer" target="_blank">NexT.Gemini</a> on Kubernetes
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/hxz393" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener external nofollow noreferrer" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@next-theme/pjax@0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="../js/comments.js"></script><script src="../js/utils.js"></script><script src="../js/motion.js"></script><script src="../js/next-boot.js"></script><script src="../js/pjax.js"></script>

  <script src="https://unpkg.com/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="../js/third-party/search/local-search.js"></script>




  <script src="../js/third-party/pace.js"></script>

  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://unpkg.com/katex@0.16.4/dist/katex.min.css" integrity="sha256-gMRN4/6qeELzO1wbFa8qQLU8kfuF2dnAPiUoI0ATjx8=" crossorigin="anonymous">
  <script class="next-config" data-name="katex" type="application/json">{"copy_tex_js":{"url":"https://unpkg.com/katex@0.16.4/dist/contrib/copy-tex.min.js","integrity":"sha256-Us54+rSGDSTvIhKKUs4kygE2ipA0RXpWWh0/zLqw3bs="}}</script>
  <script src="../js/third-party/math/katex.js"></script>


  <script src="https://unpkg.com/quicklink@2.3.0/dist/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":5000,"priority":true,"url":"https://blog.x2b.net/1488965608/"}</script>
  <script src="../js/third-party/quicklink.js"></script>
<link rel="stylesheet" href="https://unpkg.com/gitalk@1.8.0/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"hxz393","repo":"x2b.net-deploy","client_id":"26664aab919326dcf7e7","client_secret":"40882da22b7a77aea4a985ccd95a9363cfb7ba9a","admin_user":"hxz393","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://unpkg.com/gitalk@1.8.0/dist/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"d41d8cd98f00b204e9800998ecf8427e"}</script>
<script src="../js/third-party/comments/gitalk.js"></script>


        <script src="//cdn.jsdelivr.net/npm/js-base64/base64.min.js"></script>
        <script>
        const hasAttr = (e,a) => a.some(_=> e.attr(_)!==undefined);
        $('a').each(function() {
          const $this = $(this);
          if(hasAttr($this,["data-fancybox","ignore-external-link"])) return;
          const href = $this.attr('href');
          if (href && href.match('^((http|https|thunder|qqdl|ed2k|Flashget|qbrowser|ftp|rtsp|mms)://)')) {
            const strs = href.split('/');
            if (strs.length >= 3) {
                const host = strs[2];
                if (host !== 'blog.x2b.net' || window.location.host) {
                    $this.attr('href', '/go.html?u='+Base64.encode(href)+'').attr('rel', 'external nofollow noopener noreferrer');
                    if (true) {
                        $this.attr('target', '_blank');
                    }
                }
            }
          }
        });
        </script></body>
</html>
