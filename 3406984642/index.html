<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#922"><meta name="generator" content="Hexo 6.3.0">
<link rel="preconnect" href="https://fonts.cat.net" crossorigin>
<link rel="preconnect" href="https://lib.baomitu.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="../images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png">
  <link rel="mask-icon" href="../images/favicon-32x32.png" color="#922">

<link rel="stylesheet" href="../css/main.css">

<link rel="stylesheet" href="https://fonts.cat.net/css?family=Monda:300,300italic,400,400italic,700,700italic%7CArvo:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://lib.baomitu.com/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://lib.baomitu.com/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://lib.baomitu.com/pace/1.2.4/themes/red/pace-theme-minimal.css">
  <script src="https://lib.baomitu.com/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.x2b.net","root":"/","images":"../images","scheme":"Gemini","darkmode":false,"version":"8.15.1","exturl":false,"sidebar":{"position":"left","width":300,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#922","save":"manual"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":{"gitalk":{"order":-1}},"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"../search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":true,"preload":true}}</script><script src="../js/config.js"></script>

    <meta name="description" content="安全资源 Kubernetes（k8s）提供了一些安全资源来增强集群的安全性和保护应用程序的机密信息。">
<meta property="og:type" content="article">
<meta property="og:title" content="K8s 安全资源">
<meta property="og:url" content="https://blog.x2b.net/3406984642/index.html">
<meta property="og:site_name" content="X to Bytes">
<meta property="og:description" content="安全资源 Kubernetes（k8s）提供了一些安全资源来增强集群的安全性和保护应用程序的机密信息。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.x2b.net/images/hostPort%E5%92%8CNodePort%E6%9C%8D%E5%8A%A1%E5%8C%BA%E5%88%AB.jpg">
<meta property="article:published_time" content="2022-03-20T17:10:01.000Z">
<meta property="article:modified_time" content="2023-05-16T06:32:16.000Z">
<meta property="article:author" content="assassing">
<meta property="article:tag" content="docker k8s linux python">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.x2b.net/images/hostPort%E5%92%8CNodePort%E6%9C%8D%E5%8A%A1%E5%8C%BA%E5%88%AB.jpg">


<link rel="canonical" href="https://blog.x2b.net/3406984642/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.x2b.net/3406984642/","path":"3406984642/","title":"K8s 安全资源"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>K8s 安全资源 | X to Bytes</title>
  

  <script src="../js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?71ae334aaa654e1cd3ba0c9eb55f88a3"></script>







  <noscript>
    <link rel="stylesheet" href="../css/noscript.css">
  </noscript>
<link rel="alternate" href="atom.xml" title="X to Bytes" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">X to Bytes</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="../about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-categories"><a href="../categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">16</span></a></li><li class="menu-item menu-item-archives"><a href="../archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">95</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E8%B5%84%E6%BA%90"><span class="nav-number">1.</span> <span class="nav-text"> 安全资源</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6"><span class="nav-number">1.1.</span> <span class="nav-text"> 认证机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E6%88%B7"><span class="nav-number">1.2.</span> <span class="nav-text"> 用户</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%84"><span class="nav-number">1.3.</span> <span class="nav-text"> 组</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="nav-number">2.</span> <span class="nav-text"> 安全上下文</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8%E7%94%A8%E6%88%B7"><span class="nav-number">2.1.</span> <span class="nav-text"> 设置运行容器用户</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%89%B9%E6%9D%83%E6%A8%A1%E5%BC%8F%E8%BF%90%E8%A1%8C"><span class="nav-number">2.2.</span> <span class="nav-text"> 使用特权模式运行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E6%B7%BB%E5%8A%A0%E5%86%85%E6%A0%B8%E5%8A%9F%E8%83%BD"><span class="nav-number">2.3.</span> <span class="nav-text"> 容器添加内核功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E7%A6%81%E7%94%A8%E5%86%85%E6%A0%B8%E5%8A%9F%E8%83%BD"><span class="nav-number">2.4.</span> <span class="nav-text"> 容器禁用内核功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%BB%E6%AD%A2%E5%86%99%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-number">2.5.</span> <span class="nav-text"> 阻止写根文件系统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E7%94%A8%E6%88%B7%E5%85%B1%E4%BA%AB%E5%82%A8%E5%AD%98%E5%8D%B7"><span class="nav-number">2.6.</span> <span class="nav-text"> 多用户共享储存卷</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="nav-number">3.</span> <span class="nav-text"> 系统命名空间</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="nav-number">3.1.</span> <span class="nav-text"> 网络命名空间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%91%E5%AE%9A%E8%8A%82%E7%82%B9%E7%AB%AF%E5%8F%A3"><span class="nav-number">3.2.</span> <span class="nav-text"> 绑定节点端口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pid-%E5%92%8C-ipc-%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="nav-number">3.3.</span> <span class="nav-text"> PID 和 IPC 命名空间</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9A%94%E7%A6%BB-pod-%E7%BD%91%E7%BB%9C"><span class="nav-number">4.</span> <span class="nav-text"> 隔离 Pod 网络</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E7%BD%91%E7%BB%9C%E9%9A%94%E7%A6%BB"><span class="nav-number">4.1.</span> <span class="nav-text"> 同命名空间网络隔离</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E9%83%A8%E5%88%86%E8%AE%BF%E9%97%AE"><span class="nav-number">4.2.</span> <span class="nav-text"> 同命名空间部分访问</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E5%90%8C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E7%BD%91%E7%BB%9C%E9%9A%94%E7%A6%BB"><span class="nav-number">4.3.</span> <span class="nav-text"> 不同命名空间网络隔离</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-cidr-%E9%9A%94%E7%A6%BB%E7%BD%91%E7%BB%9C"><span class="nav-number">4.4.</span> <span class="nav-text"> 使用 CIDR 隔离网络</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%90%E5%88%B6-pod-%E5%AF%B9%E5%A4%96%E8%AE%BF%E9%97%AE"><span class="nav-number">4.5.</span> <span class="nav-text"> 限制 Pod 对外访问</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#serviceaccount"><span class="nav-number">5.</span> <span class="nav-text"> ServiceAccount</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B-sa"><span class="nav-number">5.1.</span> <span class="nav-text"> 查看 SA</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-sa"><span class="nav-number">5.2.</span> <span class="nav-text"> 创建 SA</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-sa"><span class="nav-number">5.3.</span> <span class="nav-text"> 配置 SA</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#podsecuritypolicy"><span class="nav-number">6.</span> <span class="nav-text"> PodSecurityPolicy</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89"><span class="nav-number">6.1.</span> <span class="nav-text"> 定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-psp"><span class="nav-number">6.2.</span> <span class="nav-text"> 建立 PSP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E5%92%8C%E7%BB%84%E9%99%90%E5%88%B6"><span class="nav-number">6.3.</span> <span class="nav-text"> 用户和组限制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%86%85%E6%A0%B8%E5%8A%9F%E8%83%BD"><span class="nav-number">6.4.</span> <span class="nav-text"> 配置内核功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%90%E5%88%B6%E5%82%A8%E5%AD%98%E5%8D%B7%E7%B1%BB%E5%9E%8B"><span class="nav-number">6.5.</span> <span class="nav-text"> 限制储存卷类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E9%85%8D-psp"><span class="nav-number">6.6.</span> <span class="nav-text"> 分配 PSP</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#rbac"><span class="nav-number">7.</span> <span class="nav-text"> RBAC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#http-%E8%AF%B7%E6%B1%82%E5%8A%A8%E4%BD%9C"><span class="nav-number">7.1.</span> <span class="nav-text"> HTTP 请求动作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-rbac"><span class="nav-number">7.2.</span> <span class="nav-text"> 测试 RBAC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2"><span class="nav-number">7.3.</span> <span class="nav-text"> 创建角色</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%91%E5%AE%9A%E8%A7%92%E8%89%B2"><span class="nav-number">7.4.</span> <span class="nav-text"> 绑定角色</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%91%E5%AE%9A%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2"><span class="nav-number">7.5.</span> <span class="nav-text"> 绑定集群角色</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E9%9D%9E%E8%B5%84%E6%BA%90%E5%9E%8B-url"><span class="nav-number">7.6.</span> <span class="nav-text"> 访问非资源型 URL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2%E9%85%8D%E5%90%88%E8%A7%92%E8%89%B2%E7%BB%91%E5%AE%9A"><span class="nav-number">7.7.</span> <span class="nav-text"> 集群角色配合角色绑定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%92%E8%89%B2%E5%92%8C%E7%BB%91%E5%AE%9A%E7%9A%84%E7%BB%84%E5%90%88"><span class="nav-number">7.8.</span> <span class="nav-text"> 角色和绑定的组合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%B8%A6%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2"><span class="nav-number">7.9.</span> <span class="nav-text"> 自带集群角色</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="assassing"
      src="../images/avatar.jpg">
  <p class="site-author-name" itemprop="name">assassing</p>
  <div class="site-description" itemprop="description">技术分享</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="../archives/">
          <span class="site-state-item-count">95</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="../categories/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hxz393" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxz393" rel="noopener me external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://youtube.com/hxz393" title="YouTube → https:&#x2F;&#x2F;youtube.com&#x2F;hxz393" rel="noopener me external nofollow noreferrer" target="_blank"><i class="fab fa-youtube fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://www.discogs.com/user/assassing" title="https:&#x2F;&#x2F;www.discogs.com&#x2F;user&#x2F;assassing" rel="noopener external nofollow noreferrer" target="_blank">Discogs</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://www.last.fm/user/assassing" title="https:&#x2F;&#x2F;www.last.fm&#x2F;user&#x2F;assassing" rel="noopener external nofollow noreferrer" target="_blank">Last.fm</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://anidb.net/up795303" title="https:&#x2F;&#x2F;anidb.net&#x2F;up795303" rel="noopener external nofollow noreferrer" target="_blank">AniDB</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.x2b.net/3406984642/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../images/avatar.jpg">
      <meta itemprop="name" content="assassing">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="X to Bytes">
      <meta itemprop="description" content="技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="K8s 安全资源 | X to Bytes">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          K8s 安全资源
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-03-21 01:10:01" itemprop="dateCreated datePublished" datetime="2022-03-21T01:10:01+08:00">2022-03-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-16 14:32:16" itemprop="dateModified" datetime="2023-05-16T14:32:16+08:00">2023-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Kubernets/" itemprop="url" rel="index"><span itemprop="name">Kubernets</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Kubernets/1-%E5%B8%B8%E7%94%A8%E8%B5%84%E6%BA%90/" itemprop="url" rel="index"><span itemprop="name">1.常用资源</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>8.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>29 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="安全资源"><a class="markdownIt-Anchor" href="#安全资源"></a> 安全资源</h1>
<p>Kubernetes（k8s）提供了一些安全资源来增强集群的安全性和保护应用程序的机密信息。</p>
<h2 id="认证机制"><a class="markdownIt-Anchor" href="#认证机制"></a> 认证机制</h2>
<p>API 服务器可以配置多个认证插件。API 接收到的请求会经过一个认证插件列表，列表中的每个插件都可以检查这个请求和请求发送者身份。如果列表中有插件可以提取客户端的用户名、用户 ID 和组信息，则停止调用剩余的认证插件，将已经认证过的用户的用户名和组（可能有多个组）返回给 API 进入授权阶段。否则，返回 401 响应状态码。</p>
<p>可以通过在 API 服务器启动时加入选项来开启认证插件。目前可以使用的认证方式有：客户端证书、传入在 HTTP 头中的认证 token、基础的 HTTP 认证。</p>
<h2 id="用户"><a class="markdownIt-Anchor" href="#用户"></a> 用户</h2>
<p>k8s 区分两种连接到 API 服务器的客户端：用户和 pod（pod 中的应用）。这两种类型的客户端都使用认证插件进行认证。</p>
<p>用户应该被管理在外部系统中，例如单点登录系统（SSO）。不能通过 API 服务器创建、更新或删除用户。</p>
<p>pod 使用一种称为 Service Accounts 的机制，该机制被创建和储存在集群中作为 ServiceAccount 资源。</p>
<h2 id="组"><a class="markdownIt-Anchor" href="#组"></a> 组</h2>
<p>正常用户和 ServiceAccount 都可以属于一个或多个组，组用来给多个用户赋予权限。系统内置的组有一些特殊含义：</p>
<ul>
<li>
<p><code>system:unauthenticated</code>：分配给所有认证插件都无法认证的客户端。</p>
</li>
<li>
<p><code>system:authenticated</code>：自动分配给成功通过认证的用户。</p>
</li>
<li>
<p><code>system:serviceaccounts</code>：包含所有系统中的 ServiceAccount 对象。</p>
</li>
<li>
<p><code>system:serviceaccount:&lt;namespace&gt;</code>：包含特定命名空间中的所有 ServiceAccount 对象。</p>
</li>
</ul>
<h1 id="安全上下文"><a class="markdownIt-Anchor" href="#安全上下文"></a> 安全上下文</h1>
<p>可以在 pod 或其所属容器的描述中通过 security-Context 选项配置其他与安全性相关的特征。可以用于整个 pod 或 pod 中单独的容器。</p>
<p>其主要可以达到以下目的：</p>
<ul>
<li>
<p>指定容器中运行进程的用户（用户 ID）。</p>
</li>
<li>
<p>阻止容器以 root 用户运行（容器默认运行用户通常在镜像中指定，需要阻止容器以 root 用户运行）。</p>
</li>
<li>
<p>使用特权模式运行容器，使其对宿主节点的内容具有完全的访问权限。</p>
</li>
<li>
<p>通过添加或禁用内核功能，配置内核访问权限。</p>
</li>
<li>
<p>设置 SELinux 选项，加强对容器的限制。</p>
</li>
<li>
<p>阻止进程写入容器的根文件系统。</p>
</li>
</ul>
<h2 id="设置运行容器用户"><a class="markdownIt-Anchor" href="#设置运行容器用户"></a> 设置运行容器用户</h2>
<p>为了使用与镜像中不同的用户来运行 pod，需要设置 <code>spec.containers.securityContext.runAsUser</code> 选项。在这里，我们创建一个使用 <code>guest</code> 用户运行的容器，其值为 405：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> pod-user.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-user
spec:
  containers:
  - name: main
    image: alpine
    command: <span class="token punctuation">[</span><span class="token string">"/bin/sleep"</span>, <span class="token string">"999999"</span><span class="token punctuation">]</span>
    securityContext:
      runAsUser: <span class="token number">405</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> pod-user.yaml
pod/pod-user created
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pod-user -- <span class="token function">id</span>
<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">405</span><span class="token punctuation">(</span>guest<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 root 用户运行容器会获取挂载目录的完整访问权限，因此应该阻止使用 root 用户运行容器。设置 <code>securityContext.runAsNonRoot</code> 为 <code>true</code> 来启用此限制：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> pod-noroot.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-noroot
spec:
  containers:
  - name: main
    image: alpine
    command: <span class="token punctuation">[</span><span class="token string">"/bin/sleep"</span>, <span class="token string">"999999"</span><span class="token punctuation">]</span>
    securityContext:
      runAsNonRoot: <span class="token boolean">true</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> pod-noroot.yaml
pod/pod-noroot created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时查看 pod 状态会发现无法启动：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl get po
NAME               READY   STATUS                       RESTARTS   AGE
pod-noroot         <span class="token number">0</span>/1     CreateContainerConfigError   <span class="token number">0</span>          29s
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl describe po pod-noroot
Events:
  Type     Reason     Age                From               Message
  ----     ------     ----               ----               -------
  Normal   Pulling    12s <span class="token punctuation">(</span>x6 over 89s<span class="token punctuation">)</span>  kubelet            Pulling image <span class="token string">"alpine"</span>
  Warning  Failed     9s <span class="token punctuation">(</span>x5 over 86s<span class="token punctuation">)</span>   kubelet            Error: container has runAsNonRoot and image will run as root <span class="token punctuation">(</span>pod: <span class="token string">"pod-noroot_default(76916440-73d6-4739-9824-dad1c17e8760)"</span>, container: main<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>错误详细信息提示 “container has runAsNonRoot and image will run as root”。限制策略起到了作用。</p>
<h2 id="使用特权模式运行"><a class="markdownIt-Anchor" href="#使用特权模式运行"></a> 使用特权模式运行</h2>
<p>有时候，pod 需要执行宿主节点上能够执行的任何操作，例如操作受保护的系统设备或使用其他在普通容器中无法使用的内核功能。例如，代理 pod 通过修改 iptables 规则使服务规则生效。</p>
<p>要启用特权模式，可以将 <code>spec.containers.securityContext.privileged</code> 设置为 <code>true</code>：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> pod-privileged.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: pod-privileged
spec:
  containers:
  - name: main
    image: alpine
    command: <span class="token punctuation">[</span><span class="token string">"/bin/sleep"</span>, <span class="token string">"999999"</span><span class="token punctuation">]</span>
    securityContext:
      privileged: <span class="token boolean">true</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> pod-privileged.yaml 
pod/pod-privileged created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启用特权模式后，可以在 <code>/dev</code> 目录下查看到特权设备：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pod-user -- <span class="token function">ls</span> /dev
core             null             shm              termination-log
fd               ptmx             stderr           <span class="token function">tty</span>
full             pts              stdin            urandom
mqueue           random           stdout           zero
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pod-privileged -- <span class="token function">ls</span> /dev
agpgart             snapshot            tty49
autofs              snd                 tty5
bsg                 stderr              tty50
btrfs-control       stdin               tty51<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上，在特权模式下，可以访问宿主节点上的所有设备，并且可以自由地使用它们。</p>
<h2 id="容器添加内核功能"><a class="markdownIt-Anchor" href="#容器添加内核功能"></a> 容器添加内核功能</h2>
<p>相比让容器运行在特权模式，更安全做法是只给予它真正需要的内核功能权限。Kubernetes 允许为特定容器添加或禁用部分内核功能。</p>
<p>例如，如果需要允许容器修改系统时间，可以在容器的 <code>capabilities</code> 里添加一个名为 <code>CAP_SYS_TIME</code> 的功能：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> pod-settime.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-settime
spec:
  containers:
  - name: main
    image: alpine
    command: <span class="token punctuation">[</span><span class="token string">"/bin/sleep"</span>, <span class="token string">"999999"</span><span class="token punctuation">]</span>
    securityContext:
      capabilities:
        add:
        - SYS_TIME
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> pod-settime.yaml 
pod/pod-settime created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Linux 内核功能名称通常以 <code>CAP_</code> 开头，在 pod 模板中必须省略 <code>CAP_</code> 前缀。测试修改系统时间的操作：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">date</span>
Mon Mar <span class="token number">21</span> <span class="token number">20</span>:12:40 CST <span class="token number">2022</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pod-settime -- <span class="token function">date</span> +%T <span class="token parameter variable">-s</span> <span class="token string">"20:10:00"</span>
<span class="token number">20</span>:10:00
<span class="token punctuation">[</span>root@server6-node2 ~<span class="token punctuation">]</span>$ <span class="token function">date</span>
Tue Mar <span class="token number">22</span> 04:11:03 CST <span class="token number">2022</span>
<span class="token punctuation">[</span>root@server6-node2 ~<span class="token punctuation">]</span>$ ntpdate cn.pool.ntp.org<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="容器禁用内核功能"><a class="markdownIt-Anchor" href="#容器禁用内核功能"></a> 容器禁用内核功能</h2>
<p>默认情况下，容器拥有 <code>CAP_CHOWN</code> 权限，允许进程修改文件系统中文件的所有者。如果要禁用此能力，可以在 <code>capabilities.drop</code> 列表中加入 <code>CHOWN</code>：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> pod-drop.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-drop
spec:
  containers:
  - name: main
    image: alpine
    command: <span class="token punctuation">[</span><span class="token string">"/bin/sleep"</span>, <span class="token string">"999999"</span><span class="token punctuation">]</span>
    securityContext:
      capabilities:
        drop:
        - CHOWN
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> pod-drop.yaml 
pod/pod-drop created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试修改 <code>/tmp</code> 目录所有者的操作：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> pod-drop -- <span class="token function">chown</span> guest /tmp
chown: /tmp: Operation not permitted
<span class="token builtin class-name">command</span> terminated with <span class="token builtin class-name">exit</span> code <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="阻止写根文件系统"><a class="markdownIt-Anchor" href="#阻止写根文件系统"></a> 阻止写根文件系统</h2>
<p>假设存在一个 PHP 漏洞，攻击者可以通过该漏洞改写 PHP 文件，而这些 PHP 文件位于容器的根文件系统中。为了防止文件被篡改，可以通过设置 <code>securityContext.readOnlyRootFilesystem</code> 为 <code>true</code> 来禁止对根文件系统的写入操作：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> pod-readonly.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: pod-readonly
spec:
  containers:
  - name: main
    image: alpine
    command: <span class="token punctuation">[</span><span class="token string">"/bin/sleep"</span>, <span class="token string">"999999"</span><span class="token punctuation">]</span>
    securityContext:
      readOnlyRootFilesystem: <span class="token boolean">true</span>
    volumeMounts:
    - name: my-volume
      mountPath: /volume
      readOnly: <span class="token boolean">false</span>
  volumes:
  - name: my-volume
    emptyDir: <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> pod-readonly.yaml 
pod/pod-readonly created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个示例中，容器以 root 用户运行，并具有对根目录的写权限。然而，尝试向根文件系统写入文件会失败。与此同时，对挂载的卷进行写入是被允许的：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pod-readonly -- <span class="token function">touch</span> /new-file
touch: /new-file: Read-only <span class="token function">file</span> system
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pod-readonly -- <span class="token function">touch</span> /volume/new-file<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="多用户共享储存卷"><a class="markdownIt-Anchor" href="#多用户共享储存卷"></a> 多用户共享储存卷</h2>
<p>假设一个 Pod 中运行着两个容器，它们共享同一个存储卷。当使用不同的用户运行这两个容器时，可能会出现权限问题。</p>
<p>可以为 Pod 中的所有容器指定 <code>fsGroup</code> 和 <code>supplementalGroups</code>，以允许容器在以任何用户运行时共享文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> pod-shared.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-shared
spec:
  securityContext:
    fsGroup: <span class="token number">555</span>
    supplementalGroups: <span class="token punctuation">[</span><span class="token number">666</span>, <span class="token number">777</span><span class="token punctuation">]</span>
  containers:
  - name: first
    image: alpine
    command: <span class="token punctuation">[</span><span class="token string">"/bin/sleep"</span>, <span class="token string">"999999"</span><span class="token punctuation">]</span>
    securityContext:
      runAsUser: <span class="token number">1111</span>
    volumeMounts:
    - name: shared-volume
      mountPath: /volume
      readOnly: <span class="token boolean">false</span>
  - name: second
    image: alpine
    command: <span class="token punctuation">[</span><span class="token string">"/bin/sleep"</span>, <span class="token string">"999999"</span><span class="token punctuation">]</span>
    securityContext:
      runAsUser: <span class="token number">2222</span>
    volumeMounts:
    - name: shared-volume
      mountPath: /volume
      readOnly: <span class="token boolean">false</span>
  volumes:
  - name: shared-volume
    emptyDir: <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> pod-shared.yaml 
pod/pod-shared created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中第一个容器以用户 ID 1111 运行，第二个容器以用户 ID 2222 运行，两个容器共享同一个名为 <code>shared-volume</code> 的存储卷。</p>
<p>查看第一个容器中的情况：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pod-shared <span class="token parameter variable">-c</span> first -- <span class="token function">id</span>
<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">1111</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">555,666</span>,777<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>结果显示该容器运行的用户所属组为 root，并关联了额外的用户组 555、666、777。</p>
<p>其中，用户组 555 是 <code>fsGroup</code> 的设置，因此该存储卷属于该用户组。当在该存储卷的目录下创建文件时，文件的所有者为用户 ID 1111，属组为用户组 555：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pod-shared <span class="token parameter variable">-c</span> first -- <span class="token function">ls</span> <span class="token parameter variable">-l</span> / <span class="token operator">|</span> <span class="token function">grep</span> volume
drwxrwsrwx    <span class="token number">2</span> root     <span class="token number">555</span>              <span class="token number">6</span> Mar <span class="token number">21</span> <span class="token number">14</span>:00 volume
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pod-shared <span class="token parameter variable">-c</span> first -- <span class="token function">ls</span> <span class="token parameter variable">-l</span> /volume/foo
-rw-r--r--    <span class="token number">1</span> <span class="token number">1111</span>     <span class="token number">555</span>              <span class="token number">0</span> Mar <span class="token number">21</span> <span class="token number">14</span>:13 /volume/foo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>通常情况下，新创建的文件的属组为创建用户的用户组 ID。在设置 <code>supplementalGroups</code> 后，在其他路径创建文件时，文件的所有者和属组都为 root：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pod-shared <span class="token parameter variable">-c</span> first -- <span class="token builtin class-name">echo</span> foo <span class="token operator">></span> /tmp/foo <span class="token operator">&amp;&amp;</span> <span class="token function">ls</span> <span class="token parameter variable">-l</span> /tmp/foo
-rw-r--r--. <span class="token number">1</span> root root <span class="token number">5</span> Mar <span class="token number">21</span> <span class="token number">22</span>:08 /tmp/foo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="系统命名空间"><a class="markdownIt-Anchor" href="#系统命名空间"></a> 系统命名空间</h1>
<p>每个 pod 都有自己的网络、PID 和 IPC 命名空间。这些命名空间将容器中的进程与其他容器或宿主机中的进程隔离开来。</p>
<h2 id="网络命名空间"><a class="markdownIt-Anchor" href="#网络命名空间"></a> 网络命名空间</h2>
<p>部分 pod（特别是系统 pod）需要在宿主节点的默认命名空间中运行，以允许它们看到和操作节点级别的资源和设备。</p>
<p>当 pod 需要使用宿主节点上的网络适配器时，可以通过将 pod spec 中的 <code>hostNetwork</code> 设置为 <code>true</code>，来使用宿主节点的网络命名空间。这种情况下，pod 和宿主节点共享网络接口。</p>
<p>以下是创建一个使用宿主节点默认网络命名空间的 pod 的示例：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> pod-host-network.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: pod-host-network
spec:
  hostNetwork: <span class="token boolean">true</span>
  containers:
  - image: alpine
    name: main
    command: <span class="token punctuation">[</span><span class="token string">"/bin/sleep"</span>, <span class="token string">"999999"</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> pod-host-network.yaml 
pod/pod-host-network created
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> pod-host-network -- <span class="token function">ifconfig</span>
ens37     Link encap:Ethernet  HWaddr 00:0C:29:FB:AF:1E  
          inet addr:192.168.2.205  Bcast:192.168.2.255  Mask:255.255.255.0
          inet6 addr: fe80::ff32:c0f:6cf:bfea/64 Scope:Link
          inet6 addr: fe80::9e57:89b4:bf98:c4d7/64 Scope:Link
          inet6 addr: 240e:383:404:aa00:a7a8:7fd6:fa4e:470d/64 Scope:Global
          inet6 addr: fe80::b1c4:1b6c:9cd9:7815/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:7563380 errors:0 dropped:584670 overruns:0 frame:0
          TX packets:7392819 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:4215026725 <span class="token punctuation">(</span><span class="token number">3.9</span> GiB<span class="token punctuation">)</span>  TX bytes:2918526795 <span class="token punctuation">(</span><span class="token number">2.7</span> GiB<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过这样的配置，pod 中的容器将能够查看和访问宿主节点上的网络接口。这对于部署 K8s 控制平面组件时非常有用，因为它们需要使用 <code>hostNetwork</code> 选项。</p>
<h2 id="绑定节点端口"><a class="markdownIt-Anchor" href="#绑定节点端口"></a> 绑定节点端口</h2>
<p>可以通过配置 pod 模板中的 <code>spec.containers.ports.hostPort</code> 字段，将容器的端口绑定到节点端口。</p>
<p>对于使用 <code>hostPort</code> 的 pod，访问宿主节点的端口连接会直接转发到对应的 pod 端口上。而通过 NodePort 服务暴露端口，则连接会被转发到随机的 pod 上。</p>
<p>与此同时，NodePort 服务会在所有节点上绑定端口，即使节点上没有 pod。而 <code>hostPort</code> 只能在有 pod 的节点上访问，并且同一个节点上不能有两个相同的 pod，否则会出现端口冲突。两者的区别如下图所示：</p>
<p><img data-src="../../../images/hostPort%E5%92%8CNodePort%E6%9C%8D%E5%8A%A1%E5%8C%BA%E5%88%AB.jpg" alt="hostPort和NodePort服务区别" /></p>
<p>下面是一个带有 <code>hostPort</code> 选项的 pod 的创建示例：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> kubia-hostport.yaml
apiVersion: v1
kind: Pod
metadata:
  name: kubia-hostport
spec:
  containers:
  - name: kubia
    image: luksa/kubia
    ports:
    - containerPort: <span class="token number">8080</span>
      hostPort: <span class="token number">9000</span>
      protocol: TCP
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> kubia-hostport.yaml
pod/kubia-hostport created
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl get po <span class="token parameter variable">-o</span> wide
NAME               READY   STATUS    RESTARTS   AGE    IP               NODE            
kubia-hostport     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          18s    <span class="token number">10.244</span>.244.250   server6-node2  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过这样的配置，我们可以看到 pod 运行在 node2 上，可以通过 node2 的 IP 地址加上端口号 9000 来访问该 pod。</p>
<p><code>hostPort</code> 功能最初用于暴露在每个节点上通过 DaemonSet 部署的系统服务，也用于确保两个副本的 pod 不会被调度到同一节点上。</p>
<h2 id="pid-和-ipc-命名空间"><a class="markdownIt-Anchor" href="#pid-和-ipc-命名空间"></a> PID 和 IPC 命名空间</h2>
<p>pod spec 中的 <code>hostPID</code> 和 <code>hostIPC</code> 选项与 <code>hostNetwork</code> 相似。当设为 true 时，pod 中的容器会使用宿主节点的 PID 和 IPC 命名空间，可以看到宿主机上的全部进程或通过 IPC 机制与它们通信。</p>
<p>创建一个共享宿主机 PID 和 IPC 命名空间的 pod：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> host-pid.yaml
apiVersion: v1
kind: Pod
metadata:
  name: host-pid
spec:
  hostPID: <span class="token boolean">true</span>
  hostIPC: <span class="token boolean">true</span>
  containers:
  - name: main
    image: alpine
    command: <span class="token punctuation">[</span><span class="token string">"/bin/sleep"</span>, <span class="token string">"999999"</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> host-pid.yaml
pod/host-pid created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试在容器中查看与关闭宿主机进程：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> host-pid -- <span class="token function">ps</span> aux <span class="token operator">|</span> <span class="token function">grep</span> <span class="token function">top</span>
 <span class="token number">4974</span> root      <span class="token number">0</span>:00 <span class="token function">top</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> host-pid -- <span class="token function">kill</span> <span class="token parameter variable">-9</span> <span class="token number">4974</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h1 id="隔离-pod-网络"><a class="markdownIt-Anchor" href="#隔离-pod-网络"></a> 隔离 Pod 网络</h1>
<p>有时候需要限制 Pod 之间的通信以确保网络安全性。是否可以进行这些配置取决于集群中所使用的 CNI 容器网络插件。如果插件支持，可以通过 NetworkPolicy 资源来配置网络隔离。</p>
<p>一个 NetworkPolicy 会应用在与其匹配的标签选择器所选出的 Pod 上，指定允许访问这些 Pod 的源地址，以及这些 Pod 可以访问的目标地址。这些规则由 ingress 和 egress 规则分别指定。这两种规则都可以匹配由标签选择器选出的 Pod，或者一个命名空间中的所有 Pod，或者通过无类别域间路由（CIDR，Classless Inter-Domain Routing）指定的 IP 地址段。</p>
<h2 id="同命名空间网络隔离"><a class="markdownIt-Anchor" href="#同命名空间网络隔离"></a> 同命名空间网络隔离</h2>
<p>默认情况下，某一命名空间中的 Pod 可以被任意来源访问。</p>
<p>可以在特定命名空间创建一个 NetworkPolicy，阻止任何客户端访问该命名空间的 Pod：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master <span class="token number">5</span><span class="token punctuation">]</span>$ <span class="token function">vi</span> np-deny.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny
spec:
  podSelector:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>空的标签选择器匹配命名空间中所有的 Pod。</p>
<h2 id="同命名空间部分访问"><a class="markdownIt-Anchor" href="#同命名空间部分访问"></a> 同命名空间部分访问</h2>
<p>也可以指定在同命名空间中允许互相访问的 Pod，未定义的 Pod 不得与互联：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master <span class="token number">5</span><span class="token punctuation">]</span>$ <span class="token function">vi</span> np-postgres.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-netpolicy
spec:
  podSelector:
    matchlabels:
      app: database
  ingress:
  - from:
    - podSelector:
      matchLabels:
        app: webserver
    ports:
    - port: <span class="token number">5432</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面配置了允许标签为 <code>app=webserver</code> 的 Pod 访问标签为 <code>app=database</code> 的 Pod 的 5432 端口。</p>
<h2 id="不同命名空间网络隔离"><a class="markdownIt-Anchor" href="#不同命名空间网络隔离"></a> 不同命名空间网络隔离</h2>
<p>假设有多个命名空间分属于不同用户，在 NS 中有标签 <code>tenant:manning</code> 来标记属于哪个用户，只允许同一标签的 Pod，也就是同一用户的 NS 中的 Pod 可以互相访问，不符合标签的用户禁止访问这个 Pod：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: np-shopping
spec:
  podSelector:
    matchlabels:
      app: shopping
  ingress:
  - from:
    - namespaceSelector:
      matchLabels:
        tenant: manning
    ports:
    - port: <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果需要其他用户访问，可以创建一个新的 NP 资源，或者在上面的配置中增加一条入向规则。</p>
<p>通常在多租户 K8s 集群中，租户不能为他们的命名空间添加标签，否则可以规避基于 namespaceSelector 的入向规则。</p>
<h2 id="使用-cidr-隔离网络"><a class="markdownIt-Anchor" href="#使用-cidr-隔离网络"></a> 使用 CIDR 隔离网络</h2>
<p>可以通过 CIDR 表示法指定一个 IP 段，例如允许 129.168.1.0/24 段的客户端访问 shopping 的 Pod：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ingress:
- from:
  - ipBlock:
      cidr: <span class="token number">192.168</span>.1.0/24<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="限制-pod-对外访问"><a class="markdownIt-Anchor" href="#限制-pod-对外访问"></a> 限制 Pod 对外访问</h2>
<p>也可以通过 egress 来设置出向规则，限制 Pod 的对外流量访问：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">spec:
  podSelector:
    matchlabels:
      app: shopping
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: database<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个策略应用于包含标签 <code>app=shopping</code> 的 Pod，它们只能与具有相同标签的 Pod 进行通信。除此之外，不能访问任何地址，无论是 Pod 还是 IP，无论是集群内还是集群外。</p>
<h1 id="serviceaccount"><a class="markdownIt-Anchor" href="#serviceaccount"></a> ServiceAccount</h1>
<p>下面简称 SA。</p>
<p>每个 pod 都与一个 SA 相关联，SA 代表了运行在 pod 中应用程序的身份证明。位于容器内的 token 文件持有 SA 的认证 token，应用程序使用这个 token 连接 API 服务器时，身份认证插件会对 SA 进行身份认证，并将 SA 的用户名传回 API 服务器内部。SA 用户名的格式如下：<code>system:serviceaccount:&lt;namespace&gt;:&lt;service account name&gt;</code>。</p>
<p>API 服务器将这个用户名传递给已配置好的授权插件，来决定应用程序所尝试执行的操作是否被允许执行。</p>
<p>SA 只不过是一种运行在 pod 中的应用程序和 API 服务器身份认证的一种方式，应用程序通过在请求中传递 SA token 来实现这点。</p>
<h2 id="查看-sa"><a class="markdownIt-Anchor" href="#查看-sa"></a> 查看 SA</h2>
<p>SA 资源作用在单独的命名空间，每个命名空间会自动创建一个默认的 SA。可以通过 get 命令查看：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl get sa
NAME      SECRETS   AGE
default   <span class="token number">1</span>         137d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>在 pod 的配置文件中，可以使用指定账户名称的方式将一个 SA 赋值给一个 pod。如果不指定，pod 会使用这个命名空间中的默认 SA。</p>
<p>SA 可以给多个 pod 关联使用，来控制每个 pod 可以访问的资源。但是 pod 不能使用跨命名空间的 SA。</p>
<h2 id="创建-sa"><a class="markdownIt-Anchor" href="#创建-sa"></a> 创建 SA</h2>
<p>可以使用 create 命令来创建 SA：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create sa foo
serviceaccount/foo created
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl describe sa foo
Name:                foo
Namespace:           default
Labels:              <span class="token operator">&lt;</span>none<span class="token operator">></span>
Annotations:         <span class="token operator">&lt;</span>none<span class="token operator">></span>
Image pull secrets:  <span class="token operator">&lt;</span>none<span class="token operator">></span>
Mountable secrets:   foo-token-68qgz
Tokens:              foo-token-68qgz
Events:              <span class="token operator">&lt;</span>none<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>显示 SA 详细信息中，主要有三个参数：</p>
<ul>
<li>
<p>Image pull secrets（镜像拉取秘钥）</p>
<p>Image pull secrets 不仅给 pod 拉取镜像时使用，这个字段的秘钥会自动添加到所有使用这个 SA 的 pod 中，以此达到批量添加的操作。</p>
</li>
<li>
<p>Mountable secrets（可挂载的秘钥）</p>
<p>默认情况下，pod 可以挂载任何需要的秘钥，通过 Mountable secrets 配置可以让 pod 只允许挂载其中的 secrets。需要配合注解 <code>kubernetes.io/enforce-mountable-secrets=&quot;true&quot;</code> 来限制。</p>
</li>
<li>
<p>Tokens（身份认证令牌）</p>
<p>pod 认证时使用的 token。</p>
</li>
</ul>
<p>可以进一步查看自定义的 token 密钥内容：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl describe secrets foo-token-68qgz

Data
<span class="token operator">==</span><span class="token operator">==</span>
ca.crt:     <span class="token number">1099</span> bytes
namespace:  <span class="token number">7</span> bytes
token:      eyJhbGciOiJSUzI1NiI<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中包括了和默认 SA 相同的条目：CA 证书、命名空间和 token。SA 中使用的身份认证 token 是 JWT（JSON Web Token）。</p>
<h2 id="配置-sa"><a class="markdownIt-Anchor" href="#配置-sa"></a> 配置 SA</h2>
<p>通过配置 pod 模板中 <code>spec.serviceAccountName</code> 字段来分配 SA。pod 创建之后不能被修改：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> curl-sa.yaml
apiVersion: v1
kind: Pod
metadata:
  name: curl-custom-sa
spec:
  serviceAccountName: foo
  containers:
  - name: main
    image: curlimages/curl
    command: <span class="token punctuation">[</span><span class="token string">"sleep"</span>, <span class="token string">"99999"</span><span class="token punctuation">]</span>
  - name: ambassador
    image: luksa/kubectl-proxy:1.6.2
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> curl-sa.yaml
pod/curl-custom-sa created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查看容器内的 token：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> curl-custom-sa <span class="token parameter variable">-c</span> main -- <span class="token function">cat</span> /var/run/secrets/kubernetes.io/serviceaccount/token
eyJhbGciOiJSUzI1NiIsImtpZCI6IlZDdEV4ZVNxWmNVVlNMS2lqRU5hM2NNVzBRSE54bHZsSzZucERQY3lzblEifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>对比发现和 foo-token-llg77 完全相同。测试通过使用自定义 SA 的 token 和 API 服务器进行通信：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> curl-custom-sa <span class="token parameter variable">-c</span> main -- <span class="token function">curl</span> localhost:8001/api/v1/pods/
<span class="token punctuation">&#123;</span>
  <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"Status"</span>,
  <span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"v1"</span>,
  <span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"status"</span><span class="token builtin class-name">:</span> <span class="token string">"Failure"</span>,
  <span class="token string">"message"</span><span class="token builtin class-name">:</span> <span class="token string">"pods is forbidden: User <span class="token entity" title="\&quot;">\"</span>system:serviceaccount:default:foo<span class="token entity" title="\&quot;">\"</span> cannot list resource <span class="token entity" title="\&quot;">\"</span>pods<span class="token entity" title="\&quot;">\"</span> in API group <span class="token entity" title="\&quot;">\"</span><span class="token entity" title="\&quot;">\"</span> at the cluster scope"</span>,
  <span class="token string">"reason"</span><span class="token builtin class-name">:</span> <span class="token string">"Forbidden"</span>,
  <span class="token string">"details"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"pods"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"code"</span><span class="token builtin class-name">:</span> <span class="token number">403</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果提示新建的 SA 没有列出 pod 列表的权限。SA 需要和 RBAC 授权插件配合使用，否则 SA 只起到提供镜像拉取秘钥的功能。</p>
<h1 id="podsecuritypolicy"><a class="markdownIt-Anchor" href="#podsecuritypolicy"></a> PodSecurityPolicy</h1>
<p>以下简称为 PSP。PSP 将在 k8s 1.25 版本中移除，后续可能使用 Kyverno 或 OPA（Open Policy Agent）。</p>
<p>PSP 默认为关闭状态，需要修改 API 服务器配置 <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> 中，添加 <code>--enable-admission-plugins=NodeRestriction,PodSecurityPolicy</code> 来启用 PSP 控制器。</p>
<h2 id="定义"><a class="markdownIt-Anchor" href="#定义"></a> 定义</h2>
<p>PSP 是一种集群级别（无命名空间）资源。它定义了用户能否在 pod 中使用各种安全相关的特性。维护 PSP 配置工作由集成在 API 服务器中的 PodSecurityPolicy 准入控制插件完成。</p>
<p>当向 API 服务器发送建立 pod 资源请求时，PSP 准入控制插件会将这个 pod 与已经配置的 PSP 进行校验。如果符合安全策略，则存入 etcd，否则会立即被拒绝。此插件也会根据安全策略中配置的默认值对 pod 进行修改。</p>
<p>PSP 资源主要定义以下规则：</p>
<ul>
<li>
<p>是否允许 pod 使用宿主节点的 PID，IPC，网络命名空间。</p>
</li>
<li>
<p>pod 允许绑定的宿主节点端口。</p>
</li>
<li>
<p>容器运行时允许使用的用户 ID。</p>
</li>
<li>
<p>是否允许拥有特权模式容器的 pod。</p>
</li>
<li>
<p>允许添加哪些内核功能，默认添加哪些内核功能，总是禁用哪些内核功能。</p>
</li>
<li>
<p>允许容器使用哪些 SELinux 选项。</p>
</li>
<li>
<p>容器是否允许使用可写的根文件系统。</p>
</li>
<li>
<p>允许容器在哪些文件系统组下运行。</p>
</li>
<li>
<p>允许 pod 使用哪些类型的储存卷。</p>
</li>
</ul>
<p>PSP 存在的主要问题是：</p>
<ul>
<li>
<p>授权模型存在缺陷。</p>
</li>
<li>
<p>功能易开难关。</p>
</li>
<li>
<p>API 接口缺乏一致性及扩展性，如 <code>MustRunAsNonRoot</code>，<code>AllowPrivilegeEscalation</code> 此类配置。</p>
</li>
<li>
<p>无法处理动态注入的 side-car（如 knative）。</p>
</li>
<li>
<p>在 CI/CD 场景难以落地。</p>
</li>
</ul>
<h2 id="建立-psp"><a class="markdownIt-Anchor" href="#建立-psp"></a> 建立 PSP</h2>
<p>下面定义一个 PSP 的示例，其作用是阻止 pod 使用宿主节点命名空间、不允许特权模式，并定义了能绑定节点端口的限制：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> psp-default.yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: default
spec:
  hostIPC: <span class="token boolean">false</span>
  hostPID: <span class="token boolean">false</span>
  hostNetwork: <span class="token boolean">false</span>
  hostPorts:
  - min: <span class="token number">10000</span>
    max: <span class="token number">11000</span>
  - min: <span class="token number">13000</span>
    max: <span class="token number">14000</span>
  privileged: <span class="token boolean">false</span>
  readOnlyRootFilesystem: <span class="token boolean">true</span>
  runAsUser:
    rule: RunAsAny
  fsGroup:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  seLinux:
    rule: RunAsAny
  volumes:
  - <span class="token string">'*'</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> psp-default.yaml 
Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="token keyword">in</span> v1.21+, unavailable <span class="token keyword">in</span> v1.25+
podsecuritypolicy.policy/default created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建成功后，限制立即生效。</p>
<h2 id="用户和组限制"><a class="markdownIt-Anchor" href="#用户和组限制"></a> 用户和组限制</h2>
<p>当在 <code>runAsUser</code> 或类似字段中使用 <code>RunAsAny</code> 规则时，对容器运行时可使用的用户和用户组没有任何限制。如果规则改为 <code>MustRunAs</code>，可以限制容器能使用的用户和用户组。</p>
<p>例如，限制运行用户 ID 的范围在 2-10 或 20-30 范围内，限制组 ID 在 2-30 之间：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">  runAsUser:
    rule: MustRunAs
    ranges:
    - min: <span class="token number">2</span>
      max: <span class="token number">10</span>
    - min: <span class="token number">20</span>
      max: <span class="token number">30</span>
  fsGroup:
    rule: MustRunAs
SYS_MODULE    ranges:
    - min: <span class="token number">2</span>
      max: <span class="token number">30</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所有超过 ID 限制范围的创建请求都会被拒绝。修改策略对已经存在的 pod 无效，PSP 资源仅作用于创建和新升级的 pod。</p>
<p>假如镜像指定了运行用户 ID，并且 PSP 也使用了限制运行用户策略，最终只要镜像运行的用户 ID 在 PSP 限定范围内，实际运行的用户 ID 以 PSP 限制为准。</p>
<h2 id="配置内核功能"><a class="markdownIt-Anchor" href="#配置内核功能"></a> 配置内核功能</h2>
<p>在 PSP 中，分别配置 <code>spec</code> 下的 <code>allowedCapabilities</code>、<code>defaultAddCapabilities</code>、<code>requiredDropCapabilities</code> 三个字段，来实现允许容器添加内核功能、为容器自动添加功能以及禁止容器使用的内核功能。</p>
<p>例如，配置容器允许添加 <code>SYS_TIME</code> 功能、自动添加 <code>CHOWN</code> 功能，并禁止 <code>SYS_ADMIN</code> 和 <code>SYS_MODULE</code> 功能：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: default
spec:
  allowedCapabilities:
  - SYS_TIME
  defaultAddCapabilities:
  - CHOWN
  requiredDropCapabilities:
  - SYS_ADMIN
  - SYS_MODULE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>没有配置的内核功能默认禁止添加到 pod 中。如果 pod 配置文件和 PSP 中都定义了同样的字段，以 PSP 为准。试图在 pod 定义中加入禁止的功能会被 API 服务器拒绝创建 pod。</p>
<h2 id="限制储存卷类型"><a class="markdownIt-Anchor" href="#限制储存卷类型"></a> 限制储存卷类型</h2>
<p>使用 “*” 代表所有类型，也可以手动指定类型：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">volumes:
- emptyDir
- configMap<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>其他没有指定的存储卷类型将不被允许使用。如果存在多个 PSP，那么 pod 实际可以使用的存储卷类型是所有 PSP 中 volume 列表的并集。</p>
<h2 id="分配-psp"><a class="markdownIt-Anchor" href="#分配-psp"></a> 分配 PSP</h2>
<p>针对不同用户或组分配不同的 PSP 策略是通过 RBAC 机制实现的。实现方式是先创建需要的 PSP 资源，然后创建 ClusterRole 资源，并通过名称将它们指向不同的策略，以此使 PSP 资源中的策略对不同用户或组生效。通过 ClusterRoleBinding 资源将特定的用户或组绑定到 ClusterRole 上。当 PSP 访问控制插件需要决定是否接纳一个 pod 时，它只会考虑创建 pod 的用户可以访问到的 PSP 中的策略。</p>
<p>首先创建一个允许 <code>privileged</code> 权限的 PSP：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> psp-privileged.yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: privileged
spec:
  privileged: <span class="token boolean">true</span>
  runAsUser:
    rule: RunAsAny
  fsGroup:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  seLinux:
    rule: RunAsAny
  volumes:
  - <span class="token string">'*'</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> psp-privileged.yaml
Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="token keyword">in</span> v1.21+, unavailable <span class="token keyword">in</span> v1.25+
podsecuritypolicy.policy/privileged created
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl get psp
NAME                      PRIV    CAPS   SELINUX    RUNASUSER          FSGROUP     SUPGROUP    READONLYROOTFS   VOLUMES
default                   <span class="token boolean">false</span>          RunAsAny   RunAsAny           RunAsAny    RunAsAny    <span class="token boolean">true</span>             *
privileged                <span class="token boolean">true</span>           RunAsAny   RunAsAny           RunAsAny    RunAsAny    <span class="token boolean">false</span>            *<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建两个 ClusterRole，一个使用 <code>default</code> 策略，一个使用 <code>privileged</code> 策略。需要使用动词 <code>use</code>：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create clusterrole psp-default <span class="token parameter variable">--verb</span><span class="token operator">=</span>use <span class="token parameter variable">--resource</span><span class="token operator">=</span>podsecuritypolicies --resource-name<span class="token operator">=</span>default
clusterrole.rbac.authorization.k8s.io/psp-default created
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create clusterrole psp-privileged <span class="token parameter variable">--verb</span><span class="token operator">=</span>use <span class="token parameter variable">--resource</span><span class="token operator">=</span>podsecuritypolicies --resource-name<span class="token operator">=</span>privileged
clusterrole.rbac.authorization.k8s.io/psp-privileged created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>将默认权限绑定到认证账户组，允许 <code>privileged</code> 权限的 PSP 绑定到用户 Bob：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create clusterrolebinding psp-all-users <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>psp-default <span class="token parameter variable">--group</span><span class="token operator">=</span>system:authenticated
clusterrolebinding.rbac.authorization.k8s.io/psp-all-users created
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create clusterrolebinding psp-bob <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>psp-privileged <span class="token parameter variable">--user</span><span class="token operator">=</span>bob
clusterrolebinding.rbac.authorization.k8s.io/psp-bob created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 <code>kubectl config</code> 创建两个新用户：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl config set-credentials alice <span class="token parameter variable">--username</span><span class="token operator">=</span>alice <span class="token parameter variable">--password</span><span class="token operator">=</span>password
User <span class="token string">"alice"</span> set.
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl config set-credentials bob <span class="token parameter variable">--username</span><span class="token operator">=</span>bob <span class="token parameter variable">--password</span><span class="token operator">=</span>password
User <span class="token string">"bob"</span> set.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用不同用户创建带特权选项的 Pod：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token parameter variable">--user</span> alice create <span class="token parameter variable">-f</span> pod-settime.yaml 
Error from server <span class="token punctuation">(</span>Forbidden<span class="token punctuation">)</span>: unknown<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>API 服务器不允许 <code>alice</code> 创建特权 pod，但 <code>bob</code> 可以成功创建。</p>
<h1 id="rbac"><a class="markdownIt-Anchor" href="#rbac"></a> RBAC</h1>
<p>RBAC 授权插件将用户角色作为决定用户能否执行操作的关键因素。主体和一个或多个角色相关联，每个角色被允许在特定的资源上执行特定的动词。</p>
<p>RBAC 授权规则是通过四种资源进行配置，可以分为两组：</p>
<ul>
<li>Role（角色）和 ClusterRole（集群角色），它们指定了在资源上可以执行哪些动词。</li>
<li>RoleBinding（角色绑定）和 ClusterRoleBinding（集群角色绑定），它们将上述角色绑定到特定的用户、组或 SA 上。</li>
</ul>
<p>角色和集群角色与绑定之间的区别在于，角色绑定命名空间资源，集群角色绑定集群级别资源。</p>
<p>RBAC 除了可对全部资源类型应用安全权限，还可以应用于特定的资源实例。</p>
<h2 id="http-请求动作"><a class="markdownIt-Anchor" href="#http-请求动作"></a> HTTP 请求动作</h2>
<p>通过客户端发送 HTTP 请求到 RESTful API 服务器特定的 URL 可以执行相应的动作。它们的映射关系如下：</p>
<table>
<thead>
<tr>
<th>HTTP 方法</th>
<th>单一资源的动词</th>
<th>集合的动词</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET, HEAD</td>
<td>get（以及 watch 监听）</td>
<td>list（以及 watch)</td>
</tr>
<tr>
<td>POST</td>
<td>create</td>
<td>-</td>
</tr>
<tr>
<td>PUT</td>
<td>update</td>
<td>-</td>
</tr>
<tr>
<td>PATCH</td>
<td>patch</td>
<td>-</td>
</tr>
<tr>
<td>DELETE</td>
<td>delete</td>
<td>deletecollection</td>
</tr>
</tbody>
</table>
<p>动词 <code>use</code> 用于 PodSecurityPolicy 资源。</p>
<h2 id="测试-rbac"><a class="markdownIt-Anchor" href="#测试-rbac"></a> 测试 RBAC</h2>
<p>通过一个运行 <code>kubectl-proxy</code> 的镜像，测试在容器中直接请求 API 服务器：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create ns foo
namespace/foo created
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create ns bar
namespace/bar created
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl run <span class="token builtin class-name">test</span> <span class="token parameter variable">--image</span><span class="token operator">=</span>luksa/kubectl-proxy <span class="token parameter variable">-n</span> foo
pod/test created
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl run <span class="token builtin class-name">test</span> <span class="token parameter variable">--image</span><span class="token operator">=</span>luksa/kubectl-proxy <span class="token parameter variable">-n</span> bar
pod/test created
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">-n</span> foo -- <span class="token function">curl</span> localhost:8001/api/v1/namespaces/foo/services
<span class="token punctuation">&#123;</span>
  <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"Status"</span>,
  <span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"v1"</span>,
  <span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"status"</span><span class="token builtin class-name">:</span> <span class="token string">"Failure"</span>,
  <span class="token string">"message"</span><span class="token builtin class-name">:</span> <span class="token string">"services is forbidden: User <span class="token entity" title="\&quot;">\"</span>system:serviceaccount:foo:default<span class="token entity" title="\&quot;">\"</span> cannot list resource <span class="token entity" title="\&quot;">\"</span>services<span class="token entity" title="\&quot;">\"</span> in API group <span class="token entity" title="\&quot;">\"</span><span class="token entity" title="\&quot;">\"</span> in the namespace <span class="token entity" title="\&quot;">\"</span>foo<span class="token entity" title="\&quot;">\"</span>"</span>,
  <span class="token string">"reason"</span><span class="token builtin class-name">:</span> <span class="token string">"Forbidden"</span>,
  <span class="token string">"details"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"services"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"code"</span><span class="token builtin class-name">:</span> <span class="token number">403</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>响应表示 Service Account 不允许列出 foo 命名空间中的服务，RBAC 插件阻挡了请求。</p>
<h2 id="创建角色"><a class="markdownIt-Anchor" href="#创建角色"></a> 创建角色</h2>
<p>Role 资源定义了对指定命名空间内指定资源的可用操作。下面的配置允许用户获取并列出 foo 命名空间中的服务：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: foo
  name: service-reader
rules:
- apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
  verbs: <span class="token punctuation">[</span><span class="token string">"get"</span>, <span class="token string">"list"</span><span class="token punctuation">]</span>
  resources: <span class="token punctuation">[</span><span class="token string">"services"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>定义参数说明如下：</p>
<ul>
<li><code>metadata.namespace</code>：指定 Role 所在的命名空间。如果未定义，则使用当前命名空间。</li>
<li><code>metadata.name</code>：指定 Role 的名称。</li>
<li><code>rules.apiGroups</code>：定义 apiGroup 名称。由于 Service 是核心资源，因此没有 apiGroup 名称。可以定义多种规则。</li>
<li><code>rules.verbs</code>：定义获取单个 Service（通过名称）并能使用 <code>get</code> 列出所有允许的服务。</li>
<li><code>rules.resources</code>：定义规则与服务相关联，必须使用复数形式的名称。</li>
<li><code>rules.resourceNames</code>：此处未定义，用于指定服务实例的名称以限制对服务实例的访问。</li>
</ul>
<p>在 foo 命名空间中创建此 Role 资源：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> role.yaml <span class="token parameter variable">-n</span> foo
role.rbac.authorization.k8s.io/service-reader created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>也可以使用 <code>create role</code> 命令直接创建：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create role service-reader <span class="token parameter variable">--verb</span><span class="token operator">=</span>get <span class="token parameter variable">--verb</span><span class="token operator">=</span>list <span class="token parameter variable">--resource</span><span class="token operator">=</span>services <span class="token parameter variable">-n</span> bar
role.rbac.authorization.k8s.io/service-reader created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这两个角色允许在 Pod 中分别列出各自命名空间中的服务。</p>
<h2 id="绑定角色"><a class="markdownIt-Anchor" href="#绑定角色"></a> 绑定角色</h2>
<p>创建角色后，需要将角色绑定到一个主体上，该主体可以是用户、组或 Service Account（SA）：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create rolebinding <span class="token builtin class-name">test</span> <span class="token parameter variable">-n</span> foo <span class="token parameter variable">--role</span><span class="token operator">=</span>service-reader <span class="token parameter variable">--serviceaccount</span><span class="token operator">=</span>foo:default
rolebinding.rbac.authorization.k8s.io/test created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>上述 RoleBinding 资源名为 <code>test</code>，它将 <code>service-reader</code> 角色绑定到 foo 命名空间中的 <code>default</code> SA。如果需要绑定到用户，则使用 <code>--user</code> 参数；如果绑定到组，则使用 <code>--group</code> 参数。</p>
<p>RoleBinding 只能指定一个角色，但角色可以绑定到多个主体。现在测试一下效果：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">-n</span> foo -- <span class="token function">curl</span> localhost:8001/api/v1/namespaces/foo/services
<span class="token punctuation">&#123;</span>
  <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"ServiceList"</span>,
  <span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"v1"</span>,
  <span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"resourceVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"1666771"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"items"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 foo 命名空间中的 Pod 已成功获取到 foo 命名空间中的 Service 信息，但现在尚未运行任何 Service，因此 <code>items</code> 项为空。</p>
<p>可以修改 foo 命名空间中的 RoleBinding，添加角色绑定到 bar 命名空间的默认 SA：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl edit rolebinding <span class="token builtin class-name">test</span> <span class="token parameter variable">-n</span> foo
subjects:
- kind: ServiceAccount
  name: default
  namespace: foo
- kind: ServiceAccount
  name: default
  namespace: bar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在可以在 bar 命名空间的 Pod 中也能列出 foo 命名空间中的服务：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">-n</span> bar -- <span class="token function">curl</span> localhost:8001/api/v1/namespaces/foo/services
<span class="token punctuation">&#123;</span>
  <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"ServiceList"</span>,
  <span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"v1"</span>,
  <span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"resourceVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"1667251"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"items"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="绑定集群角色"><a class="markdownIt-Anchor" href="#绑定集群角色"></a> 绑定集群角色</h2>
<p>当只有 Role 时，需要引用所有命名空间的资源时，必须逐个建立角色和角色绑定。而且，有些资源并不属于任何命名空间（如 Node、PV、NS 等），常规角色无法对这些资源进行授权。为了解决这个问题，引入了 ClusterRole。</p>
<p>ClusterRole 和 ClusterRoleBinding 都是集群级资源，可以访问没有命名空间的资源、非资源型 URL，或者作为单个命名空间内部绑定的公共角色，避免在每个命名空间中重新定义相同的角色。</p>
<p>首先，创建一个能够列出集群中 PV 的集群角色 pv-reader：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create clusterrole pv-reader <span class="token parameter variable">--verb</span><span class="token operator">=</span>get,list <span class="token parameter variable">--resource</span><span class="token operator">=</span>persistentvolumes
clusterrole.rbac.authorization.k8s.io/pv-reader created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>foo 命名空间的 Pod 上尝试获取 PV 列表会提示没权限。</p>
<p>接下来，使用 ClusterRoleBinding 将集群角色 pv-reader 绑定到 foo 命名空间的默认 SA：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create clusterrolebinding pv-test <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>pv-reader <span class="token parameter variable">--serviceaccount</span><span class="token operator">=</span>foo:default
clusterrolebinding.rbac.authorization.k8s.io/pv-test created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这样，foo 命名空间的 Pod 就能成功列出 PV 资源列表了：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">-n</span> foo -- <span class="token function">curl</span> localhost:8001/api/v1/persistentvolumes
<span class="token punctuation">&#123;</span>
  <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"PersistentVolumeList"</span>,
  <span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"v1"</span>,
  <span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"resourceVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"1671344"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"items"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"mongodb-pv"</span>,<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="访问非资源型-url"><a class="markdownIt-Anchor" href="#访问非资源型-url"></a> 访问非资源型 URL</h2>
<p>要访问 API 服务器对外暴露的非资源型 URL，也需要显式地进行授权，否则 API 服务器将拒绝客户端的请求。通常可以通过 <code>system:discovery</code> 这个集群角色和相同命名的集群角色绑定来完成。可以查看一下角色的信息：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl get clusterrole system:discovery <span class="token parameter variable">-o</span> yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: <span class="token string">"true"</span>
  creationTimestamp: <span class="token string">"2021-11-03T05:36:25Z"</span>
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:discovery
  resourceVersion: <span class="token string">"85"</span>
  uid: e1ff33b5-dc26-422e-8082-5def977e2e2a
rules:
- nonResourceURLs:
  - /api
  - /api/*
  - /apis
  - /apis/*
  - /healthz
  - /livez
  - /openapi
  - /openapi/*
  - /readyz
  - /version
  - /version/
  verbs:
  - get<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中，rules 中定义的是 <code>nonResourceURLs</code> 而不是资源字段，方法只有 GET 请求可用。然后，查看角色绑定的详细信息：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl get clusterrolebinding system:discovery <span class="token parameter variable">-o</span> yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: <span class="token string">"true"</span>
  creationTimestamp: <span class="token string">"2021-11-03T05:36:25Z"</span>
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:discovery
  resourceVersion: <span class="token string">"149"</span>
  uid: 98c8ddc8-e6eb-4b9f-8af2-c37e4804c0b3
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:discovery
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:authenticated<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该角色绑定了两个组 <code>system:authenticated</code> 和 <code>system:unauthenticated</code>，这样所有人都可以访问 ClusterRole 中定义的 URL。</p>
<p>这些组位于身份认证插件的范围内。当 API 服务器接收到一个请求时，会调用身份认证插件来获取用户所属的组信息，并在授权过程中使用这些组信息。</p>
<p>可以在本地或 Pod 内尝试访问 <code>/api</code> 路径来进行测试：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">-n</span> foo -- <span class="token function">curl</span> localhost:8001/api <span class="token parameter variable">-k</span>
<span class="token punctuation">&#123;</span>
  <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"APIVersions"</span>,
  <span class="token string">"versions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token string">"v1"</span>
  <span class="token punctuation">]</span>,
  <span class="token string">"serverAddressByClientCIDRs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token string">"clientCIDR"</span><span class="token builtin class-name">:</span> <span class="token string">"0.0.0.0/0"</span>,
      <span class="token string">"serverAddress"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.2.204:6443"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="集群角色配合角色绑定"><a class="markdownIt-Anchor" href="#集群角色配合角色绑定"></a> 集群角色配合角色绑定</h2>
<p>ClusterRole 不一定需要与 ClusterRoleBinding 捆绑使用，也可以与 RoleBinding 捆绑使用。首先，查看一个名为 <code>view</code> 的默认 ClusterRole：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl get clusterrole view <span class="token parameter variable">-o</span> yaml
aggregationRule:
  clusterRoleSelectors:
  - matchLabels:
      rbac.authorization.k8s.io/aggregate-to-view: <span class="token string">"true"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到该角色有很多规则，其中一些规则适用于具有命名空间的资源，如 ConfigMap、PersistentVolumeClaim 等，还有一些适用于无命名空间的资源。角色的权限取决于绑定方式：</p>
<ul>
<li>如果使用 ClusterRoleBinding 绑定 <code>view</code>，在绑定中列出的主体可以查看指定资源在所有命名空间中的信息。</li>
<li>如果使用 RoleBinding 绑定 <code>view</code>，那么只能查看 RoleBinding 所在命名空间中的资源。</li>
</ul>
<p>下面，使用 ClusterRoleBinding 将 ClusterRole <code>view</code> 绑定到命名空间 <code>foo</code> 的默认 SA 上：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create clusterrolebinding view-test <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>view <span class="token parameter variable">--serviceaccount</span><span class="token operator">=</span>foo:default
clusterrolebinding.rbac.authorization.k8s.io/view-test created
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">-n</span> foo -- <span class="token function">curl</span> localhost:8001/api/v1/namespaces/bar/services
<span class="token punctuation">&#123;</span>
  <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"ServiceList"</span>,
  <span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"v1"</span>,
  <span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"resourceVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"1754935"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"items"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在，foo 命名空间中的 Pod 就可以获取集群中所有其他命名空间的 Service 信息了。</p>
<p>如果删除集群绑定，并改为角色绑定：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl delete clusterrolebinding view-test
clusterrolebinding.rbac.authorization.k8s.io <span class="token string">"view-test"</span> deleted
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create rolebinding view-test <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>view <span class="token parameter variable">--serviceaccount</span><span class="token operator">=</span>foo:default <span class="token parameter variable">-n</span> foo
rolebinding.rbac.authorization.k8s.io/view-test created
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">-n</span> foo -- <span class="token function">curl</span> localhost:8001/api/v1/namespaces/bar/services
<span class="token punctuation">&#123;</span>
  <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"Status"</span>,
  <span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"v1"</span>,
  <span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"status"</span><span class="token builtin class-name">:</span> <span class="token string">"Failure"</span>,
  <span class="token string">"message"</span><span class="token builtin class-name">:</span> <span class="token string">"services is forbidden: User <span class="token entity" title="\&quot;">\"</span>system:serviceaccount:foo:default<span class="token entity" title="\&quot;">\"</span> cannot list resource <span class="token entity" title="\&quot;">\"</span>services<span class="token entity" title="\&quot;">\"</span> in API group <span class="token entity" title="\&quot;">\"</span><span class="token entity" title="\&quot;">\"</span> in the namespace <span class="token entity" title="\&quot;">\"</span>bar<span class="token entity" title="\&quot;">\"</span>"</span>,
  <span class="token string">"reason"</span><span class="token builtin class-name">:</span> <span class="token string">"Forbidden"</span>,
  <span class="token string">"details"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"kind"</span><span class="token builtin class-name">:</span> <span class="token string">"services"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"code"</span><span class="token builtin class-name">:</span> <span class="token number">403</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这次将返回 403 错误，拒绝列出集群中其他命名空间的 Service 列表。foo 命名空间中的 Pod 只能列出当前命名空间的 Service 列表。</p>
<h2 id="角色和绑定的组合"><a class="markdownIt-Anchor" href="#角色和绑定的组合"></a> 角色和绑定的组合</h2>
<p>下面的表格简单列举了访问需求和角色与绑定类型之间的搭配：</p>
<table>
<thead>
<tr>
<th><strong>访问的资源</strong></th>
<th><strong>角色类型</strong></th>
<th><strong>绑定类型</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>集群级别资源（Nodes, PV…）</td>
<td>集群</td>
<td>集群</td>
</tr>
<tr>
<td>非资源型 URL（/api, /healthz…）</td>
<td>集群</td>
<td>集群</td>
</tr>
<tr>
<td>在任何命名空间中的资源</td>
<td>集群</td>
<td>集群</td>
</tr>
<tr>
<td>在具体命名空间中的资源（可在多个命名空间中重用该角色）</td>
<td>集群</td>
<td>角色</td>
</tr>
<tr>
<td>在具体命名空间中的资源（角色需要在每个命名空间中都定义）</td>
<td>角色</td>
<td>角色</td>
</tr>
</tbody>
</table>
<h2 id="自带集群角色"><a class="markdownIt-Anchor" href="#自带集群角色"></a> 自带集群角色</h2>
<p>K8s 提供了一组默认的自定义角色（CR）和自定义角色绑定（CRB），每次 API 服务器启动时都会更新它们，以确保在误删或 K8s 版本更新后，所有默认角色和绑定都会被重新创建：</p>
<ul>
<li>
<p>view 角色</p>
<p>允许读取一个命名空间的大多数资源，除了 Role、RoleBinding 和 Secret。</p>
</li>
<li>
<p>edit 角色</p>
<p>允许修改一个命名空间中的资源，同时允许读取和修改 Secret，但不允许查看或修改 Role 和 RoleBinding。</p>
</li>
<li>
<p>admin 角色</p>
<p>可以读取和修改命名空间中的任何资源，除了 ResourceQuota 和命名空间资源本身。</p>
<p>API 服务器只允许用户在已经拥有一个角色中列出的所有权限的情况下创建和更新该角色。</p>
</li>
<li>
<p>cluster-admin 角色</p>
<p>拥有集群的完全控制权，包括命名空间的 ResourceQuota 和命名空间资源本身。</p>
</li>
<li>
<p>其他角色</p>
<p>默认角色以 “system:” 为前缀，这些角色用于各种组件中。</p>
</li>
</ul>
<p>.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>干杯！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="../images/wechatpay.png" alt="assassing 微信">
        <span>微信</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>assassing
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://blog.x2b.net/3406984642/" title="K8s 安全资源">https://blog.x2b.net/3406984642/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="followme">
  <span>欢迎订阅</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="../atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="../3341501969/" rel="prev" title="Docker 基础概念">
                  <i class="fa fa-chevron-left"></i> Docker 基础概念
                </a>
            </div>
            <div class="post-nav-item">
                <a href="../948924982/" rel="next" title="K8s 资源管理">
                  K8s 资源管理 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2020 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">assassing</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">295k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">16:25</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener external nofollow noreferrer" target="_blank">NexT.Gemini</a> on Kubernetes
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/hxz393" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener external nofollow noreferrer" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://lib.baomitu.com/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://lib.baomitu.com/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://lib.baomitu.com/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://lib.baomitu.com/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="../js/comments.js"></script><script src="../js/utils.js"></script><script src="../js/motion.js"></script><script src="../js/next-boot.js"></script><script src="../js/pjax.js"></script>

  <script src="https://lib.baomitu.com/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="../js/third-party/search/local-search.js"></script>




  <script src="../js/third-party/pace.js"></script>

  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.4/katex.min.css" integrity="sha256-gMRN4/6qeELzO1wbFa8qQLU8kfuF2dnAPiUoI0ATjx8=" crossorigin="anonymous">
  <script class="next-config" data-name="katex" type="application/json">{"copy_tex_js":{"url":"https://lib.baomitu.com/KaTeX/0.16.4/contrib/copy-tex.min.js","integrity":"sha256-Us54+rSGDSTvIhKKUs4kygE2ipA0RXpWWh0/zLqw3bs="}}</script>
  <script src="../js/third-party/math/katex.js"></script>


  <script src="https://lib.baomitu.com/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":5000,"priority":true,"url":"https://blog.x2b.net/3406984642/"}</script>
  <script src="../js/third-party/quicklink.js"></script>
<link rel="stylesheet" href="https://lib.baomitu.com/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"hxz393","repo":"x2b.net-deploy","client_id":"26664aab919326dcf7e7","client_secret":"40882da22b7a77aea4a985ccd95a9363cfb7ba9a","admin_user":"hxz393","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"d41d8cd98f00b204e9800998ecf8427e"}</script>
<script src="../js/third-party/comments/gitalk.js"></script>

</body>
</html>
