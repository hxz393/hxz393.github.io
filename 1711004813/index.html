<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#922"><meta name="generator" content="Hexo 6.3.0">
<link rel="preconnect" href="https://fonts.cat.net" crossorigin>
<link rel="preconnect" href="https://lib.baomitu.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="../images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png">
  <link rel="mask-icon" href="../images/favicon-32x32.png" color="#922">

<link rel="stylesheet" href="../css/main.css">

<link rel="stylesheet" href="https://fonts.cat.net/css?family=Monda:300,300italic,400,400italic,700,700italic%7CArvo:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://lib.baomitu.com/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://lib.baomitu.com/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://lib.baomitu.com/pace/1.2.4/themes/red/pace-theme-minimal.css">
  <script src="https://lib.baomitu.com/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.x2b.net","root":"/","images":"../images","scheme":"Gemini","darkmode":false,"version":"8.15.1","exturl":false,"sidebar":{"position":"left","width":300,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#922","save":"manual"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":{"gitalk":{"order":-1}},"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"../search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":true,"preload":true}}</script><script src="../js/config.js"></script>

    <meta name="description" content="基本定义 Pod 内的进程共享计算资源，但不包括磁盘。Kubernetes 通过定义存储卷来满足磁盘共享的需求，常用于扩展容器的存储空间并为其提供持久存储能力。">
<meta property="og:type" content="article">
<meta property="og:title" content="K8s 储存资源">
<meta property="og:url" content="https://blog.x2b.net/1711004813/index.html">
<meta property="og:site_name" content="X to Bytes">
<meta property="og:description" content="基本定义 Pod 内的进程共享计算资源，但不包括磁盘。Kubernetes 通过定义存储卷来满足磁盘共享的需求，常用于扩展容器的存储空间并为其提供持久存储能力。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.x2b.net/images/ConfigMap%E8%83%BD%E5%8C%85%E5%90%AB%E7%9A%84%E5%86%85%E5%AE%B9.jpg">
<meta property="og:image" content="https://blog.x2b.net/images/PV%E5%92%8CPVC.jpg">
<meta property="og:image" content="https://blog.x2b.net/images/%E8%8E%B7%E5%8F%96%E5%8A%A8%E6%80%81%E6%8C%81%E4%B9%85%E5%8D%B7.jpg">
<meta property="article:published_time" content="2022-03-20T01:01:17.000Z">
<meta property="article:modified_time" content="2023-05-16T03:31:57.515Z">
<meta property="article:author" content="assassing">
<meta property="article:tag" content="docker k8s linux python go">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.x2b.net/images/ConfigMap%E8%83%BD%E5%8C%85%E5%90%AB%E7%9A%84%E5%86%85%E5%AE%B9.jpg">


<link rel="canonical" href="https://blog.x2b.net/1711004813/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.x2b.net/1711004813/","path":"1711004813/","title":"K8s 储存资源"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>K8s 储存资源 | X to Bytes</title>
  

  <script src="../js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?71ae334aaa654e1cd3ba0c9eb55f88a3"></script>







  <noscript>
    <link rel="stylesheet" href="../css/noscript.css">
  </noscript>
<link rel="alternate" href="atom.xml" title="X to Bytes" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">X to Bytes</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="../about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-categories"><a href="../categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">20</span></a></li><li class="menu-item menu-item-archives"><a href="../archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">118</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%AE%9A%E4%B9%89"><span class="nav-number">1.</span> <span class="nav-text"> 基本定义</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#emptydir-%E5%8D%B7"><span class="nav-number">2.</span> <span class="nav-text"> emptyDir 卷</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-emptydir-%E5%8D%B7"><span class="nav-number">2.1.</span> <span class="nav-text"> 使用 emptyDir 卷</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B-pod-%E7%8A%B6%E6%80%81"><span class="nav-number">2.2.</span> <span class="nav-text"> 查看 Pod 状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E5%82%A8%E5%AD%98%E4%BB%8B%E8%B4%A8"><span class="nav-number">2.3.</span> <span class="nav-text"> 指定储存介质</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#gitrepo-%E5%8D%B7"><span class="nav-number">3.</span> <span class="nav-text"> gitRepo 卷</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-gitrepo-%E5%8D%B7"><span class="nav-number">3.1.</span> <span class="nav-text"> 使用 gitRepo 卷</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93"><span class="nav-number">3.2.</span> <span class="nav-text"> 私有仓库</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#configmap-%E8%B5%84%E6%BA%90"><span class="nav-number">4.</span> <span class="nav-text"> ConfigMap 资源</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E5%AE%B9%E5%99%A8%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-number">4.1.</span> <span class="nav-text"> 指定容器环境变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-configmap"><span class="nav-number">4.2.</span> <span class="nav-text"> 创建 ConfigMap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%A0%E9%80%92-configmap"><span class="nav-number">4.3.</span> <span class="nav-text"> 传递 ConfigMap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-configmap-%E5%8D%B7"><span class="nav-number">4.4.</span> <span class="nav-text"> 使用 ConfigMap 卷</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#secret-%E8%B5%84%E6%BA%90"><span class="nav-number">5.</span> <span class="nav-text"> Secret 资源</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E4%BB%A4%E7%89%8C"><span class="nav-number">5.1.</span> <span class="nav-text"> 默认令牌</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-secret"><span class="nav-number">5.2.</span> <span class="nav-text"> 创建 Secret</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-secret"><span class="nav-number">5.3.</span> <span class="nav-text"> 使用 Secret</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BA%95%E5%B1%82%E6%8C%81%E4%B9%85%E5%8C%96%E5%82%A8%E5%AD%98"><span class="nav-number">6.</span> <span class="nav-text"> 底层持久化储存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#hostpath-%E5%8D%B7"><span class="nav-number">6.1.</span> <span class="nav-text"> hostPath 卷</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gce-%E6%8C%81%E4%B9%85%E5%82%A8%E5%AD%98"><span class="nav-number">6.2.</span> <span class="nav-text"> GCE 持久储存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E6%8C%81%E4%B9%85%E5%8C%96%E5%82%A8%E5%AD%98%E5%8D%B7"><span class="nav-number">6.3.</span> <span class="nav-text"> 其他持久化储存卷</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8C%81%E4%B9%85%E5%8D%B7%E5%92%8C%E6%8C%81%E4%B9%85%E5%8D%B7%E5%A3%B0%E6%98%8E"><span class="nav-number">7.</span> <span class="nav-text"> 持久卷和持久卷声明</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-nfs-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-number">7.1.</span> <span class="nav-text"> 安装 NFS 文件系统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%8C%81%E4%B9%85%E5%8D%B7"><span class="nav-number">7.2.</span> <span class="nav-text"> 创建持久卷</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%8C%81%E4%B9%85%E5%8D%B7%E5%A3%B0%E6%98%8E"><span class="nav-number">7.3.</span> <span class="nav-text"> 创建持久卷声明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%8C%81%E4%B9%85%E5%8D%B7%E5%A3%B0%E6%98%8E"><span class="nav-number">7.4.</span> <span class="nav-text"> 使用持久卷声明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%8C%81%E4%B9%85%E5%8D%B7"><span class="nav-number">7.5.</span> <span class="nav-text"> 删除持久卷</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E5%8C%96%E6%8C%81%E4%B9%85%E5%8D%B7"><span class="nav-number">7.6.</span> <span class="nav-text"> 动态化持久卷</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="assassing"
      src="../images/avatar.jpg">
  <p class="site-author-name" itemprop="name">assassing</p>
  <div class="site-description" itemprop="description">个人笔记</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="../archives/">
          <span class="site-state-item-count">118</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="../categories/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hxz393" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxz393" rel="noopener me external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://youtube.com/hxz393" title="YouTube → https:&#x2F;&#x2F;youtube.com&#x2F;hxz393" rel="noopener me external nofollow noreferrer" target="_blank"><i class="fab fa-youtube fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://www.discogs.com/user/assassing" title="https:&#x2F;&#x2F;www.discogs.com&#x2F;user&#x2F;assassing" rel="noopener external nofollow noreferrer" target="_blank">Discogs</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://www.last.fm/user/assassing" title="https:&#x2F;&#x2F;www.last.fm&#x2F;user&#x2F;assassing" rel="noopener external nofollow noreferrer" target="_blank">Last.fm</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://anidb.net/up795303" title="https:&#x2F;&#x2F;anidb.net&#x2F;up795303" rel="noopener external nofollow noreferrer" target="_blank">AniDB</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.x2b.net/1711004813/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../images/avatar.jpg">
      <meta itemprop="name" content="assassing">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="X to Bytes">
      <meta itemprop="description" content="个人笔记">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="K8s 储存资源 | X to Bytes">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          K8s 储存资源
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-03-20 09:01:17" itemprop="dateCreated datePublished" datetime="2022-03-20T09:01:17+08:00">2022-03-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-05-16 11:31:57" itemprop="dateModified" datetime="2023-05-16T11:31:57+08:00">2023-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Kubernets/" itemprop="url" rel="index"><span itemprop="name">Kubernets</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Kubernets/1-%E5%B8%B8%E7%94%A8%E8%B5%84%E6%BA%90/" itemprop="url" rel="index"><span itemprop="name">1.常用资源</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>6.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>21 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="基本定义"><a class="markdownIt-Anchor" href="#基本定义"></a> 基本定义</h1>
<p>Pod 内的进程共享计算资源，但不包括磁盘。Kubernetes 通过定义存储卷来满足磁盘共享的需求，常用于扩展容器的存储空间并为其提供持久存储能力。</p>
<p>存储卷分为临时卷、本地卷和网络卷。临时卷和本地卷都位于工作节点，一旦 Pod 被调度到其他工作节点，这些类型的存储卷将无法访问。因此，临时卷和本地卷通常用于数据缓存，而持久化的数据需要放置于持久卷上。</p>
<p>卷是 Pod 的一个组成部分，因此像容器一样在 Pod 的配置中进行定义。它们不是独立的 Kubernetes 对象，不能单独创建或删除。Pod 中的所有容器都可以使用卷，但必须先将其挂载到容器中。</p>
<p>有多种可用的卷可以使用，单个容器可以同时使用不同类型的多个卷。可用的卷类型如下：</p>
<ul>
<li>
<p>emptyDir：用于存储临时数据的简单空目录。</p>
</li>
<li>
<p>hostPath：用于将工作节点文件系统中的目录挂载到 Pod 中。</p>
</li>
<li>
<p>gitRepo：通过检出 Git 仓库的内容来初始化的卷。</p>
</li>
<li>
<p>nfs：挂载到 Pod 中的 NFS 共享卷。</p>
</li>
<li>
<p>gcePersistentDisk、awsElasticBlockStore、azureDisk：用于挂载云服务提供的特定存储类型。</p>
</li>
<li>
<p>ConfigMap、Secret、DownwardAPI：用于将 Kubernetes 部分资源和集群信息公开给 Pod 的特殊类型卷。</p>
</li>
<li>
<p>PersistentVolumeClaim：一种使用预配置或动态配置的持久存储类型。</p>
</li>
<li>
<p>cinder、Cephas、iscsi、flocker、glusterfs、quobyte、rbd、flexVolume、vsphere-Volume、photoPersistentDisk：用于挂载其他类型的网络存储。</p>
</li>
</ul>
<h1 id="emptydir-卷"><a class="markdownIt-Anchor" href="#emptydir-卷"></a> emptyDir 卷</h1>
<p>emptyDir 卷是一个空目录，Pod 内的程序可以写入所需的任何文件。当删除 Pod 时，卷的内容会丢失。它主要用于在 Pod 中运行的容器之间临时共享文件。</p>
<h2 id="使用-emptydir-卷"><a class="markdownIt-Anchor" href="#使用-emptydir-卷"></a> 使用 emptyDir 卷</h2>
<p>下面使用 Nginx 作为服务器和 <code>fortune</code> 命令来生成 HTML 内容。<code>fortune</code> 命令每次运行都会输出一个随机引用。我们可以创建一个脚本，每 10 秒运行一次，并将其储存在 <code>index.html</code> 文件中：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> fortune-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: fortune
spec:
  containers:
  - image: luksa/fortune
    name: html-generator
    volumeMounts:
    - name: html
      mountPath: /var/htdocs
  - image: nginx:alpine
    name: web-server
    volumeMounts:
    - name: html
      mountPath: /usr/share/nginx/html
      readOnly: <span class="token boolean">true</span>
    ports:
    - containerPort: <span class="token number">80</span>
      protocol: TCP
  volumes:
  - name: html
    emptyDir: <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>                                 
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> fortune-pod.yaml 
pod/fortune created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一个容器 <code>html-generator</code> 用于将生成的 HTML 文件保存到 <code>/var/htdocs</code> 目录中，并将卷 <code>html</code> 挂载到该目录。</p>
<p>第二个容器 <code>web-server</code> 用于运行 Web 服务，并将卷 <code>html</code> 挂载到 <code>/usr/share/nginx/html</code> 目录中，设置为只读权限。</p>
<p>最后，我们定义了一个名为 <code>html</code> 的独立 emptyDir 卷，供上述容器挂载使用。</p>
<h2 id="查看-pod-状态"><a class="markdownIt-Anchor" href="#查看-pod-状态"></a> 查看 Pod 状态</h2>
<p>为了测试访问，我们可以直接设置端口转发来访问 Pod：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl port-forward fortune <span class="token number">8080</span>:80
Forwarding from <span class="token number">127.0</span>.0.1:8080 -<span class="token operator">></span> <span class="token number">80</span>
Forwarding from <span class="token punctuation">[</span>::1<span class="token punctuation">]</span>:8080 -<span class="token operator">></span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>在新终端中，通过 <code>curl</code> 命令来访问：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">curl</span> <span class="token number">127.0</span>.0.1:8080
Few things are harder to put up with than the annoyance of a good example.
                -- <span class="token string">"Mark Twain, Pudd'nhead Wilson's Calendar"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="指定储存介质"><a class="markdownIt-Anchor" href="#指定储存介质"></a> 指定储存介质</h2>
<p>可以将 emptyDir 卷创建在 tmpfs，也就是内存中。空间受限于内存大小，但性能非常好。需要同时设置 sizeLimit 来限制使用的空间大小。</p>
<p>下面创建一个 Pod 进行测试，包含 Tomcat 和 Busybox 两个容器。Tomcat 向挂载的卷中写入日志，而 Busybox 读取日志内容：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> empty-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: volume-pod
  namespace: default
spec:
  containers:
  - name: tomcat
    image: tomcat
    ports:
    - containerPort: <span class="token number">8080</span>
    volumeMounts:
    - name: app-logs
      mountPath: /usr/local/tomcat/logs
  - name: busybox
    image: busybox
    command: <span class="token punctuation">[</span><span class="token string">"sh"</span>, <span class="token string">"-c"</span>, <span class="token string">"tail -f /logs/catalina*.log"</span><span class="token punctuation">]</span>
    volumeMounts:
    - name: app-logs
      mountPath: /logs
  volumes:
  - name: app-logs
    emptyDir:
      medium: Memory
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> empty-pod.yaml 
pod/volume-pod created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过以下命令查看日志：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl logs volume-pod <span class="token parameter variable">-c</span> busybox
<span class="token number">14</span>-Mar-2022 03:49:09.120 INFO <span class="token punctuation">[</span>main<span class="token punctuation">]</span> org.apache.catalina.startup.VersionLoggerListener.log Command line argument: <span class="token parameter variable">-Djava.io.tmpdir</span><span class="token operator">=</span>/usr/local/tomcat/temp
<span class="token number">14</span>-Mar-2022 03:49:09.128 INFO <span class="token punctuation">[</span>main<span class="token punctuation">]</span> org.apache.catalina.core.AprLifecycleListener.lifecycleEvent Loaded Apache Tomcat Native library <span class="token punctuation">[</span><span class="token number">1.2</span>.31<span class="token punctuation">]</span> using APR version <span class="token punctuation">[</span><span class="token number">1.7</span>.0<span class="token punctuation">]</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h1 id="gitrepo-卷"><a class="markdownIt-Anchor" href="#gitrepo-卷"></a> gitRepo 卷</h1>
<p>gitRepo 卷基本上也是一个 emptyDir 卷，通过在 Pod 启动时克隆 Git 仓库来填充数据。创建完成后，gitRepo 卷不会随着远程 Git 仓库的更新而更新。如果使用 ReplicationSet 进行管理，在删除 Pod 后会创建新的 Pod，再次触发 git clone 可以获取最新的文件。</p>
<p>一个典型的应用场景是存放网站的静态 HTML 文件，并创建一个包含 Web 服务器容器和 gitRepo 卷的 Pod。当 Pod 创建时，会拉取网站的最新版本并启动 Web 服务。不过，每次有新版本时需要删除 Pod 才能更新。</p>
<h2 id="使用-gitrepo-卷"><a class="markdownIt-Anchor" href="#使用-gitrepo-卷"></a> 使用 gitRepo 卷</h2>
<p>下面是一个使用 Nginx 容器和 gitRepo 卷的示例：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> gitrepo-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: gitrepo-volume-pod
spec:
  containers:
  - image: nginx:alpine
    name: web-server
    volumeMounts:
    - name: html
      mountPath: /usr/share/nginx/html
      readOnly: <span class="token boolean">true</span>
    ports:
    - containerPort: <span class="token number">80</span>
      protocol: TCP
  volumes:
  - name: html
    gitRepo:
      repository: https://github.com/luksa/kubia-wesite-example.git
      revision: master
      directory: <span class="token builtin class-name">.</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> gitrepo-pod.yaml 
pod/gitrepo-volume-pod created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上述示例中，gitRepo 卷需要指定 <code>revision</code> 来指定 master 分支，并将仓库克隆到根目录。也可以指定其他文件夹名称。</p>
<h2 id="私有仓库"><a class="markdownIt-Anchor" href="#私有仓库"></a> 私有仓库</h2>
<p>gitRepo 卷无法直接克隆私有 Git 仓库，例如需要账号密码验证的 GitLab。如果需要添加支持，可以在 Pod 中添加额外的 sidecar 容器，例如 gitsync sidecar，用于对主容器进行操作，以同步仓库的版本等。</p>
<p>需要注意的是，gitRepo 卷现已被官方废弃，官方建议使用初始化容器将仓库中的数据复制到 emptyDir 储存卷上。</p>
<h1 id="configmap-资源"><a class="markdownIt-Anchor" href="#configmap-资源"></a> ConfigMap 资源</h1>
<p>应用配置的关键在于能够在多个环境中区分配置选项，将配置从应用程序源码中分离。Kubernetes 允许将配置选项分离到单独的资源对象 ConfigMap 中。ConfigMap 本质上是一个键值对映射，值可以是字符串，也可以是完整的配置文件。示例图如下所示：</p>
<p><img data-src="../../../images/ConfigMap%E8%83%BD%E5%8C%85%E5%90%AB%E7%9A%84%E5%86%85%E5%AE%B9.jpg" alt="ConfigMap能包含的内容" /></p>
<p>应用程序无需直接读取 ConfigMap，而是通过环境变量或卷文件的形式将映射的内容传递给容器。在命令行参数的定义中，可以使用变量语法引用环境变量，从而将 ConfigMap 的条目作为命令行参数传递给进程。</p>
<p>Pod 通过名称引用 ConfigMap，因此可以在多个环境中使用相同的 Pod 定义来描述，并根据不同的环境使用不同的配置值。</p>
<h2 id="指定容器环境变量"><a class="markdownIt-Anchor" href="#指定容器环境变量"></a> 指定容器环境变量</h2>
<p>如果 Docker 镜像有自定义参数可以配置，可以按照下面的 Dockerfile 进行设置：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token builtin class-name">trap</span> <span class="token string">"exit"</span> SIGINT
<span class="token builtin class-name">echo</span> Fortune <span class="token function">sleep</span> every <span class="token variable">$INTERVAL</span> seconds
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /bar/htdocs
<span class="token keyword">while</span> <span class="token builtin class-name">:</span>
<span class="token keyword">do</span>
  <span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">date</span><span class="token variable">)</span></span> Writing fortune to /var/htdocs/index.html
  /usr/games/fortune <span class="token operator">></span> /var/htdocs/index.html
  <span class="token function">sleep</span> <span class="token variable">$INTERVAL</span>
<span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>想要在 Kubernetes 中设置自定义参数，可以在 <code>spec.containers.env</code> 中声明：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> fortune
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> INTERVAL
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"30"</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>generator<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也可以使用 <code>$(VAR)</code> 语法在环境变量值中引用其他环境变量：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> fortune
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FIRST_VAR
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"foobar"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SECOND_VAR
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"$(FIRST_VAR)2000"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="创建-configmap"><a class="markdownIt-Anchor" href="#创建-configmap"></a> 创建 ConfigMap</h2>
<p>可以直接通过命令行来创建一个最简单的 ConfigMap：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create configmap fortune-config --from-literal<span class="token operator">=</span>sleep-interval<span class="token operator">=</span><span class="token number">5</span>
configmap/fortune-config created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这条指令创建了名为 <code>fortune-config</code> 的 ConfigMap，仅包含单映射条目 <code>sleep-interval=5</code>。可以通过添加多个 <code>--from-literal</code> 参数创建包含多条目的 ConfigMap：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create configmap fortune-config --from-literal<span class="token operator">=</span>one<span class="token operator">=</span><span class="token number">1</span> --from-literal<span class="token operator">=</span>two<span class="token operator">=</span><span class="token number">11</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>通过观察 YAML 格式的定义描述，可以自定义配置文件，然后通过 <code>create -f</code> 来创建 ConfigMap。</p>
<p>可以直接从硬盘中读取文件，并将文件内容单独存储为 ConfigMap 中的值。例如，将当前目录下的 <code>my.config</code> 文件内容存为键名为 <code>devconfig</code> 的值：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master <span class="token number">2</span><span class="token punctuation">]</span>$ kubectl create configmap my-config --from-file<span class="token operator">=</span>devconfig<span class="token operator">=</span>my.config<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>通过多次使用 <code>--from-file</code> 参数可以增加多个文件条目。另外，还可以使用 <code>--from-file</code> 指定目录，<code>kubectl</code> 会为文件夹中的每个文件单独创建条目，键名为文件名：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create configmap my-config-dir --from-file<span class="token operator">=</span>k8s
configmap/my-config-dir created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ConfigMap 可以混合使用多种类型的配置，例如一个 <code>my-config</code> 同时包含键值对和文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create configmap my-config --from-file<span class="token operator">=</span>foo.json --from-file<span class="token operator">=</span>bar<span class="token operator">=</span>foobar.conf --from-file<span class="token operator">=</span>config-opts/ --from-literal<span class="token operator">=</span>some<span class="token operator">=</span>thing<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="传递-configmap"><a class="markdownIt-Anchor" href="#传递-configmap"></a> 传递 ConfigMap</h2>
<p>将值传递给 Pod 中的容器有三种方式。如果引用的 ConfigMap 不存在，容器会启动失败。也可以设置 <code>optional: true</code> 对引用进行可选设置。</p>
<ul>
<li>
<p>通过环境变量传递键值</p>
<p>需要在 <code>spec.containers.env.valueFrom</code> 字段中指定：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> fortune
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> INTERVAL
      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
        <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> fortune<span class="token punctuation">-</span>config
          <span class="token key atrule">key</span><span class="token punctuation">:</span> sleep<span class="token punctuation">-</span>interval<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里传递了一个环境变量 <code>INTERVAL</code>，值取自 <code>fortune-config</code> 中键 <code>sleep-interval</code> 的值，然后由容器内的进程读取。</p>
</li>
<li>
<p>传递整个 ConfigMap 中的键值</p>
<p>在 <code>spec.containers</code> 中加入 <code>envFrom</code> 字段来传递整个 ConfigMap 中的键值对：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> fortune
    <span class="token key atrule">envFrom</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">prefix</span><span class="token punctuation">:</span> CONFIG_
      <span class="token key atrule">configMapRef</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>cofig<span class="token punctuation">-</span>map<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面设置了所有导入的环境变量包含前缀 <code>CONFIG_</code>，若不设置前缀，环境变量的名称与 ConfigMap 中的键名相同。若键名不合法时不会自动转换。</p>
</li>
<li>
<p>传递 ConfigMap 条目作为命令行参数</p>
<p>在字段 <code>spec.containers.args</code> 中无法直接引用 ConfigMap 的条目，但可以利用 ConfigMap 条目初始化某个环境变量，然后再在参数字段中引用该变量：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> fortune
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> INTERVAL
      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
        <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> fortune<span class="token punctuation">-</span>config
          <span class="token key atrule">key</span><span class="token punctuation">:</span> sleep<span class="token punctuation">-</span>interval
    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"$(INTERVAL)"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h2 id="使用-configmap-卷"><a class="markdownIt-Anchor" href="#使用-configmap-卷"></a> 使用 ConfigMap 卷</h2>
<p>由于 ConfigMap 中可以包含完整的配置文件内容，想要将其暴露给容器时可以借助 ConfigMap 卷。ConfigMap 卷会将 ConfigMap 中的每个条目暴露为一个文件，运行在容器中的进程通过读取文件内容获得对应的条目值。</p>
<p>例如，将目录中的 Nginx 配置文件和 <code>interval</code> 文件一起创建名为 <code>fortune-config</code> 的 ConfigMap：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master configmap-files<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> <span class="token string">"25"</span> <span class="token operator">></span> interval
<span class="token punctuation">[</span>root@server4-master configmap-files<span class="token punctuation">]</span>$ <span class="token function">vi</span> advertise-task.iot.com.conf 
server <span class="token punctuation">&#123;</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name advertise-task.iot.com<span class="token punctuation">;</span>
    location / <span class="token punctuation">&#123;</span>
        proxy_pass http://advertise-task.iot.com.dev<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">[</span>root@server4-master configmap-files<span class="token punctuation">]</span>$ kubectl create configmap fortune-config --from-file<span class="token operator">=</span><span class="token punctuation">..</span>/configmap-files/
configmap/fortune-config created
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl get configmaps fortune-config <span class="token parameter variable">-o</span> yaml
apiVersion: v1
data:
  interval: <span class="token operator">|</span>
    <span class="token number">25</span>
  advertise-task.iot.com.conf: <span class="token operator">|</span>
    server <span class="token punctuation">&#123;</span>
        listen <span class="token number">80</span><span class="token punctuation">;</span>
        server_name advertise-task.iot.com<span class="token punctuation">;</span>
        location / <span class="token punctuation">&#123;</span>
            proxy_pass http://advertise-task.iot.com.dev<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
kind: ConfigMap
metadata:
  creationTimestamp: <span class="token string">"2022-03-15T14:01:15Z"</span>
  name: fortune-config
  namespace: default
  resourceVersion: <span class="token string">"580367"</span>
  uid: 9a4c9cb4-c2d2-424c-9d57-ac3fe1851260<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将 ConfigMap 卷内的文件挂载到 <code>/etc/nginx/conf.d/</code> 目录下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine
    <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>server
	<span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
	<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
	  <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/nginx/conf.d
	  <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
	  <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
	    <span class="token key atrule">name</span><span class="token punctuation">:</span> fortune<span class="token punctuation">-</span>config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也可以单独指定需要挂载的 ConfigMap 卷内文件。这里将 ConfigMap 卷内的配置文件 <code>advertise-task.iot.com.conf</code> 重命名为 <code>at.conf</code> 并挂载到指定目录下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
	  <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
	    <span class="token key atrule">name</span><span class="token punctuation">:</span> fortune<span class="token punctuation">-</span>config
	    <span class="token key atrule">items</span><span class="token punctuation">:</span>
	    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> advertise<span class="token punctuation">-</span>task.iot.com.conf
	      <span class="token key atrule">path</span><span class="token punctuation">:</span> at.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用上述方法挂载卷时，容器内原有的同名目录会被隐藏，被挂载的目录会替代之。如果想要单独挂载文件而不是目录，需要在 <code>spec.containers.volumeMounts</code> 下面加入 <code>subPath</code> 字段：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine
    <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>server
	<span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
	<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
	  <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/nginx/conf.d/advertise<span class="token punctuation">-</span>task.iot.com.conf
	  <span class="token key atrule">subPath</span><span class="token punctuation">:</span> advertise<span class="token punctuation">-</span>task.iot.com.conf
	  <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ConfigMap 卷中所有文件的默认权限是 644，可以在 <code>spec.volumes.configMap</code> 中加入 <code>defaultMode</code> 来改变默认权限：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
	  <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
	    <span class="token key atrule">name</span><span class="token punctuation">:</span> fortune<span class="token punctuation">-</span>config
	    <span class="token key atrule">defaultMod</span><span class="token punctuation">:</span> <span class="token string">"6600"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将 ConfigMap 作为卷挂载可以实现配置的热更新效果，无需重启或重建 Pod。在修改了 ConfigMap 的配置后，可以通过 <code>kubectl exec</code> 命令来手动载入更新的配置：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl edit configmap fortune-config
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl <span class="token builtin class-name">exec</span> fortune <span class="token parameter variable">-c</span> web-server -- nginx <span class="token parameter variable">-s</span> reload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>但如果挂载的单个文件，ConfigMap 更新后对应的文件不会被更新。</p>
<h1 id="secret-资源"><a class="markdownIt-Anchor" href="#secret-资源"></a> Secret 资源</h1>
<p>Secret 的结构和使用方法与 ConfigMap 相同，也是键值对的映射，主要用来保存敏感信息，例如账号和证书。</p>
<p>Kubernetes 通过将 Secret 分发到 Pod 所在的节点来保障安全性，Secret 只会存储在节点的内存中，从而无法被窃取。</p>
<h2 id="默认令牌"><a class="markdownIt-Anchor" href="#默认令牌"></a> 默认令牌</h2>
<p>在 Kubernetes 安装完成后，会生成一个以 default-token 开头的默认 Secret，它会挂载到所有容器中：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl get secrets 
NAME                  TYPE                                  DATA   AGE
default-token-vqjsw   kubernetes.io/service-account-token   <span class="token number">3</span>      132d
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl describe secrets default-token-vqjsw
Name:         default-token-vqjsw
Namespace:    default
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">></span>
Annotations:  kubernetes.io/service-account.name: default
              kubernetes.io/service-account.uid: ae0b90b8-1323-42a2-990b-a18d4bfb7da8

Type:  kubernetes.io/service-account-token

Data
<span class="token operator">==</span><span class="token operator">==</span>
ca.crt:     <span class="token number">1099</span> bytes
namespace:  <span class="token number">7</span> bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IlZDd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>默认的 Secret 包含三个条目：ca.crt、namespace 和 token，其中包含了访问 API 服务器所需的安全信息。</p>
<p>可以在 Pod 信息的 Mount 栏中看到 Secret 卷挂载的位置：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl describe po dnsutils 
Containers:
  dnsutils:
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-5ghsj <span class="token punctuation">(</span>ro<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>默认的挂载行为可以通过在 Pod 定义中设置 <code>automountServiceAccountToken</code> 字段为 <code>false</code> 来关闭。</p>
<h2 id="创建-secret"><a class="markdownIt-Anchor" href="#创建-secret"></a> 创建 Secret</h2>
<p>使用命令行创建一个名为 ngx-https 的 Secret，用于存储 Nginx 所需的私钥和证书：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create secret generic ngx-https --from-file<span class="token operator">=</span>https.cert --from-file<span class="token operator">=</span>https.key --from-file<span class="token operator">=</span>foo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Secret 条目的内容会以 Base64 格式编码，而 ConfigMap 则直接以纯文本形式显示。因此，Secret 还可以用于存储最大为 1MB 的二进制数据。</p>
<p>通过 <code>stringData</code> 字段设置条目的纯文本值，该值不会被编码为 Base64：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> secret-test.yaml
apiVersion: v1
kind: Secret
stringData:
  foo: ymfyc
data:
  https.cert: Ls-3lcc
  https.key: Lsv9elx
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> secret-test.yaml <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意，<code>stringData</code> 字段只可写入。</p>
<h2 id="使用-secret"><a class="markdownIt-Anchor" href="#使用-secret"></a> 使用 Secret</h2>
<p>将 Secret 通过 Secret 卷暴露给容器后，Secret 条目的值将解码为实际形式（纯文本或二进制），并写入相应的文件中。同样，通过环境变量暴露 Secret 条目也是如此。在这两种情况下，应用程序无需手动解码，可以直接读取文件内容或查找环境变量：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
	<span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
	<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> certs
	  <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/nginx/certs/
	  <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> certs
	  <span class="token key atrule">secret</span><span class="token punctuation">:</span>
	    <span class="token key atrule">secretame</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>https<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>与 ConfigMap 卷相同，Secret 卷同样支持使用 <code>defaultModes</code> 属性指定卷中文件的默认权限。</p>
<p>Secret 条目也可以暴露为环境变量：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> INTERVAL
      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
	    <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
		  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>https
		  <span class="token key atrule">key</span><span class="token punctuation">:</span> foo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以创建一个类型为 <code>docker-registry</code> 的 Secret，名称为 <code>dockerhubsecret</code>，其中包含 Docker 镜像仓库证书，并在拉取镜像时进行引用：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master <span class="token number">2</span><span class="token punctuation">]</span>$ kubectl create secret docker-registry dockerhubsecret <span class="token punctuation">\</span>
 --docker-username<span class="token operator">=</span>myusername --docker-password<span class="token operator">=</span>mypasswd <span class="token punctuation">\</span>
 --docker-email<span class="token operator">=</span>my@email.com
<span class="token punctuation">[</span>root@k8s-master <span class="token number">2</span><span class="token punctuation">]</span>$ <span class="token function">vi</span> dockerhub.yaml
apiVersion: v1
kind: Pod
metadata:
  name: privae-pod
spec:
  imagePullSecrets:
  - name: dockerhubsecret
  containers:
  - image: assassing/av:v1
    name: main<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="底层持久化储存"><a class="markdownIt-Anchor" href="#底层持久化储存"></a> 底层持久化储存</h1>
<p>在 Kubernetes 中，底层持久化存储是一个重要的组件，用于存储应用程序的持久化数据，并确保数据的安全性和持久性。</p>
<h2 id="hostpath-卷"><a class="markdownIt-Anchor" href="#hostpath-卷"></a> hostPath 卷</h2>
<p>hostPath 卷用于指向节点文件系统中的特定文件或目录。由于文件存储在特定节点的文件系统中，因此当 Pod 被重新调度到另一个节点时，可能无法访问数据。在 Kubernetes 的系统级服务 Pod 中，通常使用 hostPath 卷来访问节点的日志、配置文件或 CA 证书，但不推荐将其用于存储数据：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">volumes</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"hostpath"</span>
  <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"/data"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>此外，还可以使用 <code>type</code> 参数来指定卷的类型：</p>
<ul>
<li><code>DirectoryOrCreate</code>：如果指定的路径不存在，则自动创建一个权限为 0755 的空目录，所有者为 kubelet。</li>
<li><code>Directory</code>：必须存在的目录路径。</li>
<li><code>FileOrCreate</code>：如果指定的路径不存在，则自动创建一个权限为 0644 的空文件，所有者为 kubelet。</li>
<li><code>File</code>：必须存在的文件路径。</li>
<li><code>Socket</code>：必须存在的 Socket 文件路径。</li>
<li><code>CharDevice</code>：必须存在的字符设备文件路径。</li>
<li><code>BlockDevice</code>：必须存在的块设备文件路径。</li>
</ul>
<p>根据实际需求选择合适的 <code>type</code> 参数来配置 hostPath 卷。请注意，使用 hostPath 卷时需要谨慎，确保数据的可靠性和安全性。</p>
<h2 id="gce-持久储存"><a class="markdownIt-Anchor" href="#gce-持久储存"></a> GCE 持久储存</h2>
<p>如果集群运行在 Google Kubernetes Engine 中，你可以选择使用 GCE 持久化磁盘作为底层存储机制。首先，在同一区域的 Kubernetes 集群中创建一个 GCE 持久化磁盘，例如在 “europe-west” 区域，然后创建一个带有 GCE 持久化磁盘卷的 Pod：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongodb
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mongo
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mongodb
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">-</span>data
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data.db
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">27017</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">-</span>data
    <span class="token key atrule">gcePersistentDisk</span><span class="token punctuation">:</span>
      <span class="token key atrule">pdName</span><span class="token punctuation">:</span> mongodb
      <span class="token key atrule">fsType</span><span class="token punctuation">:</span> ext4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>定义名称和文件系统类型为 ext4，接着向 mongodb 写入数据：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> mongodb mongo
<span class="token punctuation">[</span>root@mongodb ~<span class="token punctuation">]</span>use mystore
<span class="token punctuation">[</span>root@mongodb ~<span class="token punctuation">]</span>db.foo.insert<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>name:<span class="token string">'foo'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@mongodb ~<span class="token punctuation">]</span>db.foo.find<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>重建 Pod 后读取上一个 Pod 保存的数据：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>kubectl delete pod mongodb
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>kubectl create <span class="token parameter variable">-f</span> mongodb.yaml
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> mongodb mongo
<span class="token punctuation">[</span>root@mongodb ~<span class="token punctuation">]</span>use mystore
<span class="token punctuation">[</span>root@mongodb ~<span class="token punctuation">]</span>db.foo.find<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果数据仍然存在，则说明持久化成功。</p>
<h2 id="其他持久化储存卷"><a class="markdownIt-Anchor" href="#其他持久化储存卷"></a> 其他持久化储存卷</h2>
<p>根据不同的基础设施，可以选择使用不同类型的持久化存储卷。例如，在 Amazon 上可以使用 awsElasticBlockStore 卷，在 Microsoft Azure 上可以使用 azureFile 或 azureDisk 卷。下面是一个使用 AWS 的示例：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongodb
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">-</span>data
    <span class="token key atrule">awsElasticBlockStore</span><span class="token punctuation">:</span>
      <span class="token key atrule">volumeID</span><span class="token punctuation">:</span> mongodb
      <span class="token key atrule">fsType</span><span class="token punctuation">:</span> ext4
<span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于 NFS 共享，只需要指定 NFS 服务器的 IP 地址和共享路径即可：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">...</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongodb<span class="token punctuation">-</span>data
    <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span> 1.2.3.4
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /some/path
<span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>要了解每种卷类型所需的属性设置，可以查询 Kubernetes API 文档，或使用 <code>kubectl explain</code> 命令。</p>
<p>需要注意的是，将这些基础设施类型放在 Pod 的配置中意味着该 Pod 的设置与特定集群强耦合，这样无法在另一个 Pod 中重复使用相同的设置。因此，在设计和配置持久化存储时需要谨慎考虑。</p>
<h1 id="持久卷和持久卷声明"><a class="markdownIt-Anchor" href="#持久卷和持久卷声明"></a> 持久卷和持久卷声明</h1>
<p>在集群中为了使应用正常请求储存资源，同时避免处理基础设施细节，引入了两个新资源，分别是持久卷（PersistentVolume，PV）和持久卷声明（PersistentVolumeClaim，PVC）。</p>
<p>当集群用户需要在其 pod 中使用持久化储存时，首先创建持久卷声明清单，指定所需最低容量要求和访问模式，由 API 服务器分配持久卷并绑定到持久卷声明中。</p>
<p>持久卷声明可以当做 pod 中的一个卷来使用，其他用户不能使用相同的持久卷，除非先通过删除持久卷声明释放。</p>
<p>下图展示了 PV 和 PVC 的关系:</p>
<p><img data-src="../../../images/PV%E5%92%8CPVC.jpg" alt="PV和PVC" /></p>
<p>下面用 NFS 文件系统做示例。</p>
<h2 id="安装-nfs-文件系统"><a class="markdownIt-Anchor" href="#安装-nfs-文件系统"></a> 安装 NFS 文件系统</h2>
<p>在所有节点上进行安装 NFS 套件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ yum <span class="token function">install</span> nfs-utils rpcbind <span class="token parameter variable">-y</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> nfs
Created symlink from /etc/systemd/system/multi-user.target.wants/nfs-server.service to /usr/lib/systemd/system/nfs-server.service.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>在 NFS 服务器上启动服务：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> rpcbind<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>配置服务器上的共享目录：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">mkdir</span> /srv/pv
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">chown</span> nfsnobody:nfsnobody /srv/pv
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">chmod</span> <span class="token number">755</span> /srv/pv
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"/srv/pv *(rw,no_root_squash,sync)"</span><span class="token operator">></span>/etc/exports
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ exportfs <span class="token parameter variable">-r</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ exportfs
/srv/pv         <span class="token operator">&lt;</span>world<span class="token operator">></span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ showmount <span class="token parameter variable">-e</span> <span class="token number">192.168</span>.2.204
Export list <span class="token keyword">for</span> <span class="token number">192.168</span>.2.204:
/srv/pv *<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改最大同时连接用户数：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> <span class="token string">"options sunrpc tcp_slot_table_entries=128"</span> <span class="token operator">>></span> /etc/modprobe.d/sunrpc.conf
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> <span class="token string">"options sunrpc tcp_max_slot_table_entries=128"</span> <span class="token operator">>></span>  /etc/modprobe.d/sunrpc.conf
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">sysctl</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">sunrpc.tcp_slot_table_entries</span><span class="token operator">=</span><span class="token number">128</span>
sunrpc.tcp_slot_table_entries <span class="token operator">=</span> <span class="token number">128</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建新的挂载点：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /srv/pv/pv001 /srv/pv/pv002
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"/srv/pv/pv001 *(rw,no_root_squash,sync)"</span><span class="token operator">>></span>/etc/exports
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">"/srv/pv/pv002 *(rw,no_root_squash,sync)"</span><span class="token operator">>></span>/etc/exports
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ exportfs <span class="token parameter variable">-r</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ systemctl restart rpcbind <span class="token operator">&amp;&amp;</span> systemctl restart nfs
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ showmount <span class="token parameter variable">-e</span> <span class="token number">192.168</span>.2.204
Export list <span class="token keyword">for</span> <span class="token number">192.168</span>.2.204:
/srv/pv/pv002 *
/srv/pv/pv001 *
/srv/pv       *<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="创建持久卷"><a class="markdownIt-Anchor" href="#创建持久卷"></a> 创建持久卷</h2>
<p>配置一个 1 GB 大小的持久卷，供 MongoDB 使用：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> mongodb-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mongodb-pv
spec:
  capacity:
    storage: 1Gi
  accessModes:
  - ReadWriteOnce
  - ReadOnlyMany
  persistentVolumeReclaimPolicy: Retain
  nfs:
    path: /srv/pv
    server: <span class="token number">192.168</span>.2.204
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> mongodb-pv.yaml 
persistentvolume/mongodb-pv created
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl get <span class="token function">pv</span>
NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
mongodb-pv   1Gi        RWO,ROX        Retain           Available                                   4s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>持久卷不属于任何命名空间，它和节点一样是集群层面的资源。</p>
<h2 id="创建持久卷声明"><a class="markdownIt-Anchor" href="#创建持久卷声明"></a> 创建持久卷声明</h2>
<p>如果 Pod 需要使用之前创建的持久卷，需要创建一个持久卷声明：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> mongodb-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mongodb-pvc
spec:
  resources:
    requests:
      storage: 1Gi
  accessModes:
  - ReadWriteOnce
  storageClassName: <span class="token string">""</span>
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> mongodb-pvc.yaml
persistentvolumeclaim/mongodb-pvc created
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl get pvc
NAME          STATUS   VOLUME       CAPACITY   ACCESS MODES   STORAGECLASS   AGE
mongodb-pvc   Bound    mongodb-pv   1Gi        RWO,ROX                       4s
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过查看 PVC（持久卷声明）状态，可以确认 PVC 已经与相应的 PV（持久卷）绑定。其中访问模式的简写含义如下：</p>
<ul>
<li>
<p>RWO（ReadWriteOnce）：仅允许单个节点挂载读写。</p>
</li>
<li>
<p>ROX（ReadOnlyMany）：允许多个节点挂载只读。</p>
</li>
<li>
<p>RWX（ReadWriteMany）：允许多个节点挂载读写。</p>
</li>
</ul>
<p>这里的节点指的是 Kubernetes 节点，而不是 Pod 的数量。</p>
<p>再次查看 PV 的状态：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl get <span class="token function">pv</span>
NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS   REASON   AGE
mongodb-pv   1Gi        RWO,ROX        Retain           Bound    default/mongodb-pvc                           12m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>可以看到它已经被绑定到 PVC 的声明中。其中 CLAIM 中的 default 表示默认命名空间。虽然持久卷属于整个集群，但持久卷声明只能在特定的命名空间内创建。因此，持久卷和持久卷声明只能由同一命名空间内的 Pod 创建和使用。还可以使用选择器来为 PV 应用标签选择器。</p>
<h2 id="使用持久卷声明"><a class="markdownIt-Anchor" href="#使用持久卷声明"></a> 使用持久卷声明</h2>
<p>在 Pod 中使用持久卷时，需要在 Pod 的卷中引用 PVC 的名称：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> mongodb-pod.yaml
apiVersion: v1
kind: Service
metadata:
  name: mongodb
spec:
  type: NodePort
  ports:
  - port: <span class="token number">27017</span>
    targetPort: <span class="token number">27017</span>
    nodePort: <span class="token number">30000</span>
  selector:
    app: kubia
---
apiVersion: v1
kind: Pod
metadata:
  name: mongodb
  labels:
    app: mongo
spec:
  containers:
  - image: mongo
    name: mongodb
    volumeMounts:
    - name: mongodb-data
      mountPath: /data/db
    ports:
    - containerPort: <span class="token number">27017</span>
      protocol: TCP
  volumes:
  - name: mongodb-data
    persistentVolumeClaim:
      claimName: mongodb-pvc
<span class="token punctuation">[</span>root@server4-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> mongodb-pod.yaml 
pod/mongodb created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>请注意，虽然 PV 是全局资源，但 PVC 属于特定命名空间，只有同一命名空间内的 Pod 才能调用。</p>
<h2 id="删除持久卷"><a class="markdownIt-Anchor" href="#删除持久卷"></a> 删除持久卷</h2>
<p>在持久卷正在被使用时，不能直接删除它，需要先删除使用该持久卷的 Pod 和 PVC。持久卷的空间释放处理机制有三种：</p>
<ul>
<li>
<p>Retain（保留）</p>
<p>删除 PV 后，根据设置的释放规则（Retain），硬盘中的文件仍然存在。重新创建 PV、PVC 和 Pod 后，文件内容和上一次运行时一样。使用 Retain 手动回收策略只能通过删除和重建持久卷来恢复可用状态。</p>
</li>
<li>
<p>Recycle（回收）</p>
<p>删除 PVC 后，会删除卷的内容，并使卷可用于再次声明。</p>
</li>
<li>
<p>Delete（删除）</p>
<p>删除底层存储。</p>
</li>
</ul>
<h2 id="动态化持久卷"><a class="markdownIt-Anchor" href="#动态化持久卷"></a> 动态化持久卷</h2>
<p>在 Kubernetes 中，可以通过创建持久卷配置并定义一个或多个 StorageClass 对象，实现每次通过持久卷声明请求时自动创建一个新的持久卷。获取动态持久卷的步骤如下图所示：</p>
<p><img data-src="../../../images/%E8%8E%B7%E5%8F%96%E5%8A%A8%E6%80%81%E6%8C%81%E4%B9%85%E5%8D%B7.jpg" alt="获取动态持久卷" /></p>
<p>不同的后端存储需要不同的置备程序（provisioner）。以 NFS 文件系统为例，首先需要部署 nfs-client：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master html<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> <span class="token string">"/root/3/html *(rw,sync,no_root_squash)"</span> <span class="token operator">>></span> /etc/exports
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> nfs-dp.yaml
kind: Deployment
apiVersion: extensions/v1beta1
metadata:
  name: nfs-client-provisioner
spec:
  replicas: <span class="token number">1</span>
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: nfs-client-provisioner
    spec:
      serviceAccount: nfs-client-provisioner
      containers:
        - name: nfs-client-provisioner
          image: jmgao1983/nfs-client-provisioner
          volumeMounts:
            - name: nfs-client-root
              mountPath: /persistentvolumes
          env:
            - name: PROVISIONER_NAME
              value: mynfs
            - name: NFS_SERVER
              value: <span class="token number">192.168</span>.2.113
            - name: NFS_PATH
              value: /srv/pv
      volumes:
        - name: nfs-client-root
          nfs:
            server: <span class="token number">192.168</span>.2.113
            path: /srv/pv
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> nfs-dp.yaml
deployment.extensions/nfs-provisioner created
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubectl get deployment
NAME              READY   UP-TO-DATE   AVAILABLE   AGE
nfs-provisioner   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           29s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后创建 StorageClass 资源：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> mongodb-pv-sc.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast
provisioner: mynfs
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> mongodb-pv-sc.yaml
storageclass.storage.k8s.io/fast created
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubectl get sc
NAME   PROVISIONER   AGE
fast   mynfs         9s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建一个 Pod 引用 StorageClass：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> nginx.yaml
apiVersion: apps/v1beta1
kind: StatefulSet
metadata:
  name: web
spec:
  serviceName: <span class="token string">"nginx1"</span>
  replicas: <span class="token number">2</span>
  template:
    metadata:
      labels:
        app: nginx1
    spec:
      containers:
      - name: nginx1
        image: nginx:latest
        volumeMounts:
        - mountPath: <span class="token string">"/mnt"</span>
          name: <span class="token builtin class-name">test</span>
  volumeClaimTemplates:
  - metadata:
      name: <span class="token builtin class-name">test</span>
      annotations:
        volume.beta.kubernetes.io/storage-class: <span class="token string">"fast"</span>
    spec:
      accessModes: <span class="token punctuation">[</span> <span class="token string">"ReadWriteOnce"</span> <span class="token punctuation">]</span>
      resources:
        requests:
          storage: 1Gi
<span class="token string">"nginx.yaml"</span> <span class="token punctuation">[</span>New<span class="token punctuation">]</span> 28L, 556C written
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> nginx.yaml
statefulset.apps/web created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建 ServiceAccount 和角色：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nfs-client-provisioner
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> serviceaccount.yaml
serviceaccount/nfs-client-provisioner created
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubectl get sa
NAME                     SECRETS   AGE
default                  <span class="token number">1</span>         3d14h
nfs-client-provisioner   <span class="token number">1</span>         16s
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> clusterrole.yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: nfs-provisioner-runner
rules:
  - apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"get"</span>, <span class="token string">"list"</span>, <span class="token string">"watch"</span>, <span class="token string">"create"</span>, <span class="token string">"delete"</span><span class="token punctuation">]</span>
  - apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"persistentvolumeclaims"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"get"</span>, <span class="token string">"list"</span>, <span class="token string">"watch"</span>, <span class="token string">"update"</span><span class="token punctuation">]</span>
  - apiGroups: <span class="token punctuation">[</span><span class="token string">"storage.k8s.io"</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"storageclasses"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"get"</span>, <span class="token string">"list"</span>, <span class="token string">"watch"</span><span class="token punctuation">]</span>
  - apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"events"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"watch"</span>, <span class="token string">"create"</span>, <span class="token string">"update"</span>, <span class="token string">"patch"</span><span class="token punctuation">]</span>
  - apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"services"</span>, <span class="token string">"endpoints"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">]</span>
  - apiGroups: <span class="token punctuation">[</span><span class="token string">"extensions"</span><span class="token punctuation">]</span>
    resources: <span class="token punctuation">[</span><span class="token string">"podsecuritypolicies"</span><span class="token punctuation">]</span>
    resourceNames: <span class="token punctuation">[</span><span class="token string">"nfs-provisioner"</span><span class="token punctuation">]</span>
    verbs: <span class="token punctuation">[</span><span class="token string">"use"</span><span class="token punctuation">]</span>
<span class="token string">"clusterrole.yaml"</span> <span class="token punctuation">[</span>New<span class="token punctuation">]</span> 24L, 735C written
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ <span class="token function">vi</span> clusterrolebinding.yaml
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: run-nfs-provisioner
subjects:
  - kind: ServiceAccount
    name: nfs-client-provisioner
    namespace: default
roleRef:
  kind: ClusterRole
  name: nfs-provisioner-runner
  apiGroup: rbac.authorization.k8s.io
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubectl create <span class="token parameter variable">-f</span> clusterrole.yaml <span class="token parameter variable">-f</span> clusterrolebinding.yaml
clusterrole.rbac.authorization.k8s.io/nfs-provisioner-runner created
clusterrolebinding.rbac.authorization.k8s.io/run-nfs-provisioner created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后，验证是否会自动创建新的 PV：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubectl get <span class="token function">pv</span> <span class="token operator">|</span><span class="token function">grep</span> web
pvc-d2423554-6b6e-4c65-9209-e739abe7c653   1Gi        RWO            Delete           Bound       default/test-web-0   fast                    2m28s
pvc-d430fa25-d4e4-4971-961f-80be40b8d9dc   1Gi        RWO            Delete           Bound       default/test-web-1   fast                    2m12s
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubectl get pvc <span class="token operator">|</span><span class="token function">grep</span> web
test-web-0   Bound    pvc-d2423554-6b6e-4c65-9209-e739abe7c653   1Gi        RWO            fast           13m
test-web-1   Bound    pvc-d430fa25-d4e4-4971-961f-80be40b8d9dc   1Gi        RWO            fast           2m36s
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubectl get storageclass
NAME   PROVISIONER   AGE
fast   mynfs         19m
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubectl get pod <span class="token operator">|</span><span class="token function">grep</span> web
web-0                                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8m43s
web-1                                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m29s

<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubectl scale statefulset web <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">3</span>
statefulset.apps/web scaled
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ kubectl get pod <span class="token operator">|</span><span class="token function">grep</span> web
web-0                                    <span class="token number">1</span>/1     Running             <span class="token number">0</span>          9m32s
web-1                                    <span class="token number">1</span>/1     Running             <span class="token number">0</span>          4m18s
web-2                                    <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          4s
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span>$ ll /srv/pv/
total <span class="token number">0</span>
drwxrwxrwx <span class="token number">2</span> root root <span class="token number">6</span> Jul <span class="token number">22</span> <span class="token number">17</span>:34 default-test-web-0-pvc-d2423554-6b6e-4c65-9209-e739abe7c653
drwxrwxrwx <span class="token number">2</span> root root <span class="token number">6</span> Jul <span class="token number">22</span> <span class="token number">17</span>:35 default-test-web-1-pvc-d430fa25-d4e4-4971-961f-80be40b8d9dc
drwxrwxrwx <span class="token number">2</span> root root <span class="token number">6</span> Jul <span class="token number">22</span> <span class="token number">17</span>:39 default-test-web-2-pvc-ffc2b763-2dd8-4a5b-a565-86dd416eba36<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>干杯！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="../images/wechatpay.png" alt="assassing 微信">
        <span>微信</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>assassing
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://blog.x2b.net/1711004813/" title="K8s 储存资源">https://blog.x2b.net/1711004813/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="followme">
  <span>欢迎订阅</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="../atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="../4120596009/" rel="prev" title="K8s 基本资源">
                  <i class="fa fa-chevron-left"></i> K8s 基本资源
                </a>
            </div>
            <div class="post-nav-item">
                <a href="../1488965608/" rel="next" title="K8s 部署指南">
                  K8s 部署指南 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2020 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">assassing</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">351k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">19:29</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener external nofollow noreferrer" target="_blank">NexT.Gemini</a> on Kubernetes
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/hxz393" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener external nofollow noreferrer" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://lib.baomitu.com/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://lib.baomitu.com/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://lib.baomitu.com/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://lib.baomitu.com/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="../js/comments.js"></script><script src="../js/utils.js"></script><script src="../js/motion.js"></script><script src="../js/next-boot.js"></script><script src="../js/pjax.js"></script>

  <script src="https://lib.baomitu.com/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="../js/third-party/search/local-search.js"></script>




  <script src="../js/third-party/pace.js"></script>

  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.4/katex.min.css" integrity="sha256-gMRN4/6qeELzO1wbFa8qQLU8kfuF2dnAPiUoI0ATjx8=" crossorigin="anonymous">
  <script class="next-config" data-name="katex" type="application/json">{"copy_tex_js":{"url":"https://lib.baomitu.com/KaTeX/0.16.4/contrib/copy-tex.min.js","integrity":"sha256-Us54+rSGDSTvIhKKUs4kygE2ipA0RXpWWh0/zLqw3bs="}}</script>
  <script src="../js/third-party/math/katex.js"></script>


  <script src="https://lib.baomitu.com/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":5000,"priority":true,"url":"https://blog.x2b.net/1711004813/"}</script>
  <script src="../js/third-party/quicklink.js"></script>
<link rel="stylesheet" href="https://lib.baomitu.com/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"hxz393","repo":"x2b.net-deploy","client_id":"26664aab919326dcf7e7","client_secret":"40882da22b7a77aea4a985ccd95a9363cfb7ba9a","admin_user":"hxz393","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"d41d8cd98f00b204e9800998ecf8427e"}</script>
<script src="../js/third-party/comments/gitalk.js"></script>

</body>
</html>
