<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#922"><meta name="generator" content="Hexo 6.3.0">
<link rel="preconnect" href="https://fonts.cat.net" crossorigin>
<link rel="preconnect" href="https://lib.baomitu.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="../images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png">
  <link rel="mask-icon" href="../images/favicon-32x32.png" color="#922">

<link rel="stylesheet" href="../css/main.css">

<link rel="stylesheet" href="https://fonts.cat.net/css?family=Monda:300,300italic,400,400italic,700,700italic%7CArvo:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CPT+Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://lib.baomitu.com/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://lib.baomitu.com/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://lib.baomitu.com/pace/1.2.4/themes/red/pace-theme-minimal.css">
  <script src="https://lib.baomitu.com/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.x2b.net","root":"/","images":"../images","scheme":"Gemini","darkmode":false,"version":"8.15.1","exturl":false,"sidebar":{"position":"left","width":300,"display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#922","save":"manual"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":{"gitalk":{"order":-1}},"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"../search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":true,"preload":true}}</script><script src="../js/config.js"></script>

    <meta name="description" content="网络爬虫 虽然可以使用 Go 的 net&#x2F;http 包来发送请求功能，在此基础上添加 HTML 解析和其他逻辑来抓取和处理数据，实现基础的爬虫功能。然而这样通常需要手动处理很多细节，如链接提取、相对链接转换、错误处理等，这些在专门的爬虫框架中往往已经很好地集成了。">
<meta property="og:type" content="article">
<meta property="og:title" content="Go 语言写网络爬虫">
<meta property="og:url" content="https://blog.x2b.net/2826025175/index.html">
<meta property="og:site_name" content="X to Bytes">
<meta property="og:description" content="网络爬虫 虽然可以使用 Go 的 net&#x2F;http 包来发送请求功能，在此基础上添加 HTML 解析和其他逻辑来抓取和处理数据，实现基础的爬虫功能。然而这样通常需要手动处理很多细节，如链接提取、相对链接转换、错误处理等，这些在专门的爬虫框架中往往已经很好地集成了。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-07-12T02:10:57.000Z">
<meta property="article:modified_time" content="2024-07-23T10:10:00.243Z">
<meta property="article:author" content="assassing">
<meta property="article:tag" content="docker k8s linux python">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.x2b.net/2826025175/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.x2b.net/2826025175/","path":"2826025175/","title":"Go 语言写网络爬虫"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Go 语言写网络爬虫 | X to Bytes</title>
  

  <script src="../js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?71ae334aaa654e1cd3ba0c9eb55f88a3"></script>







  <noscript>
    <link rel="stylesheet" href="../css/noscript.css">
  </noscript>
<link rel="alternate" href="atom.xml" title="X to Bytes" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">X to Bytes</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="../about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-categories"><a href="../categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">22</span></a></li><li class="menu-item menu-item-archives"><a href="../archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">141</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB"><span class="nav-number">1.</span> <span class="nav-text"> 网络爬虫</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#rod"><span class="nav-number">2.</span> <span class="nav-text"> Rod</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#colly"><span class="nav-number">3.</span> <span class="nav-text"> Colly</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-collector"><span class="nav-number">3.1.</span> <span class="nav-text"> 创建 Collector</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9F%E7%8E%87%E9%99%90%E5%88%B6"><span class="nav-number">3.2.</span> <span class="nav-text"> 速率限制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E9%98%B6%E6%AE%B5%E5%A4%84%E7%90%86"><span class="nav-number">3.3.</span> <span class="nav-text"> 分阶段处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#css-%E9%80%89%E6%8B%A9%E5%99%A8"><span class="nav-number">3.4.</span> <span class="nav-text"> CSS 选择器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82"><span class="nav-number">3.5.</span> <span class="nav-text"> 发送请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B9%B6%E5%8F%91%E8%AF%B7%E6%B1%82"><span class="nav-number">3.6.</span> <span class="nav-text"> 并发请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%A1%E7%90%86-cookie"><span class="nav-number">3.7.</span> <span class="nav-text"> 管理 Cookie</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E5%8C%96%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.8.</span> <span class="nav-text"> 模块化设计</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%88%AC%E8%99%AB%E5%AE%9E%E4%BE%8B"><span class="nav-number">4.</span> <span class="nav-text"> 爬虫实例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AC%E5%BC%80%E6%95%B0%E6%8D%AE"><span class="nav-number">4.1.</span> <span class="nav-text"> 公开数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E9%83%A8%E6%95%B0%E6%8D%AE"><span class="nav-number">4.2.</span> <span class="nav-text"> 内部数据</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="assassing"
      src="../images/avatar.jpg">
  <p class="site-author-name" itemprop="name">assassing</p>
  <div class="site-description" itemprop="description">技术分享</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="../archives/">
          <span class="site-state-item-count">141</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="../categories/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hxz393" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxz393" rel="noopener me external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://youtube.com/hxz393" title="YouTube → https:&#x2F;&#x2F;youtube.com&#x2F;hxz393" rel="noopener me external nofollow noreferrer" target="_blank"><i class="fab fa-youtube fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://www.discogs.com/user/assassing" title="https:&#x2F;&#x2F;www.discogs.com&#x2F;user&#x2F;assassing" rel="noopener external nofollow noreferrer" target="_blank">Discogs</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://www.last.fm/user/assassing" title="https:&#x2F;&#x2F;www.last.fm&#x2F;user&#x2F;assassing" rel="noopener external nofollow noreferrer" target="_blank">Last.fm</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://anidb.net/up795303" title="https:&#x2F;&#x2F;anidb.net&#x2F;up795303" rel="noopener external nofollow noreferrer" target="_blank">AniDB</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.x2b.net/2826025175/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="../images/avatar.jpg">
      <meta itemprop="name" content="assassing">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="X to Bytes">
      <meta itemprop="description" content="技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Go 语言写网络爬虫 | X to Bytes">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Go 语言写网络爬虫
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-07-12 10:10:57" itemprop="dateCreated datePublished" datetime="2024-07-12T10:10:57+08:00">2024-07-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-07-23 18:10:00" itemprop="dateModified" datetime="2024-07-23T18:10:00+08:00">2024-07-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Go/" itemprop="url" rel="index"><span itemprop="name">Go</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="../categories/Go/5-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">5.网络编程</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>16 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="网络爬虫"><a class="markdownIt-Anchor" href="#网络爬虫"></a> 网络爬虫</h1>
<p>虽然可以使用 Go 的 <code>net/http</code> 包来发送请求功能，在此基础上添加 HTML 解析和其他逻辑来抓取和处理数据，实现基础的爬虫功能。然而这样通常需要手动处理很多细节，如链接提取、相对链接转换、错误处理等，这些在专门的爬虫框架中往往已经很好地集成了。</p>
<p>网络爬虫是自动化的脚本或程序，通常建立在 HTTP 客户端之上，不仅包括发送请求和接收响应的功能，还涵盖了链接跟踪、数据提取、内容分析等复杂功能。</p>
<p>Go 语言中常用的爬虫工具有：</p>
<ul>
<li>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/gocolly/colly">Colly</a>：使用最广泛的爬虫框架，支持高级功能如自动遍历、错误处理、限速、缓存等。</p>
</li>
<li>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://golang.org/x/net/html">html</a>：是 Go 标准库之一，基于 DOM 解析 HTML 文档。</p>
</li>
<li>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/PuerkitoBio/goquery">Goquery</a>：使用类似于 jQuery 的语法来选择和操作 HTML 元素，主要用于解析和提取 HTML 数据。</p>
</li>
<li>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/go-rod/rod">Rod</a>：是一个直接基于 Chrome DevTools Protocol 的高级驱动程序，为网页自动化和爬虫而设计，适用于需要渲染 JavaScript 或处理复杂交互的网站。</p>
</li>
</ul>
<p>普通网站爬取一般使用 <code>colly</code> 配合 <code>html</code> 或 <code>goquery</code> 能完成任务，但对于动态网页的自动化测试，要使用类似于 <code>Rod</code> 这样采用无头客户端的程序来操作。</p>
<h1 id="rod"><a class="markdownIt-Anchor" href="#rod"></a> Rod</h1>
<p>下面只展示一个基本用法，官方文档有<a target="_blank" rel="noopener external nofollow noreferrer" href="https://pkg.go.dev/github.com/go-rod/go-rod-chinese">中文版</a>，非常详细：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/go-rod/rod"</span>
	<span class="token string">"github.com/go-rod/rod/lib/launcher"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 启动无头模式的浏览器实例</span>
	l <span class="token operator">:=</span> launcher<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Headless</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token comment">// 设置为无头模式</span>
		<span class="token function">MustLaunch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 创建一个浏览器实例并连接到浏览器</span>
	browser <span class="token operator">:=</span> rod<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ControlURL</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">MustConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> browser<span class="token punctuation">.</span><span class="token function">MustClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 确保浏览器最终关闭</span>

	<span class="token comment">// 打开新的页面</span>
	page <span class="token operator">:=</span> browser<span class="token punctuation">.</span><span class="token function">MustPage</span><span class="token punctuation">(</span><span class="token string">"http://www.httpbin.org/"</span><span class="token punctuation">)</span>
	<span class="token comment">// 等待页面完全加载</span>
	page<span class="token punctuation">.</span><span class="token function">MustWaitLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 寻找特定元素并点击</span>
	button <span class="token operator">:=</span> page<span class="token punctuation">.</span><span class="token function">MustElement</span><span class="token punctuation">(</span><span class="token string">"body > a"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> button <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		x <span class="token operator">:=</span> button<span class="token punctuation">.</span><span class="token function">MustClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行代码后，会用无头模式浏览器访问 <code>http://www.httpbin.org/</code>，并点击 <code>body &gt; a</code> 内的链接。</p>
<h1 id="colly"><a class="markdownIt-Anchor" href="#colly"></a> Colly</h1>
<p><code>Colly</code> 是一个用 Go 编写的框架，专门用于构建网络爬虫。项目主页：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://go-colly.org/%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%88%B0">https://go-colly.org/，也可以到</a> Go 官方网站去查询文档：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://pkg.go.dev/github.com/gocolly/colly%E3%80%82">https://pkg.go.dev/github.com/gocolly/colly。</a></p>
<p><code>Colly</code> 核心组件由三部分组成：</p>
<ul>
<li><strong>Collector</strong>：<code>Collector</code> 对象用于设置爬虫的配置，可以为每个 <code>Collector</code> 设置不同的配置，如域名过滤、请求间隔、超时时间等。</li>
<li><strong>Callbacks</strong>：<code>colly</code> 允许注册多种回调函数，用于爬取过程中的执行特定操作。回调函数包括 <code>OnHTML</code>、<code>OnRequest</code>、<code>OnResponse</code>、<code>OnError</code>、<code>OnScraped</code> 等。</li>
<li><strong>Elements</strong>：使用 <code>HTMLElement</code> 结构来操作和查询 HTML 文档，支持链式调用。</li>
</ul>
<p>下面是个简单示例，展示设置 Collector，注册回调，并开始一个网页爬取任务：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/gocolly/colly/v2"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 初始化 Collector</span>
	c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span>
		colly<span class="token punctuation">.</span><span class="token function">AllowedDomains</span><span class="token punctuation">(</span><span class="token string">"example.com"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		colly<span class="token punctuation">.</span><span class="token function">Async</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>

	<span class="token comment">// 设置爬取规则</span>
	c<span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>colly<span class="token punctuation">.</span>LimitRule<span class="token punctuation">&#123;</span>
		DomainGlob<span class="token punctuation">:</span>  <span class="token string">"*.example.com"</span><span class="token punctuation">,</span>
		Parallelism<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
		RandomDelay<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 发起请求阶段，打印信息</span>
	c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span>
		<span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Visiting"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 页面载入完成阶段</span>
	c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">"a[href]"</span><span class="token punctuation">,</span>
		<span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			link <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Found link:"</span><span class="token punctuation">,</span> link<span class="token punctuation">)</span>
			e<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 启动爬虫</span>
	c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">"http://example.com"</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 异步模式启用时，需要等待所有异步任务完成</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="创建-collector"><a class="markdownIt-Anchor" href="#创建-collector"></a> 创建 Collector</h2>
<p><code>Collector</code> 是核心组件，负责管理网络请求、处理响应和执行抓取任务。每个 <code>Collector</code> 实例都可以被视为一个独立的爬虫。使用 <code>NewCollector</code> 函数创建一个新的 <code>Collector</code> 实例，可以接收一系列的配置选项：</p>
<ul>
<li><strong>AllowedDomains</strong>：限制爬虫只能抓取指定域名下的页面。</li>
<li><strong>Async</strong>：允许爬虫异步执行请求，开启后可以同时发起多个请求。</li>
<li><strong>UserAgent</strong>：设置 HTTP 请求头的 User-Agent 字段。</li>
<li><strong>MaxDepth</strong>：设置爬取的最大深度。</li>
<li><strong>CacheDir</strong>：设置本地缓存目录，访问过的页面将缓存到本地，再次访问时直接从缓存读取。</li>
<li><strong>IgnoreRobotsTxt</strong>：忽略 robots.txt 规则的限制。</li>
</ul>
<p>此外还有 <code>DisallowedDomains</code>、<code>MaxBodySize</code>、<code>DetectCharset</code> 等有用的参数，可以通过查询 <code>Collector</code> 结构体来获得具体用途，再根据实际情况设置：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/gocolly/colly/v2"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 初始化 Collector</span>
	c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span>
		colly<span class="token punctuation">.</span><span class="token function">AllowedDomains</span><span class="token punctuation">(</span><span class="token string">"example.com"</span><span class="token punctuation">,</span> <span class="token string">"www.example.com"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		colly<span class="token punctuation">.</span><span class="token function">Async</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		colly<span class="token punctuation">.</span><span class="token function">UserAgent</span><span class="token punctuation">(</span><span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64)"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		colly<span class="token punctuation">.</span><span class="token function">MaxDepth</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		colly<span class="token punctuation">.</span><span class="token function">CacheDir</span><span class="token punctuation">(</span><span class="token string">"./colly_cache"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		colly<span class="token punctuation">.</span><span class="token function">IgnoreRobotsTxt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>

	<span class="token comment">// 启动爬虫</span>
	c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">"http://example.com"</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="速率限制"><a class="markdownIt-Anchor" href="#速率限制"></a> 速率限制</h2>
<p>请求速度限制不在创建 <code>Collector</code> 时配置，而是通过 <code>Limit</code> 方法接受传入 <code>*colly.LimitRule</code> 类型的参数来设置。<code>LimitRule</code> 能配置的参数有 4 个：</p>
<ul>
<li>
<p><strong>DomainGlob</strong>：定义规则适用的域名，可以使用通配符。例如 <code>&quot;*.example.com&quot;</code> 匹配 <code>example.com</code> 及其所有子域。</p>
</li>
<li>
<p><strong>Delay</strong>：设置请求之间的延迟时间。例如 <code>Delay: 1 * time.Second</code> 表示每个请求之间至少要间隔 1 秒。</p>
</li>
<li>
<p><strong>RandomDelay</strong>：为每个请求加上随机的延迟。比如 <code>RandomDelay: 5 * time.Second</code> 表示基础延迟加上一个 0 到 5 秒的随机延迟。</p>
</li>
<li>
<p><strong>Parallelism</strong>：设置并发请求数量。例如 <code>Parallelism: 2</code> 表示只会同时发起两个并行的请求。</p>
</li>
</ul>
<p>每次只能传递一个 <code>&amp;colly.LimitRule</code> 实例给 <code>Limit</code> 方法。如果需要针对不同域名设置不同的限制，可以多次调用 <code>Limit</code> 方法，每次传入不同的 <code>LimitRule</code> 实例：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/gocolly/colly/v2"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 初始化 Collector，不带参数</span>
	c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 配置限制规则</span>
	c<span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>colly<span class="token punctuation">.</span>LimitRule<span class="token punctuation">&#123;</span>
		DomainGlob<span class="token punctuation">:</span>  <span class="token string">"*.example.com"</span><span class="token punctuation">,</span>
		Delay<span class="token punctuation">:</span>       <span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
		RandomDelay<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
		Parallelism<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	c<span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>colly<span class="token punctuation">.</span>LimitRule<span class="token punctuation">&#123;</span>
		DomainGlob<span class="token punctuation">:</span>  <span class="token string">"*.anotherdomain.com"</span><span class="token punctuation">,</span>
		Delay<span class="token punctuation">:</span>       <span class="token number">500</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">,</span>
		RandomDelay<span class="token punctuation">:</span> <span class="token number">500</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">,</span>
		Parallelism<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 启动爬虫，访问不同网站自动应用对应速率规则</span>
	c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">"http://example.com"</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">"http://anotherdomain.com"</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="分阶段处理"><a class="markdownIt-Anchor" href="#分阶段处理"></a> 分阶段处理</h2>
<p>在爬虫请求的各个阶段，如请求开始、页面加载完成、发生错误时，可以使用回调函数（Callbacks）来处理各种事件，进行详细控制和处理。</p>
<p>常用的回调函数有：</p>
<ul>
<li><strong>OnRequest</strong>：当请求即将被发送时触发，可以用来修改请求，比如添加头部、设置 Cookies 等。</li>
<li><strong>OnResponse</strong>：当收到响应时触发，可以用来直接处理原始的字节数据，例如保存响应内容。</li>
<li><strong>OnError</strong>：当请求发生错误时触发，比如网络错误或返回状态码 4xx/5xx。</li>
<li><strong>OnHTML</strong>：当响应内容被解析为 HTML 并匹配 CSS 选择器时触发，用于提取特定数据。每次匹配都会创建一个 <code>HTMLElement</code> 实例，并调用一次回调函数。</li>
<li><strong>OnXML</strong>：类似于 <code>OnHTML</code>，用于处理 XML 格式的数据。</li>
<li><strong>OnScraped</strong>: 当请求处理完毕后触发，可以用来执行清理或统计。</li>
</ul>
<p>回调函数可以多次添加，每个添加的回调函数都会按照它们被添加的顺序在事件触发时执行，在复杂的爬虫流程中需要确保逻辑上的正确性：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/gocolly/colly/v2"</span>
	<span class="token string">"os"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 初始化 Collector</span>
	c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span>
		colly<span class="token punctuation">.</span><span class="token function">AllowedDomains</span><span class="token punctuation">(</span><span class="token string">"example.com"</span><span class="token punctuation">,</span> <span class="token string">"www.example.com"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>

	<span class="token comment">// 请求发送前</span>
	c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Visiting"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		r<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Cookie"</span><span class="token punctuation">,</span> <span class="token string">"name=value"</span><span class="token punctuation">)</span> <span class="token comment">// 设置 Cookie</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 收到响应时</span>
	c<span class="token punctuation">.</span><span class="token function">OnResponse</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Visited"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">)</span>
		os<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span><span class="token string">"filename.html"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Body<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 特定于数据获取的响应处理</span>
	c<span class="token punctuation">.</span><span class="token function">OnResponse</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"http://example.com"</span> <span class="token punctuation">&#123;</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Response body:\n"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 发生错误时</span>
	c<span class="token punctuation">.</span><span class="token function">OnError</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Request URL:"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">,</span> <span class="token string">"failed with status:"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Error:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 符合选择器时</span>
	c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">"a[href]"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		link <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Attr</span><span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Link found:"</span><span class="token punctuation">,</span> link<span class="token punctuation">)</span>
		e<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 符合 XPath 路径时</span>
	c<span class="token punctuation">.</span><span class="token function">OnXML</span><span class="token punctuation">(</span><span class="token string">"//item"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>XMLElement<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"XML Element found:"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Text<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 完成请求时</span>
	c<span class="token punctuation">.</span><span class="token function">OnScraped</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Finished visiting"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 启动爬虫</span>
	c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">"http://example.com"</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="css-选择器"><a class="markdownIt-Anchor" href="#css-选择器"></a> CSS 选择器</h2>
<p>这里简单介绍一下 <code>Colly</code> 使用的 CSS 选择器，可以使用浏览器的开发者工具来测试 CSS 选择器是否能正确选择想要的元素。CSS 选择器有多种类型，每种都有其特定的用途：</p>
<ul>
<li><strong>元素选择器</strong>：直接使用元素（标签）名，如 <code>div</code>、<code>p</code>、<code>a</code>。</li>
<li><strong>类选择器</strong>：用点（<code>.</code>）后跟类名来选择具有特定类（class）的元素，如 <code>.my-class</code>、<code>div.container</code></li>
<li><strong>ID 选择器</strong>：用井号（<code>#</code>）后跟 ID 来选择具有特定 ID 的元素，如 <code>#my-id</code>。</li>
<li><strong>属性选择器</strong>：通过属性和属性值来选择元素，如 <code>[type=&quot;text&quot;]</code>。</li>
<li><strong>子选择器</strong>：用大于号（<code>&gt;</code>）分隔两个选择器，选择直接作为第一个元素子元素的第二个元素，只有当一个元素直接嵌套在另一个元素内时，才会被选中。如 <code>ul &gt; li</code>。</li>
<li><strong>后代选择器</strong>：用空格分隔两个选择器，选择位于第一个元素内部的第二个元素，用于选择所有在指定元素之下的元素，无论嵌套了多少层都会被选中。如 <code>div span</code>。</li>
<li><strong>相邻兄弟选择器</strong>：用加号（<code>+</code>）连接两个选择器，选择紧接在第一个元素之后的第二个元素，如 <code>h1 + p</code>。</li>
<li><strong>通用兄弟选择器</strong>：用波浪号（<code>~</code>）连接两个选择器，选择所有在第一个元素之后的第二个元素的实例，如 <code>h1 ~ p</code>。</li>
</ul>
<p>此外如果一个元素有多个类，可以连续使用多个类选择器，如 <code>div.first.second</code>，将匹配 <code>&lt;div class=&quot;first second&quot;&gt;</code>。</p>
<h2 id="发送请求"><a class="markdownIt-Anchor" href="#发送请求"></a> 发送请求</h2>
<p><code>Colly</code> 中提供了和 <code>net</code> 包中类似的请求方法，这里只介绍常用的几种：</p>
<ul>
<li><strong>Visit</strong>：发送 GET 请求最基本方法，只需要提供要访问的 URL 地址。</li>
<li><strong>Post</strong>：发送 POST 请求需要包含发送的数据，适用于需要提交表单或上传数据的场景。</li>
<li><strong>PostRaw</strong>：数据以原始格式（如 JSON、XML 等）发送 POST 请求，数据类型为字节切片。</li>
<li><strong>Request</strong>：<code>Request</code> 方法允许完全自定义  HTTP 请求，包括方法类型、头部、体和其他选项。</li>
</ul>
<p>下面是对这几种发送请求方法的演示：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/gocolly/colly"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"strings"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	c<span class="token punctuation">.</span><span class="token function">OnResponse</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Visited"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">)</span>
		<span class="token comment">// 输出响应体</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Response body:"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Visiting"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">"http://www.httpbin.org/get"</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"http://www.httpbin.org/post"</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"key"</span><span class="token punctuation">:</span> <span class="token string">"value"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">PostRaw</span><span class="token punctuation">(</span><span class="token string">"http://www.httpbin.org/post"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`&#123;"username": "user", "password": "pass"&#125;`</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span><span class="token string">"PUT"</span><span class="token punctuation">,</span> <span class="token string">"http://www.httpbin.org/put"</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span><span class="token string">"request body"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>Header<span class="token punctuation">&#123;</span><span class="token string">"Content-Type"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"text/plain"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="并发请求"><a class="markdownIt-Anchor" href="#并发请求"></a> 并发请求</h2>
<p>使用爬虫框架的优势之一就是可以并发处理链接。相关的配置项前面都已经讲解过，下面用代码示例展示用法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/gocolly/colly"</span>
	<span class="token string">"log"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 创建 Collector 实例时开启异步模式</span>
	c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span>
		colly<span class="token punctuation">.</span><span class="token function">Async</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>

	<span class="token comment">// 限制并发数为 2，每个请求间隔 5 秒，便于观察</span>
	err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Limit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>colly<span class="token punctuation">.</span>LimitRule<span class="token punctuation">&#123;</span>
		DomainGlob<span class="token punctuation">:</span>  <span class="token string">"*"</span><span class="token punctuation">,</span>                     <span class="token comment">// 对所有域名有效</span>
		Parallelism<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>                       <span class="token comment">// 并发数</span>
		Delay<span class="token punctuation">:</span>       <span class="token number">5000</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">,</span> <span class="token comment">// 每次请求的延迟</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 设置请求的回调</span>
	c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Visiting"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 设置响应的回调</span>
	c<span class="token punctuation">.</span><span class="token function">OnResponse</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Visited"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 列表中的多个链接</span>
	urls <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span>
		<span class="token string">"http://httpbin.org/ip"</span><span class="token punctuation">,</span>
		<span class="token string">"http://httpbin.org/user-agent"</span><span class="token punctuation">,</span>
		<span class="token string">"http://httpbin.org/headers"</span><span class="token punctuation">,</span>
		<span class="token string">"http://httpbin.org/cookies"</span><span class="token punctuation">,</span>
		<span class="token string">"http://httpbin.org/get"</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 遍历地址并访问</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> url <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">&#123;</span>
		c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 等待所有异步任务完成</span>
	c<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于要访问的链接数有 <code>5</code> 个，但是并发设置为 <code>2</code>，因此从运行结果可以看到：异步中 <code>c.OnRequest</code> 是没有等待时间的，一开始就输出 5 条 <code>Visiting</code> 信息。然后每 5 秒钟，每次最多两条分 3 次输出 <code>Visited</code> 信息，说明程序确实是以设置的并发数来发送请求的。</p>
<h2 id="管理-cookie"><a class="markdownIt-Anchor" href="#管理-cookie"></a> 管理 Cookie</h2>
<p>默认情况下，当访问一个网站时服务器返回的所有 Cookies 都会被自动存储在 Cookie jar 中，并在随后的请求中自动发送给相同的域。</p>
<p>如果需要手动设置或修改请求的 Cookies，可以通过修改 <code>colly.Request</code> 对象来添加或修改 Cookies：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/gocolly/colly/v2"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 在请求中直接设置 Cookie</span>
	c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		r<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Cookie"</span><span class="token punctuation">,</span> <span class="token string">"key1=value1; key2=value2"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	c<span class="token punctuation">.</span><span class="token function">OnResponse</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Response body:"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">"http://www.httpbin.org/cookies"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也可以使用 <code>SetCookies</code> 方法为特定的 URL 设置 Cookies。这种方法比直接设置请求头更加直观和易用：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/gocolly/colly/v2"</span>
	<span class="token string">"net/http"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 在请求中直接设置 Cookie</span>
	c<span class="token punctuation">.</span><span class="token function">SetCookies</span><span class="token punctuation">(</span><span class="token string">"http://www.httpbin.org"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>http<span class="token punctuation">.</span>Cookie<span class="token punctuation">&#123;</span>
		<span class="token punctuation">&#123;</span>
			Name<span class="token punctuation">:</span>   <span class="token string">"login"</span><span class="token punctuation">,</span>
			Value<span class="token punctuation">:</span>  <span class="token string">"true"</span><span class="token punctuation">,</span>
			Path<span class="token punctuation">:</span>   <span class="token string">"/"</span><span class="token punctuation">,</span>
			Domain<span class="token punctuation">:</span> <span class="token string">"www.httpbin.org"</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	c<span class="token punctuation">.</span><span class="token function">OnResponse</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Response body:"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">"http://www.httpbin.org/cookies"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果需要获取当前存储的 Cookies，可以使用 <code>Cookies</code> 方法获取指定 URL 的 Cookies：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/gocolly/colly/v2"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">"https://www.google.com"</span><span class="token punctuation">)</span>

	<span class="token comment">// 打印获取的 Cookies</span>
	cookies <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Cookies</span><span class="token punctuation">(</span><span class="token string">"https://www.google.com"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Cookies:"</span><span class="token punctuation">,</span> cookies<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> cookie <span class="token operator">:=</span> <span class="token keyword">range</span> cookies <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>cookie<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">"="</span><span class="token punctuation">,</span> cookie<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="模块化设计"><a class="markdownIt-Anchor" href="#模块化设计"></a> 模块化设计</h2>
<p>切分复杂爬虫任务为更小的子任务可以提高代码的可读性和可维护性，例如登录、数据抓取、数据解析、数据存储等，每个都可以是独立的任务。</p>
<p>这里是一个简化的代码结构示例：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"log"</span>

	<span class="token string">"github.com/gocolly/colly"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 登录并获取会话</span>
	session<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">login</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"Login failed:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 使用会话抓取数据</span>
	data<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">fetchData</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> session<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"Fetch data failed:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 解析数据</span>
	parsedData<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">parseData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"Parse data failed:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 存储数据</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">storeData</span><span class="token punctuation">(</span>parsedData<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"Store data failed:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">login</span><span class="token punctuation">(</span>c <span class="token operator">*</span>colly<span class="token punctuation">.</span>Collector<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Session<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 登录逻辑</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">fetchData</span><span class="token punctuation">(</span>c <span class="token operator">*</span>colly<span class="token punctuation">.</span>Collector<span class="token punctuation">,</span> session <span class="token operator">*</span>Session<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 数据抓取逻辑</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">parseData</span><span class="token punctuation">(</span>rawData <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>ParsedData<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 数据解析逻辑</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">storeData</span><span class="token punctuation">(</span>data <span class="token operator">*</span>ParsedData<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 数据存储逻辑</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="爬虫实例"><a class="markdownIt-Anchor" href="#爬虫实例"></a> 爬虫实例</h1>
<p>下面以获取网络上公开数据和内部数据为例子，练习爬虫使用。</p>
<h2 id="公开数据"><a class="markdownIt-Anchor" href="#公开数据"></a> 公开数据</h2>
<p>公开数据指网络上可以通过浏览器直接获取的内容，这里以爬取中央气象台网站热门城市实况天气数据为例。</p>
<p>首先在浏览器打开对应网站地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="http://www.nmc.cn/publish/forecast.html%EF%BC%8C%E5%9C%B0%E5%9D%80%E4%B8%BA">http://www.nmc.cn/publish/forecast.html，地址为</a> <code>http</code> 协议，无需登录，直接可以看到（GET 方法）热门城市天气数据。</p>
<p>确定需要的数据为：城市、天气描述、最高气温和最低气温，类型都为字符串。然后通过 <code>F12</code> 打开开发者工具，在「元素」标签页，定位到一条城市数据 <code>div</code> 标签，右键选择「复制 selector」，获取到 <code>goquery</code> 能识别的 CSS 选择器：<code>body &gt; div.container &gt; div:nth-child(3) &gt; div.hb &gt; div &gt; div.col-xs-4 &gt; a.city</code>，下面则是分析每个数据值获取的选择器：</p>
<ul>
<li>城市：<code>div.row div.col-xs-3:first-of-type</code></li>
<li>天气描述：<code>div.row div.col-xs-3.wdesc</code></li>
<li>最高气温：<code>div.row div.col-xs-3.text-right span.hight</code></li>
<li>最低气温：<code>div.row div.col-xs-3.text-right span.low</code></li>
</ul>
<p>最后则是将数据保存到自定义结构体，并打印出来。整体代码如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/gocolly/colly"</span>
<span class="token punctuation">)</span>

<span class="token comment">// WeatherData 用来储存需要的天气数据</span>
<span class="token keyword">type</span> WeatherData <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	City        <span class="token builtin">string</span>
	Description <span class="token builtin">string</span>
	HighTemp    <span class="token builtin">string</span>
	LowTemp     <span class="token builtin">string</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 创建一个新的 Collector 实例，保险起见添加一个 UA</span>
	c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span>
		colly<span class="token punctuation">.</span><span class="token function">UserAgent</span><span class="token punctuation">(</span><span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64)"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
	<span class="token comment">// 创建切片来存储所有城市的天气数据</span>
	<span class="token keyword">var</span> weatherList <span class="token punctuation">[</span><span class="token punctuation">]</span>WeatherData

	<span class="token comment">// 定义一个 HTML 元素处理器，由于会匹配运行很多次，因此每次都会将城市信息插入到结果切片中</span>
	c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">"body > div.container > div:nth-child(3) > div.hb > div > div.col-xs-4 > a.city"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// 获取城市名称</span>
		city <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">ChildText</span><span class="token punctuation">(</span><span class="token string">"div.row div.col-xs-3:first-of-type"</span><span class="token punctuation">)</span>
		<span class="token comment">// 获取天气描述</span>
		weatherDescription <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">ChildText</span><span class="token punctuation">(</span><span class="token string">"div.row div.col-xs-3.wdesc"</span><span class="token punctuation">)</span>
		<span class="token comment">// 获取最高温度</span>
		highTemp <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">ChildText</span><span class="token punctuation">(</span><span class="token string">"div.row div.col-xs-3.text-right span.hight"</span><span class="token punctuation">)</span>
		<span class="token comment">// 获取最低温度</span>
		lowTemp <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">ChildText</span><span class="token punctuation">(</span><span class="token string">"div.row div.col-xs-3.text-right span.low"</span><span class="token punctuation">)</span>

		<span class="token comment">// 创建 WeatherData 实例并填充数据</span>
		weather <span class="token operator">:=</span> WeatherData<span class="token punctuation">&#123;</span>
			City<span class="token punctuation">:</span>        city<span class="token punctuation">,</span>
			Description<span class="token punctuation">:</span> weatherDescription<span class="token punctuation">,</span>
			HighTemp<span class="token punctuation">:</span>    highTemp<span class="token punctuation">,</span>
			LowTemp<span class="token punctuation">:</span>     lowTemp<span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span>

		<span class="token comment">// 将天气数据添加到切片中</span>
		weatherList <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>weatherList<span class="token punctuation">,</span> weather<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 启动爬虫，正常要处理错误，这里为了减少行数忽略</span>
	c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">"http://www.nmc.cn/publish/forecast.html"</span><span class="token punctuation">)</span>

	<span class="token comment">// 打印所有城市的天气数据</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> w <span class="token operator">:=</span> <span class="token keyword">range</span> weatherList <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"城市: %s, 天气: %s, 最高温度: %s, 最低温度: %s\n"</span><span class="token punctuation">,</span> w<span class="token punctuation">.</span>City<span class="token punctuation">,</span> w<span class="token punctuation">.</span>Description<span class="token punctuation">,</span> w<span class="token punctuation">.</span>HighTemp<span class="token punctuation">,</span> w<span class="token punctuation">.</span>LowTemp<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="内部数据"><a class="markdownIt-Anchor" href="#内部数据"></a> 内部数据</h2>
<p>内部数据指在网络上不公开，需要经过权限验证才能获得的数据。这里以获取漫画网站个人收藏漫画数据为例。</p>
<p>首先打开漫画网站：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.mangaupdates.com/%EF%BC%8C%E7%99%BB%E5%BD%95%E5%B8%90%E5%8F%B7%E5%8A%9F%E8%83%BD%E7%9B%B4%E6%8E%A5%E5%9C%A8%E9%A6%96%E9%A1%B5%EF%BC%8C%E4%B8%94%E7%99%BB%E5%BD%95%E4%B8%8D%E9%9C%80%E8%A6%81%E9%AA%8C%E8%AF%81%E7%A0%81%E5%92%8C%E4%B8%A4%E6%AD%A5%E9%AA%8C%E8%AF%81%EF%BC%8C%E5%BE%88%E9%80%82%E5%90%88%E7%BB%83%E6%89%8B%E3%80%82%E6%8C%89">https://www.mangaupdates.com/，登录帐号功能直接在首页，且登录不需要验证码和两步验证，很适合练手。按</a> <code>F12</code> 打开开发者工具，然后登录帐号，获取请求信息：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">curl <span class="token string">'https://www.mangaupdates.com/login.html'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'authority: www.mangaupdates.com'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'accept-language: zh-CN,zh;q=0.9,en;q=0.8,en-US;q=0.7,en-GB;q=0.6,ru;q=0.5'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'cache-control: max-age=0'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'content-type: application/x-www-form-urlencoded'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'cookie: _ga=GA1.1.1984616270.1716011061; secure_session=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0eXBlIjoiZ3Vlc3QiLCJzZXNzaW9uIjoiN2UxZDdlZjctMDdhMS00ZDYxLTlkYTItMTg5YmZkNmNjNTM2IiwidGltZV9jcmVhdGVkIjoxNzIwNzc5MDM1fQ.J4fezqCvOMrQKWIbgYQip8yaoga6Fggqo_yYgCZUs2c; _ga_2TTLL90FSE=GS1.1.1720777034.2.1.1720779034.0.0.0'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'origin: https://www.mangaupdates.com'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'referer: https://www.mangaupdates.com/mylist.html?list=complete'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'sec-ch-ua: "Google Chrome";v="113", "Chromium";v="113", "Not-A.Brand";v="24"'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'sec-ch-ua-mobile: ?0'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'sec-ch-ua-platform: "Windows"'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'sec-fetch-dest: document'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'sec-fetch-mode: navigate'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'sec-fetch-site: same-origin'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'sec-fetch-user: ?1'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'upgrade-insecure-requests: 1'</span> \
  <span class="token operator">-</span><span class="token constant">H</span> <span class="token string">'user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36'</span> \
  <span class="token operator">--</span>data<span class="token operator">-</span>raw <span class="token string">'act=login&amp;username=assassing&amp;password=%258Kv*Q%3Ca'</span> \
  <span class="token operator">--</span>compressed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上面可以得知关键信息：</p>
<ul>
<li>请求方法：<code>POST</code></li>
<li>请求地址：<code>https://www.mangaupdates.com/login.html</code></li>
<li>数据类型：表单格式 <code>application/x-www-form-urlencoded</code></li>
<li>数据内容：<code>act=login&amp;username=assassing&amp;password=%258Kv*Q%3Ca</code> 其中密码部分对特殊符号做了转码处理。 发送时不用手动转换，只用发送字符串，框架自己会处理。</li>
</ul>
<p>登录成功后，响应代码 <code>302</code> 跳转到主页，并在 <code>Set-Cookie</code> 字段返回会话 Cookie。</p>
<p>下一步是获取用户收藏漫画列表。继续开着开发工具，访问地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.mangaupdates.com/mylist.html?list=complete%EF%BC%8C%E6%9F%A5%E7%9C%8B%E8%AF%B7%E6%B1%82%E5%A4%B4%E4%BF%A1%E6%81%AF%EF%BC%9A">https://www.mangaupdates.com/mylist.html?list=complete，查看请求头信息：</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token string">'https://www.mangaupdates.com/mylist.html?list=complete'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'authority: www.mangaupdates.com'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'accept-language: zh-CN,zh;q=0.9,en;q=0.8,en-US;q=0.7,en-GB;q=0.6,ru;q=0.5'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'cache-control: max-age=0'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'cookie: _ga=GA1.1.1984616270.1716011061; _ga_2TTLL90FSE=GS1.1.1720777034.2.1.1720779034.0.0.0; secure_session=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzZXNzaW9uIjoiNTI0OThmMWMtMmYxMy00YjBjLWE3MzctYjk3NWViNmJiZjRlIiwidGltZV9jcmVhdGVkIjoxNzIwNzc5MDQxfQ.q3r1g-ZkgMn548Ubw_PM_rXw2vEO73qcxd41V2Ug624'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'referer: https://www.mangaupdates.com/mylist.html?list=complete'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'sec-ch-ua: "Google Chrome";v="113", "Chromium";v="113", "Not-A.Brand";v="24"'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'sec-ch-ua-mobile: ?0'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'sec-ch-ua-platform: "Windows"'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'sec-fetch-dest: document'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'sec-fetch-mode: navigate'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'sec-fetch-site: same-origin'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'sec-fetch-user: ?1'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'upgrade-insecure-requests: 1'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--compressed</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里仅仅是个简单的 GET 请求，只是带上了服务器返回来的 Cookie。</p>
<p>最后是分析 HTML 页面，得到 <code>OnHTML</code> 中匹配的选择器为 <code>div.row.no-gutters.lrow</code>，也就是一条数据的区块，每条数据要取的字段为漫画名（<code>div.p-1.col.text.align-self-center a u</code>）和添加时间（<code>div.p-1.col-md-3.col-4.text-center.text</code>）。</p>
<p>下面是完整代码：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/gocolly/colly"</span>
	<span class="token string">"log"</span>
<span class="token punctuation">)</span>

<span class="token comment">// UserData 用来储存用户数据</span>
<span class="token keyword">type</span> UserData <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	Name <span class="token builtin">string</span>
	Date <span class="token builtin">string</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 定义用户登录信息</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	username <span class="token operator">=</span> <span class="token string">"assassing"</span>
	password <span class="token operator">=</span> <span class="token string">"%8Kv*Q&lt;a"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 创建一个新的 Collector 实例，添加真实 UA</span>
	c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span>
		colly<span class="token punctuation">.</span><span class="token function">UserAgent</span><span class="token punctuation">(</span><span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
	<span class="token comment">// 创建切片存储用户数据</span>
	<span class="token keyword">var</span> userDataList <span class="token punctuation">[</span><span class="token punctuation">]</span>UserData

	<span class="token comment">// 调试响应</span>
	c<span class="token punctuation">.</span><span class="token function">OnResponse</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">//fmt.Println(r.Headers)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Cookies:"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">Cookies</span><span class="token punctuation">(</span><span class="token string">"https://www.mangaupdates.com"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 调试请求</span>
	c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Headers<span class="token punctuation">)</span>
		<span class="token comment">//fmt.Println("Cookies:", c.Cookies("https://www.mangaupdates.com"))</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 统一的错误处理</span>
	c<span class="token punctuation">.</span><span class="token function">OnError</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Request URL: %v failed with response: %v, Error: %v"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">,</span> r<span class="token punctuation">.</span>StatusCode<span class="token punctuation">,</span> err<span class="token punctuation">)</span>

		<span class="token comment">// 检查状态码 500 时重试</span>
		<span class="token keyword">if</span> r<span class="token punctuation">.</span>StatusCode <span class="token operator">>=</span> <span class="token number">500</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Retrying"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">)</span>
			r<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Retry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 发送 Post 请求登录帐号</span>
	c<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"https://www.mangaupdates.com/login.html"</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"act"</span><span class="token punctuation">:</span> <span class="token string">"login"</span><span class="token punctuation">,</span> <span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">:</span> password<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 定义一个 HTML 元素处理器</span>
	c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">"div.row.no-gutters.lrow"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// 获取漫画名</span>
		name <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">ChildText</span><span class="token punctuation">(</span><span class="token string">"div.p-1.col.text.align-self-center a u"</span><span class="token punctuation">)</span>
		<span class="token comment">// 获取添加时间</span>
		date <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">ChildText</span><span class="token punctuation">(</span><span class="token string">"div.p-1.col-md-3.col-4.text-center.text"</span><span class="token punctuation">)</span>

		<span class="token comment">// 创建 UserData 实例并填充数据</span>
		userData <span class="token operator">:=</span> UserData<span class="token punctuation">&#123;</span>
			Name<span class="token punctuation">:</span> name<span class="token punctuation">,</span>
			Date<span class="token punctuation">:</span> date<span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span>

		<span class="token comment">// 将数据添加到切片中</span>
		userDataList <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>userDataList<span class="token punctuation">,</span> userData<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token comment">// 无需再管 Cookie，登录后的 Cookie 被直接用于后续发送请求</span>
	c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">"https://www.mangaupdates.com/mylist.html?list=complete"</span><span class="token punctuation">)</span>

	<span class="token comment">// 打印所有信息数据</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> userDataList <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"漫画: %s, 添加时间: %s\n"</span><span class="token punctuation">,</span> d<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> d<span class="token punctuation">.</span>Date<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>干杯！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="../images/wechatpay.png" alt="assassing 微信">
        <span>微信</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>assassing
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://blog.x2b.net/2826025175/" title="Go 语言写网络爬虫">https://blog.x2b.net/2826025175/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="followme">
  <span>欢迎订阅</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="../atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="../2960221700/" rel="prev" title="Go 语言中时间处理">
                  <i class="fa fa-chevron-left"></i> Go 语言中时间处理
                </a>
            </div>
            <div class="post-nav-item">
                <a href="../2666287436/" rel="next" title="Go 语言创建网络工具">
                  Go 语言创建网络工具 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2020 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">assassing</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">403k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">22:24</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener external nofollow noreferrer" target="_blank">NexT.Gemini</a> on Kubernetes
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/hxz393" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener external nofollow noreferrer" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://lib.baomitu.com/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://lib.baomitu.com/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://lib.baomitu.com/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://lib.baomitu.com/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="../js/comments.js"></script><script src="../js/utils.js"></script><script src="../js/motion.js"></script><script src="../js/next-boot.js"></script><script src="../js/pjax.js"></script>

  <script src="https://lib.baomitu.com/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="../js/third-party/search/local-search.js"></script>




  <script src="../js/third-party/pace.js"></script>

  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.4/katex.min.css" integrity="sha256-gMRN4/6qeELzO1wbFa8qQLU8kfuF2dnAPiUoI0ATjx8=" crossorigin="anonymous">
  <script class="next-config" data-name="katex" type="application/json">{"copy_tex_js":{"url":"https://lib.baomitu.com/KaTeX/0.16.4/contrib/copy-tex.min.js","integrity":"sha256-Us54+rSGDSTvIhKKUs4kygE2ipA0RXpWWh0/zLqw3bs="}}</script>
  <script src="../js/third-party/math/katex.js"></script>


  <script src="https://lib.baomitu.com/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":5000,"priority":true,"url":"https://blog.x2b.net/2826025175/"}</script>
  <script src="../js/third-party/quicklink.js"></script>
<link rel="stylesheet" href="https://lib.baomitu.com/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"hxz393","repo":"x2b.net-deploy","client_id":"26664aab919326dcf7e7","client_secret":"40882da22b7a77aea4a985ccd95a9363cfb7ba9a","admin_user":"hxz393","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"d41d8cd98f00b204e9800998ecf8427e"}</script>
<script src="../js/third-party/comments/gitalk.js"></script>

</body>
</html>
